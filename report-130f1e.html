<!doctype html>
<html>
<head>
<title>src/journal/journald-server.c</title>
<style type="text/css">
 body { color:#000000; background-color:#ffffff }
 body { font-family:Helvetica, sans-serif; font-size:10pt }
 h1 { font-size:14pt }
 .code { border-collapse:collapse; width:100%; }
 .code { font-family: "Monospace", monospace; font-size:10pt }
 .code { line-height: 1.2em }
 .comment { color: green; font-style: oblique }
 .keyword { color: blue }
 .string_literal { color: red }
 .directive { color: darkmagenta }
 .expansion { display: none; }
 .macro:hover .expansion { display: block; border: 2px solid #FF0000; padding: 2px; background-color:#FFF0F0; font-weight: normal;   -webkit-border-radius:5px;  -webkit-box-shadow:1px 1px 7px #000; position: absolute; top: -1em; left:10em; z-index: 1 } 
 .macro { color: darkmagenta; background-color:LemonChiffon; position: relative }
 .num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
 .num { text-align:right; font-size:8pt }
 .num { color:#444444 }
 .line { padding-left: 1ex; border-left: 3px solid #ccc }
 .line { white-space: pre }
 .msg { -webkit-box-shadow:1px 1px 7px #000 }
 .msg { -webkit-border-radius:5px }
 .msg { font-family:Helvetica, sans-serif; font-size:8pt }
 .msg { float:left }
 .msg { padding:0.25em 1ex 0.25em 1ex }
 .msg { margin-top:10px; margin-bottom:10px }
 .msg { font-weight:bold }
 .msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
 .msgT { padding:0x; spacing:0x }
 .msgEvent { background-color:#fff8b4; color:#000000 }
 .msgControl { background-color:#bbbbbb; color:#000000 }
 .mrange { background-color:#dfddf3 }
 .mrange { border-bottom:1px solid #6F9DBE }
 .PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
 .PathIndex { -webkit-border-radius:8px }
 .PathIndexEvent { background-color:#bfba87 }
 .PathIndexControl { background-color:#8c8c8c }
 .PathNav a { text-decoration:none; font-size: larger }
 .CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
 .CodeRemovalHint { background-color:#de1010 }
 .CodeRemovalHint { border-bottom:1px solid #6F9DBE }
 table.simpletable {
   padding: 5px;
   font-size:12pt;
   margin:20px;
   border-collapse: collapse; border-spacing: 0px;
 }
 td.rowname {
   text-align:right; font-weight:bold; color:#444444;
   padding-right:2ex; }
</style>
</head>
<body>
<!-- BUGDESC Value stored to 'fds' is never read -->

<!-- BUGTYPE Dead assignment -->

<!-- BUGCATEGORY Dead store -->

<!-- BUGFILE /home/runner/systemd/src/journal/journald-server.c -->

<!-- FILENAME journald-server.c -->

<!-- FUNCTIONNAME server_init -->

<!-- BUGLINE 1845 -->

<!-- BUGCOLUMN 17 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>journal/journald-server.c</td></tr>
<tr><td class="rowname">Location:</td><td><a href="#EndPath">line 1845, column 17</a></td></tr>
<tr><td class="rowname">Description:</td><td>Value stored to 'fds' is never read</td></tr>
</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<table class="code">
<tr><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/***</span></td></tr>
<tr><td class="num" id="LN2">2</td><td class="line">  <span class='comment'>This file is part of systemd.</span></td></tr>
<tr><td class="num" id="LN3">3</td><td class="line"> </td></tr>
<tr><td class="num" id="LN4">4</td><td class="line">  <span class='comment'>Copyright 2011 Lennart Poettering</span></td></tr>
<tr><td class="num" id="LN5">5</td><td class="line"> </td></tr>
<tr><td class="num" id="LN6">6</td><td class="line">  <span class='comment'>systemd is free software; you can redistribute it and/or modify it</span></td></tr>
<tr><td class="num" id="LN7">7</td><td class="line">  <span class='comment'>under the terms of the GNU Lesser General Public License as published by</span></td></tr>
<tr><td class="num" id="LN8">8</td><td class="line">  <span class='comment'>the Free Software Foundation; either version 2.1 of the License, or</span></td></tr>
<tr><td class="num" id="LN9">9</td><td class="line">  <span class='comment'>(at your option) any later version.</span></td></tr>
<tr><td class="num" id="LN10">10</td><td class="line"> </td></tr>
<tr><td class="num" id="LN11">11</td><td class="line">  <span class='comment'>systemd is distributed in the hope that it will be useful, but</span></td></tr>
<tr><td class="num" id="LN12">12</td><td class="line">  <span class='comment'>WITHOUT ANY WARRANTY; without even the implied warranty of</span></td></tr>
<tr><td class="num" id="LN13">13</td><td class="line">  <span class='comment'>MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span></td></tr>
<tr><td class="num" id="LN14">14</td><td class="line">  <span class='comment'>Lesser General Public License for more details.</span></td></tr>
<tr><td class="num" id="LN15">15</td><td class="line"> </td></tr>
<tr><td class="num" id="LN16">16</td><td class="line">  <span class='comment'>You should have received a copy of the GNU Lesser General Public License</span></td></tr>
<tr><td class="num" id="LN17">17</td><td class="line">  <span class='comment'>along with systemd; If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></td></tr>
<tr><td class="num" id="LN18">18</td><td class="line"><span class='comment'>***/</span></td></tr>
<tr><td class="num" id="LN19">19</td><td class="line"> </td></tr>
<tr><td class="num" id="LN20">20</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_SELINUX<span class='expansion'>1</span></span></span></td></tr>
<tr><td class="num" id="LN21">21</td><td class="line"><span class='directive'>#include &lt;selinux/selinux.h&gt;</span></td></tr>
<tr><td class="num" id="LN22">22</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr><td class="num" id="LN23">23</td><td class="line"><span class='directive'>#include &lt;sys/ioctl.h&gt;</span></td></tr>
<tr><td class="num" id="LN24">24</td><td class="line"><span class='directive'>#include &lt;sys/mman.h&gt;</span></td></tr>
<tr><td class="num" id="LN25">25</td><td class="line"><span class='directive'>#include &lt;sys/signalfd.h&gt;</span></td></tr>
<tr><td class="num" id="LN26">26</td><td class="line"><span class='directive'>#include &lt;sys/statvfs.h&gt;</span></td></tr>
<tr><td class="num" id="LN27">27</td><td class="line"><span class='directive'>#include &lt;<span class='macro'>linux<span class='expansion'>1</span></span>/sockios.h&gt;</span></td></tr>
<tr><td class="num" id="LN28">28</td><td class="line"> </td></tr>
<tr><td class="num" id="LN29">29</td><td class="line"><span class='directive'>#include "libudev.h"</span></td></tr>
<tr><td class="num" id="LN30">30</td><td class="line"><span class='directive'>#include "sd-daemon.h"</span></td></tr>
<tr><td class="num" id="LN31">31</td><td class="line"><span class='directive'>#include "sd-journal.h"</span></td></tr>
<tr><td class="num" id="LN32">32</td><td class="line"><span class='directive'>#include "sd-messages.h"</span></td></tr>
<tr><td class="num" id="LN33">33</td><td class="line"> </td></tr>
<tr><td class="num" id="LN34">34</td><td class="line"><span class='directive'>#include "acl-util.h"</span></td></tr>
<tr><td class="num" id="LN35">35</td><td class="line"><span class='directive'>#include "alloc-util.h"</span></td></tr>
<tr><td class="num" id="LN36">36</td><td class="line"><span class='directive'>#include "audit-util.h"</span></td></tr>
<tr><td class="num" id="LN37">37</td><td class="line"><span class='directive'>#include "cgroup-util.h"</span></td></tr>
<tr><td class="num" id="LN38">38</td><td class="line"><span class='directive'>#include "conf-parser.h"</span></td></tr>
<tr><td class="num" id="LN39">39</td><td class="line"><span class='directive'>#include "dirent-util.h"</span></td></tr>
<tr><td class="num" id="LN40">40</td><td class="line"><span class='directive'>#include "extract-word.h"</span></td></tr>
<tr><td class="num" id="LN41">41</td><td class="line"><span class='directive'>#include "fd-util.h"</span></td></tr>
<tr><td class="num" id="LN42">42</td><td class="line"><span class='directive'>#include "fileio.h"</span></td></tr>
<tr><td class="num" id="LN43">43</td><td class="line"><span class='directive'>#include "formats-util.h"</span></td></tr>
<tr><td class="num" id="LN44">44</td><td class="line"><span class='directive'>#include "fs-util.h"</span></td></tr>
<tr><td class="num" id="LN45">45</td><td class="line"><span class='directive'>#include "hashmap.h"</span></td></tr>
<tr><td class="num" id="LN46">46</td><td class="line"><span class='directive'>#include "hostname-util.h"</span></td></tr>
<tr><td class="num" id="LN47">47</td><td class="line"><span class='directive'>#include "io-util.h"</span></td></tr>
<tr><td class="num" id="LN48">48</td><td class="line"><span class='directive'>#include "journal-authenticate.h"</span></td></tr>
<tr><td class="num" id="LN49">49</td><td class="line"><span class='directive'>#include "journal-file.h"</span></td></tr>
<tr><td class="num" id="LN50">50</td><td class="line"><span class='directive'>#include "journal-internal.h"</span></td></tr>
<tr><td class="num" id="LN51">51</td><td class="line"><span class='directive'>#include "journal-vacuum.h"</span></td></tr>
<tr><td class="num" id="LN52">52</td><td class="line"><span class='directive'>#include "journald-audit.h"</span></td></tr>
<tr><td class="num" id="LN53">53</td><td class="line"><span class='directive'>#include "journald-kmsg.h"</span></td></tr>
<tr><td class="num" id="LN54">54</td><td class="line"><span class='directive'>#include "journald-native.h"</span></td></tr>
<tr><td class="num" id="LN55">55</td><td class="line"><span class='directive'>#include "journald-rate-limit.h"</span></td></tr>
<tr><td class="num" id="LN56">56</td><td class="line"><span class='directive'>#include "journald-server.h"</span></td></tr>
<tr><td class="num" id="LN57">57</td><td class="line"><span class='directive'>#include "journald-stream.h"</span></td></tr>
<tr><td class="num" id="LN58">58</td><td class="line"><span class='directive'>#include "journald-syslog.h"</span></td></tr>
<tr><td class="num" id="LN59">59</td><td class="line"><span class='directive'>#include "missing.h"</span></td></tr>
<tr><td class="num" id="LN60">60</td><td class="line"><span class='directive'>#include "mkdir.h"</span></td></tr>
<tr><td class="num" id="LN61">61</td><td class="line"><span class='directive'>#include "parse-util.h"</span></td></tr>
<tr><td class="num" id="LN62">62</td><td class="line"><span class='directive'>#include "proc-cmdline.h"</span></td></tr>
<tr><td class="num" id="LN63">63</td><td class="line"><span class='directive'>#include "process-util.h"</span></td></tr>
<tr><td class="num" id="LN64">64</td><td class="line"><span class='directive'>#include "rm-rf.h"</span></td></tr>
<tr><td class="num" id="LN65">65</td><td class="line"><span class='directive'>#include "selinux-util.h"</span></td></tr>
<tr><td class="num" id="LN66">66</td><td class="line"><span class='directive'>#include "signal-util.h"</span></td></tr>
<tr><td class="num" id="LN67">67</td><td class="line"><span class='directive'>#include "socket-util.h"</span></td></tr>
<tr><td class="num" id="LN68">68</td><td class="line"><span class='directive'>#include "stdio-util.h"</span></td></tr>
<tr><td class="num" id="LN69">69</td><td class="line"><span class='directive'>#include "string-table.h"</span></td></tr>
<tr><td class="num" id="LN70">70</td><td class="line"><span class='directive'>#include "string-util.h"</span></td></tr>
<tr><td class="num" id="LN71">71</td><td class="line"><span class='directive'>#include "user-util.h"</span></td></tr>
<tr><td class="num" id="LN72">72</td><td class="line"><span class='directive'>#include "log.h"</span></td></tr>
<tr><td class="num" id="LN73">73</td><td class="line"> </td></tr>
<tr><td class="num" id="LN74">74</td><td class="line"><span class='directive'>#define <span class='macro'>USER_JOURNALS_MAX<span class='expansion'>1024</span></span> 1024</span></td></tr>
<tr><td class="num" id="LN75">75</td><td class="line"> </td></tr>
<tr><td class="num" id="LN76">76</td><td class="line"><span class='directive'>#define <span class='macro'>DEFAULT_SYNC_INTERVAL_USEC<span class='expansion'>(5*((usec_t) (60ULL*((usec_t) 1000000ULL))))</span></span> (5*<span class='macro'>USEC_PER_MINUTE<span class='expansion'>((usec_t) (60ULL*((usec_t) 1000000ULL)))</span></span>)</span></td></tr>
<tr><td class="num" id="LN77">77</td><td class="line"><span class='directive'>#define <span class='macro'>DEFAULT_RATE_LIMIT_INTERVAL<span class='expansion'>(30*((usec_t) 1000000ULL))</span></span> (30*<span class='macro'>USEC_PER_SEC<span class='expansion'>((usec_t) 1000000ULL)</span></span>)</span></td></tr>
<tr><td class="num" id="LN78">78</td><td class="line"><span class='directive'>#define <span class='macro'>DEFAULT_RATE_LIMIT_BURST<span class='expansion'>1000</span></span> 1000</span></td></tr>
<tr><td class="num" id="LN79">79</td><td class="line"><span class='directive'>#define <span class='macro'>DEFAULT_MAX_FILE_USEC<span class='expansion'>((usec_t) (2629800ULL*((usec_t) 1000000ULL)))</span></span> <span class='macro'>USEC_PER_MONTH<span class='expansion'>((usec_t) (2629800ULL*((usec_t) 1000000ULL)))</span></span></span></td></tr>
<tr><td class="num" id="LN80">80</td><td class="line"> </td></tr>
<tr><td class="num" id="LN81">81</td><td class="line"><span class='directive'>#define <span class='macro'>RECHECK_SPACE_USEC<span class='expansion'>(30*((usec_t) 1000000ULL))</span></span> (30*<span class='macro'>USEC_PER_SEC<span class='expansion'>((usec_t) 1000000ULL)</span></span>)</span></td></tr>
<tr><td class="num" id="LN82">82</td><td class="line"> </td></tr>
<tr><td class="num" id="LN83">83</td><td class="line"><span class='directive'>#define <span class='macro'>NOTIFY_SNDBUF_SIZE<span class='expansion'>(8*1024*1024)</span></span> (8*1024*1024)</span></td></tr>
<tr><td class="num" id="LN84">84</td><td class="line"> </td></tr>
<tr><td class="num" id="LN85">85</td><td class="line"><span class='comment'>/* The period to insert between posting changes for coalescing */</span></td></tr>
<tr><td class="num" id="LN86">86</td><td class="line"><span class='directive'>#define <span class='macro'>POST_CHANGE_TIMER_INTERVAL_USEC<span class='expansion'>(250*((usec_t) 1000ULL))</span></span> (250*<span class='macro'>USEC_PER_MSEC<span class='expansion'>((usec_t) 1000ULL)</span></span>)</span></td></tr>
<tr><td class="num" id="LN87">87</td><td class="line"> </td></tr>
<tr><td class="num" id="LN88">88</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> determine_space_for(</td></tr>
<tr><td class="num" id="LN89">89</td><td class="line">                Server *s,</td></tr>
<tr><td class="num" id="LN90">90</td><td class="line">                JournalMetrics *metrics,</td></tr>
<tr><td class="num" id="LN91">91</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>char</span> *path,</td></tr>
<tr><td class="num" id="LN92">92</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>char</span> *name,</td></tr>
<tr><td class="num" id="LN93">93</td><td class="line">                <span class='macro'>bool<span class='expansion'>_Bool</span></span> verbose,</td></tr>
<tr><td class="num" id="LN94">94</td><td class="line">                <span class='macro'>bool<span class='expansion'>_Bool</span></span> patch_min_use,</td></tr>
<tr><td class="num" id="LN95">95</td><td class="line">                uint64_t *available,</td></tr>
<tr><td class="num" id="LN96">96</td><td class="line">                uint64_t *limit) {</td></tr>
<tr><td class="num" id="LN97">97</td><td class="line"> </td></tr>
<tr><td class="num" id="LN98">98</td><td class="line">        uint64_t sum = 0, ss_avail, avail;</td></tr>
<tr><td class="num" id="LN99">99</td><td class="line">        <span class='macro'>_cleanup_closedir_<span class='expansion'>__attribute__((cleanup(closedirp)))</span></span> DIR *d = <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>;</td></tr>
<tr><td class="num" id="LN100">100</td><td class="line">        <span class='keyword'>struct</span> dirent *de;</td></tr>
<tr><td class="num" id="LN101">101</td><td class="line">        <span class='keyword'>struct</span> statvfs ss;</td></tr>
<tr><td class="num" id="LN102">102</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span> *p;</td></tr>
<tr><td class="num" id="LN103">103</td><td class="line">        usec_t ts;</td></tr>
<tr><td class="num" id="LN104">104</td><td class="line"> </td></tr>
<tr><td class="num" id="LN105">105</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 105, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN106">106</td><td class="line">        <span class='macro'>assert(metrics)<span class='expansion'>do { if ((__builtin_expect(!!(!(metrics)),0))) log_assert_failed<br>("metrics", "src/journal/journald-server.c", 106, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN107">107</td><td class="line">        <span class='macro'>assert(path)<span class='expansion'>do { if ((__builtin_expect(!!(!(path)),0))) log_assert_failed<br>("path", "src/journal/journald-server.c", 107, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN108">108</td><td class="line">        <span class='macro'>assert(name)<span class='expansion'>do { if ((__builtin_expect(!!(!(name)),0))) log_assert_failed<br>("name", "src/journal/journald-server.c", 108, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN109">109</td><td class="line"> </td></tr>
<tr><td class="num" id="LN110">110</td><td class="line">        ts = now(<span class='macro'>CLOCK_MONOTONIC<span class='expansion'>1</span></span>);</td></tr>
<tr><td class="num" id="LN111">111</td><td class="line"> </td></tr>
<tr><td class="num" id="LN112">112</td><td class="line">        <span class='keyword'>if</span> (!verbose &amp;&amp; s-&gt;cached_space_timestamp + <span class='macro'>RECHECK_SPACE_USEC<span class='expansion'>(30*((usec_t) 1000000ULL))</span></span> &gt; ts) {</td></tr>
<tr><td class="num" id="LN113">113</td><td class="line"> </td></tr>
<tr><td class="num" id="LN114">114</td><td class="line">                <span class='keyword'>if</span> (available)</td></tr>
<tr><td class="num" id="LN115">115</td><td class="line">                        *available = s-&gt;cached_space_available;</td></tr>
<tr><td class="num" id="LN116">116</td><td class="line">                <span class='keyword'>if</span> (limit)</td></tr>
<tr><td class="num" id="LN117">117</td><td class="line">                        *limit = s-&gt;cached_space_limit;</td></tr>
<tr><td class="num" id="LN118">118</td><td class="line"> </td></tr>
<tr><td class="num" id="LN119">119</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN120">120</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN121">121</td><td class="line"> </td></tr>
<tr><td class="num" id="LN122">122</td><td class="line">        p = <span class='macro'>strjoina(path, SERVER_MACHINE_ID(s))<span class='expansion'>({ const char *_appendees_[] = { path, ((s)-&gt;machine_id_field<br> + strlen("_MACHINE_ID=")) }; char *_d_, *_p_; int _len_ = 0;<br> unsigned _i_; for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _len_ += strlen<br>(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca (_len_ + 1);<br> for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr(<br> !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN123">123</td><td class="line">        d = opendir(p);</td></tr>
<tr><td class="num" id="LN124">124</td><td class="line">        <span class='keyword'>if</span> (!d)</td></tr>
<tr><td class="num" id="LN125">125</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_full_errno(errno == ENOENT ? LOG_DEBUG : LOG_ERR, errno, <span class='string_literal'>"Failed to open %s: %m"</span>, p)<span class='expansion'>({ int _level = ((*__errno_location ()) == 2 ? 7 : 3), _e = (<br>(*__errno_location ())); (log_get_max_level() &gt;= ((_level)<br> &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 125, __func__, "Failed to open %s: %m", p) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN126">126</td><td class="line"> </td></tr>
<tr><td class="num" id="LN127">127</td><td class="line">        <span class='keyword'>if</span> (fstatvfs(dirfd(d), &amp;ss) &lt; 0)</td></tr>
<tr><td class="num" id="LN128">128</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_error_errno(errno, <span class='string_literal'>"Failed to fstatvfs(%s): %m"</span>, p)<span class='expansion'>({ int _level = (3), _e = ((*__errno_location ())); (log_get_max_level<br>() &gt;= ((_level) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 128, __func__, "Failed to fstatvfs(%s): %m", p) : -abs(_e);<br> })</span></span>;</td></tr>
<tr><td class="num" id="LN129">129</td><td class="line"> </td></tr>
<tr><td class="num" id="LN130">130</td><td class="line">        <span class='macro'>FOREACH_DIRENT_ALL(de, d, <span class='keyword'>break</span>)<span class='expansion'>for ((*__errno_location ()) = 0, de = readdir(d);; (*__errno_location<br> ()) = 0, de = readdir(d)) if (!de) { if ((*__errno_location (<br>)) &gt; 0) { break; } break; } else</span></span> {</td></tr>
<tr><td class="num" id="LN131">131</td><td class="line">                <span class='keyword'>struct</span> stat st;</td></tr>
<tr><td class="num" id="LN132">132</td><td class="line"> </td></tr>
<tr><td class="num" id="LN133">133</td><td class="line">                <span class='keyword'>if</span> (!endswith(de-&gt;d_name, <span class='string_literal'>".journal"</span>) &amp;&amp;</td></tr>
<tr><td class="num" id="LN134">134</td><td class="line">                    !endswith(de-&gt;d_name, <span class='string_literal'>".journal~"</span>))</td></tr>
<tr><td class="num" id="LN135">135</td><td class="line">                        <span class='keyword'>continue</span>;</td></tr>
<tr><td class="num" id="LN136">136</td><td class="line"> </td></tr>
<tr><td class="num" id="LN137">137</td><td class="line">                <span class='keyword'>if</span> (fstatat(dirfd(d), de-&gt;d_name, &amp;st, <span class='macro'>AT_SYMLINK_NOFOLLOW<span class='expansion'>0x100</span></span>) &lt; 0) {</td></tr>
<tr><td class="num" id="LN138">138</td><td class="line">                        <span class='macro'>log_debug_errno(errno, <span class='string_literal'>"Failed to stat %s/%s, ignoring: %m"</span>, p, de-&gt;d_name)<span class='expansion'>({ int _level = (7), _e = ((*__errno_location ())); (log_get_max_level<br>() &gt;= ((_level) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 138, __func__, "Failed to stat %s/%s, ignoring: %m", p, de-&gt;<br>d_name) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN139">139</td><td class="line">                        <span class='keyword'>continue</span>;</td></tr>
<tr><td class="num" id="LN140">140</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN141">141</td><td class="line"> </td></tr>
<tr><td class="num" id="LN142">142</td><td class="line">                <span class='keyword'>if</span> (!<span class='macro'>S_ISREG(st.st_mode)<span class='expansion'>((((st.st_mode)) &amp; 0170000) == (0100000))</span></span>)</td></tr>
<tr><td class="num" id="LN143">143</td><td class="line">                        <span class='keyword'>continue</span>;</td></tr>
<tr><td class="num" id="LN144">144</td><td class="line"> </td></tr>
<tr><td class="num" id="LN145">145</td><td class="line">                sum += (uint64_t) st.st_blocks * 512UL;</td></tr>
<tr><td class="num" id="LN146">146</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN147">147</td><td class="line"> </td></tr>
<tr><td class="num" id="LN148">148</td><td class="line">        <span class='comment'>/* If requested, then let's bump the min_use limit to the</span></td></tr>
<tr><td class="num" id="LN149">149</td><td class="line">         <span class='comment'>* current usage on disk. We do this when starting up and</span></td></tr>
<tr><td class="num" id="LN150">150</td><td class="line">         <span class='comment'>* first opening the journal files. This way sudden spikes in</span></td></tr>
<tr><td class="num" id="LN151">151</td><td class="line">         <span class='comment'>* disk usage will not cause journald to vacuum files without</span></td></tr>
<tr><td class="num" id="LN152">152</td><td class="line">         <span class='comment'>* bounds. Note that this means that only a restart of</span></td></tr>
<tr><td class="num" id="LN153">153</td><td class="line">         <span class='comment'>* journald will make it reset this value. */</span></td></tr>
<tr><td class="num" id="LN154">154</td><td class="line"> </td></tr>
<tr><td class="num" id="LN155">155</td><td class="line">        <span class='keyword'>if</span> (patch_min_use)</td></tr>
<tr><td class="num" id="LN156">156</td><td class="line">                metrics-&gt;min_use = <span class='macro'>MAX(metrics-&gt;min_use, sum)<span class='expansion'>__extension__ ({ const typeof((metrics-&gt;min_use)) __unique_prefix_A16<br> = ((metrics-&gt;min_use)); const typeof((sum)) __unique_prefix_B17<br> = ((sum)); __unique_prefix_A16 &gt; __unique_prefix_B17 ? __unique_prefix_A16<br> : __unique_prefix_B17; })</span></span>;</td></tr>
<tr><td class="num" id="LN157">157</td><td class="line"> </td></tr>
<tr><td class="num" id="LN158">158</td><td class="line">        ss_avail = ss.f_bsize * ss.f_bavail;</td></tr>
<tr><td class="num" id="LN159">159</td><td class="line">        avail = <span class='macro'>LESS_BY(ss_avail, metrics-&gt;keep_free)<span class='expansion'>__extension__ ({ const typeof((ss_avail)) __unique_prefix_A18<br> = ((ss_avail)); const typeof((metrics-&gt;keep_free)) __unique_prefix_B19<br> = ((metrics-&gt;keep_free)); __unique_prefix_A18 &gt; __unique_prefix_B19<br> ? __unique_prefix_A18 - __unique_prefix_B19 : 0; })</span></span>;</td></tr>
<tr><td class="num" id="LN160">160</td><td class="line"> </td></tr>
<tr><td class="num" id="LN161">161</td><td class="line">        s-&gt;cached_space_limit = <span class='macro'>MIN(MAX(sum + avail, metrics-&gt;min_use), metrics-&gt;max_use)<span class='expansion'>__extension__ ({ const typeof((__extension__ ({ const typeof(<br>(sum + avail)) __unique_prefix_A20 = ((sum + avail)); const typeof<br>((metrics-&gt;min_use)) __unique_prefix_B21 = ((metrics-&gt;min_use<br>)); __unique_prefix_A20 &gt; __unique_prefix_B21 ? __unique_prefix_A20<br> : __unique_prefix_B21; }))) __unique_prefix_A22 = ((__extension__<br> ({ const typeof((sum + avail)) __unique_prefix_A20 = ((sum +<br> avail)); const typeof((metrics-&gt;min_use)) __unique_prefix_B21<br> = ((metrics-&gt;min_use)); __unique_prefix_A20 &gt; __unique_prefix_B21<br> ? __unique_prefix_A20 : __unique_prefix_B21; }))); const typeof<br>((metrics-&gt;max_use)) __unique_prefix_B23 = ((metrics-&gt;max_use<br>)); __unique_prefix_A22 &lt; __unique_prefix_B23 ? __unique_prefix_A22<br> : __unique_prefix_B23; })</span></span>;</td></tr>
<tr><td class="num" id="LN162">162</td><td class="line">        s-&gt;cached_space_available = <span class='macro'>LESS_BY(s-&gt;cached_space_limit, sum)<span class='expansion'>__extension__ ({ const typeof((s-&gt;cached_space_limit)) __unique_prefix_A24<br> = ((s-&gt;cached_space_limit)); const typeof((sum)) __unique_prefix_B25<br> = ((sum)); __unique_prefix_A24 &gt; __unique_prefix_B25 ? __unique_prefix_A24<br> - __unique_prefix_B25 : 0; })</span></span>;</td></tr>
<tr><td class="num" id="LN163">163</td><td class="line">        s-&gt;cached_space_timestamp = ts;</td></tr>
<tr><td class="num" id="LN164">164</td><td class="line"> </td></tr>
<tr><td class="num" id="LN165">165</td><td class="line">        <span class='keyword'>if</span> (verbose) {</td></tr>
<tr><td class="num" id="LN166">166</td><td class="line">                <span class='keyword'>char</span>    fb1[<span class='macro'>FORMAT_BYTES_MAX<span class='expansion'>8</span></span>], fb2[<span class='macro'>FORMAT_BYTES_MAX<span class='expansion'>8</span></span>], fb3[<span class='macro'>FORMAT_BYTES_MAX<span class='expansion'>8</span></span>],</td></tr>
<tr><td class="num" id="LN167">167</td><td class="line">                        fb4[<span class='macro'>FORMAT_BYTES_MAX<span class='expansion'>8</span></span>], fb5[<span class='macro'>FORMAT_BYTES_MAX<span class='expansion'>8</span></span>], fb6[<span class='macro'>FORMAT_BYTES_MAX<span class='expansion'>8</span></span>];</td></tr>
<tr><td class="num" id="LN168">168</td><td class="line">                format_bytes(fb1, <span class='keyword'>sizeof</span>(fb1), sum);</td></tr>
<tr><td class="num" id="LN169">169</td><td class="line">                format_bytes(fb2, <span class='keyword'>sizeof</span>(fb2), metrics-&gt;max_use);</td></tr>
<tr><td class="num" id="LN170">170</td><td class="line">                format_bytes(fb3, <span class='keyword'>sizeof</span>(fb3), metrics-&gt;keep_free);</td></tr>
<tr><td class="num" id="LN171">171</td><td class="line">                format_bytes(fb4, <span class='keyword'>sizeof</span>(fb4), ss_avail);</td></tr>
<tr><td class="num" id="LN172">172</td><td class="line">                format_bytes(fb5, <span class='keyword'>sizeof</span>(fb5), s-&gt;cached_space_limit);</td></tr>
<tr><td class="num" id="LN173">173</td><td class="line">                format_bytes(fb6, <span class='keyword'>sizeof</span>(fb6), s-&gt;cached_space_available);</td></tr>
<tr><td class="num" id="LN174">174</td><td class="line"> </td></tr>
<tr><td class="num" id="LN175">175</td><td class="line">                server_driver_message(s, <span class='macro'>SD_MESSAGE_JOURNAL_USAGE<span class='expansion'>((const sd_id128_t) { .bytes = { 0xec, 0x38, 0x7f, 0x57, 0x7b<br>, 0x84, 0x4b, 0x8f, 0xa9, 0x48, 0xf3, 0x3c, 0xad, 0x9a, 0x75,<br> 0xe6 }})</span></span>,</td></tr>
<tr><td class="num" id="LN176">176</td><td class="line">                                      <span class='macro'>LOG_MESSAGE(<span class='string_literal'>"%s (%s) is %s, max %s, %s free."</span>,<span class='expansion'>"MESSAGE=" "%s (%s) is %s, max %s, %s free.", name, path, fb1<br>, fb5, fb6</span></span></td></tr>
<tr><td class="num" id="LN177">177</td><td class="line">                                                  <span class='macro'>name, path, fb1, fb5, fb6)<span class='expansion'>"MESSAGE=" "%s (%s) is %s, max %s, %s free.", name, path, fb1<br>, fb5, fb6</span></span>,</td></tr>
<tr><td class="num" id="LN178">178</td><td class="line">                                      <span class='string_literal'>"JOURNAL_NAME=%s"</span>, name,</td></tr>
<tr><td class="num" id="LN179">179</td><td class="line">                                      <span class='string_literal'>"JOURNAL_PATH=%s"</span>, path,</td></tr>
<tr><td class="num" id="LN180">180</td><td class="line">                                      <span class='string_literal'>"CURRENT_USE=%"</span><span class='macro'>PRIu64<span class='expansion'>"l" "u"</span></span>, sum,</td></tr>
<tr><td class="num" id="LN181">181</td><td class="line">                                      <span class='string_literal'>"CURRENT_USE_PRETTY=%s"</span>, fb1,</td></tr>
<tr><td class="num" id="LN182">182</td><td class="line">                                      <span class='string_literal'>"MAX_USE=%"</span><span class='macro'>PRIu64<span class='expansion'>"l" "u"</span></span>, metrics-&gt;max_use,</td></tr>
<tr><td class="num" id="LN183">183</td><td class="line">                                      <span class='string_literal'>"MAX_USE_PRETTY=%s"</span>, fb2,</td></tr>
<tr><td class="num" id="LN184">184</td><td class="line">                                      <span class='string_literal'>"DISK_KEEP_FREE=%"</span><span class='macro'>PRIu64<span class='expansion'>"l" "u"</span></span>, metrics-&gt;keep_free,</td></tr>
<tr><td class="num" id="LN185">185</td><td class="line">                                      <span class='string_literal'>"DISK_KEEP_FREE_PRETTY=%s"</span>, fb3,</td></tr>
<tr><td class="num" id="LN186">186</td><td class="line">                                      <span class='string_literal'>"DISK_AVAILABLE=%"</span><span class='macro'>PRIu64<span class='expansion'>"l" "u"</span></span>, ss_avail,</td></tr>
<tr><td class="num" id="LN187">187</td><td class="line">                                      <span class='string_literal'>"DISK_AVAILABLE_PRETTY=%s"</span>, fb4,</td></tr>
<tr><td class="num" id="LN188">188</td><td class="line">                                      <span class='string_literal'>"LIMIT=%"</span><span class='macro'>PRIu64<span class='expansion'>"l" "u"</span></span>, s-&gt;cached_space_limit,</td></tr>
<tr><td class="num" id="LN189">189</td><td class="line">                                      <span class='string_literal'>"LIMIT_PRETTY=%s"</span>, fb5,</td></tr>
<tr><td class="num" id="LN190">190</td><td class="line">                                      <span class='string_literal'>"AVAILABLE=%"</span><span class='macro'>PRIu64<span class='expansion'>"l" "u"</span></span>, s-&gt;cached_space_available,</td></tr>
<tr><td class="num" id="LN191">191</td><td class="line">                                      <span class='string_literal'>"AVAILABLE_PRETTY=%s"</span>, fb6,</td></tr>
<tr><td class="num" id="LN192">192</td><td class="line">                                      <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>);</td></tr>
<tr><td class="num" id="LN193">193</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN194">194</td><td class="line"> </td></tr>
<tr><td class="num" id="LN195">195</td><td class="line">        <span class='keyword'>if</span> (available)</td></tr>
<tr><td class="num" id="LN196">196</td><td class="line">                *available = s-&gt;cached_space_available;</td></tr>
<tr><td class="num" id="LN197">197</td><td class="line">        <span class='keyword'>if</span> (limit)</td></tr>
<tr><td class="num" id="LN198">198</td><td class="line">                *limit = s-&gt;cached_space_limit;</td></tr>
<tr><td class="num" id="LN199">199</td><td class="line"> </td></tr>
<tr><td class="num" id="LN200">200</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr><td class="num" id="LN201">201</td><td class="line">}</td></tr>
<tr><td class="num" id="LN202">202</td><td class="line"> </td></tr>
<tr><td class="num" id="LN203">203</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> determine_space(Server *s, <span class='macro'>bool<span class='expansion'>_Bool</span></span> verbose, <span class='macro'>bool<span class='expansion'>_Bool</span></span> patch_min_use, uint64_t *available, uint64_t *limit) {</td></tr>
<tr><td class="num" id="LN204">204</td><td class="line">        JournalMetrics *metrics;</td></tr>
<tr><td class="num" id="LN205">205</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span> *path, *name;</td></tr>
<tr><td class="num" id="LN206">206</td><td class="line"> </td></tr>
<tr><td class="num" id="LN207">207</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 207, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN208">208</td><td class="line"> </td></tr>
<tr><td class="num" id="LN209">209</td><td class="line">        <span class='keyword'>if</span> (s-&gt;system_journal) {</td></tr>
<tr><td class="num" id="LN210">210</td><td class="line">                path = <span class='string_literal'>"/var/log/journal/"</span>;</td></tr>
<tr><td class="num" id="LN211">211</td><td class="line">                metrics = &amp;s-&gt;system_metrics;</td></tr>
<tr><td class="num" id="LN212">212</td><td class="line">                name = <span class='string_literal'>"System journal"</span>;</td></tr>
<tr><td class="num" id="LN213">213</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr><td class="num" id="LN214">214</td><td class="line">                path = <span class='string_literal'>"/run/log/journal/"</span>;</td></tr>
<tr><td class="num" id="LN215">215</td><td class="line">                metrics = &amp;s-&gt;runtime_metrics;</td></tr>
<tr><td class="num" id="LN216">216</td><td class="line">                name = <span class='string_literal'>"Runtime journal"</span>;</td></tr>
<tr><td class="num" id="LN217">217</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN218">218</td><td class="line"> </td></tr>
<tr><td class="num" id="LN219">219</td><td class="line">        <span class='keyword'>return</span> determine_space_for(s, metrics, path, name, verbose, patch_min_use, available, limit);</td></tr>
<tr><td class="num" id="LN220">220</td><td class="line">}</td></tr>
<tr><td class="num" id="LN221">221</td><td class="line"> </td></tr>
<tr><td class="num" id="LN222">222</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> server_add_acls(JournalFile *f, uid_t uid) {</td></tr>
<tr><td class="num" id="LN223">223</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_ACL<span class='expansion'>1</span></span></span></td></tr>
<tr><td class="num" id="LN224">224</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN225">225</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr><td class="num" id="LN226">226</td><td class="line">        <span class='macro'>assert(f)<span class='expansion'>do { if ((__builtin_expect(!!(!(f)),0))) log_assert_failed("f"<br>, "src/journal/journald-server.c", 226, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN227">227</td><td class="line"> </td></tr>
<tr><td class="num" id="LN228">228</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_ACL<span class='expansion'>1</span></span></span></td></tr>
<tr><td class="num" id="LN229">229</td><td class="line">        <span class='keyword'>if</span> (uid &lt;= <span class='macro'>SYSTEM_UID_MAX<span class='expansion'>999</span></span>)</td></tr>
<tr><td class="num" id="LN230">230</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr><td class="num" id="LN231">231</td><td class="line"> </td></tr>
<tr><td class="num" id="LN232">232</td><td class="line">        r = add_acls_for_user(f-&gt;fd, uid);</td></tr>
<tr><td class="num" id="LN233">233</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN234">234</td><td class="line">                <span class='macro'>log_warning_errno(r, <span class='string_literal'>"Failed to set ACL on %s, ignoring: %m"</span>, f-&gt;path)<span class='expansion'>({ int _level = (4), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 234, __func__, "Failed to set ACL on %s, ignoring: %m", f-&gt;<br>path) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN235">235</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr><td class="num" id="LN236">236</td><td class="line">}</td></tr>
<tr><td class="num" id="LN237">237</td><td class="line"> </td></tr>
<tr><td class="num" id="LN238">238</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> open_journal(</td></tr>
<tr><td class="num" id="LN239">239</td><td class="line">                Server *s,</td></tr>
<tr><td class="num" id="LN240">240</td><td class="line">                <span class='macro'>bool<span class='expansion'>_Bool</span></span> reliably,</td></tr>
<tr><td class="num" id="LN241">241</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>char</span> *fname,</td></tr>
<tr><td class="num" id="LN242">242</td><td class="line">                <span class='keyword'>int</span> flags,</td></tr>
<tr><td class="num" id="LN243">243</td><td class="line">                <span class='macro'>bool<span class='expansion'>_Bool</span></span> seal,</td></tr>
<tr><td class="num" id="LN244">244</td><td class="line">                JournalMetrics *metrics,</td></tr>
<tr><td class="num" id="LN245">245</td><td class="line">                JournalFile **ret) {</td></tr>
<tr><td class="num" id="LN246">246</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN247">247</td><td class="line">        JournalFile *f;</td></tr>
<tr><td class="num" id="LN248">248</td><td class="line"> </td></tr>
<tr><td class="num" id="LN249">249</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 249, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN250">250</td><td class="line">        <span class='macro'>assert(fname)<span class='expansion'>do { if ((__builtin_expect(!!(!(fname)),0))) log_assert_failed<br>("fname", "src/journal/journald-server.c", 250, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN251">251</td><td class="line">        <span class='macro'>assert(ret)<span class='expansion'>do { if ((__builtin_expect(!!(!(ret)),0))) log_assert_failed(<br>"ret", "src/journal/journald-server.c", 251, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN252">252</td><td class="line"> </td></tr>
<tr><td class="num" id="LN253">253</td><td class="line">        <span class='keyword'>if</span> (reliably)</td></tr>
<tr><td class="num" id="LN254">254</td><td class="line">                r = journal_file_open_reliably(fname, flags, 0640, s-&gt;compress, seal, metrics, s-&gt;mmap, s-&gt;deferred_closes, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, &amp;f);</td></tr>
<tr><td class="num" id="LN255">255</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr><td class="num" id="LN256">256</td><td class="line">                r = journal_file_open(fname, flags, 0640, s-&gt;compress, seal, metrics, s-&gt;mmap, s-&gt;deferred_closes, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, &amp;f);</td></tr>
<tr><td class="num" id="LN257">257</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN258">258</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN259">259</td><td class="line"> </td></tr>
<tr><td class="num" id="LN260">260</td><td class="line">        r = journal_file_enable_post_change_timer(f, s-&gt;event, <span class='macro'>POST_CHANGE_TIMER_INTERVAL_USEC<span class='expansion'>(250*((usec_t) 1000ULL))</span></span>);</td></tr>
<tr><td class="num" id="LN261">261</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0) {</td></tr>
<tr><td class="num" id="LN262">262</td><td class="line">                (<span class='keyword'>void</span>) journal_file_close(f);</td></tr>
<tr><td class="num" id="LN263">263</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN264">264</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN265">265</td><td class="line"> </td></tr>
<tr><td class="num" id="LN266">266</td><td class="line">        *ret = f;</td></tr>
<tr><td class="num" id="LN267">267</td><td class="line">        <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN268">268</td><td class="line">}</td></tr>
<tr><td class="num" id="LN269">269</td><td class="line"> </td></tr>
<tr><td class="num" id="LN270">270</td><td class="line"><span class='keyword'>static</span> JournalFile* find_journal(Server *s, uid_t uid) {</td></tr>
<tr><td class="num" id="LN271">271</td><td class="line">        <span class='macro'>_cleanup_free_<span class='expansion'>__attribute__((cleanup(freep)))</span></span> <span class='keyword'>char</span> *p = <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>;</td></tr>
<tr><td class="num" id="LN272">272</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN273">273</td><td class="line">        JournalFile *f;</td></tr>
<tr><td class="num" id="LN274">274</td><td class="line">        sd_id128_t machine;</td></tr>
<tr><td class="num" id="LN275">275</td><td class="line"> </td></tr>
<tr><td class="num" id="LN276">276</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 276, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN277">277</td><td class="line"> </td></tr>
<tr><td class="num" id="LN278">278</td><td class="line">        <span class='comment'>/* We split up user logs only on /var, not on /run. If the</span></td></tr>
<tr><td class="num" id="LN279">279</td><td class="line">         <span class='comment'>* runtime file is open, we write to it exclusively, in order</span></td></tr>
<tr><td class="num" id="LN280">280</td><td class="line">         <span class='comment'>* to guarantee proper order as soon as we flush /run to</span></td></tr>
<tr><td class="num" id="LN281">281</td><td class="line">         <span class='comment'>* /var and close the runtime file. */</span></td></tr>
<tr><td class="num" id="LN282">282</td><td class="line"> </td></tr>
<tr><td class="num" id="LN283">283</td><td class="line">        <span class='keyword'>if</span> (s-&gt;runtime_journal)</td></tr>
<tr><td class="num" id="LN284">284</td><td class="line">                <span class='keyword'>return</span> s-&gt;runtime_journal;</td></tr>
<tr><td class="num" id="LN285">285</td><td class="line"> </td></tr>
<tr><td class="num" id="LN286">286</td><td class="line">        <span class='keyword'>if</span> (uid &lt;= <span class='macro'>SYSTEM_UID_MAX<span class='expansion'>999</span></span>)</td></tr>
<tr><td class="num" id="LN287">287</td><td class="line">                <span class='keyword'>return</span> s-&gt;system_journal;</td></tr>
<tr><td class="num" id="LN288">288</td><td class="line"> </td></tr>
<tr><td class="num" id="LN289">289</td><td class="line">        r = sd_id128_get_machine(&amp;machine);</td></tr>
<tr><td class="num" id="LN290">290</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN291">291</td><td class="line">                <span class='keyword'>return</span> s-&gt;system_journal;</td></tr>
<tr><td class="num" id="LN292">292</td><td class="line"> </td></tr>
<tr><td class="num" id="LN293">293</td><td class="line">        f = ordered_hashmap_get(s-&gt;user_journals, <span class='macro'>UID_TO_PTR(uid)<span class='expansion'>((void*) (((uintptr_t) (uid))+1))</span></span>);</td></tr>
<tr><td class="num" id="LN294">294</td><td class="line">        <span class='keyword'>if</span> (f)</td></tr>
<tr><td class="num" id="LN295">295</td><td class="line">                <span class='keyword'>return</span> f;</td></tr>
<tr><td class="num" id="LN296">296</td><td class="line"> </td></tr>
<tr><td class="num" id="LN297">297</td><td class="line">        <span class='keyword'>if</span> (asprintf(&amp;p, <span class='string_literal'>"/var/log/journal/"</span> <span class='macro'>SD_ID128_FORMAT_STR<span class='expansion'>"%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x"</span></span> <span class='string_literal'>"/user-"</span><span class='macro'>UID_FMT<span class='expansion'>"%" "u"</span></span><span class='string_literal'>".journal"</span>,</td></tr>
<tr><td class="num" id="LN298">298</td><td class="line">                     <span class='macro'>SD_ID128_FORMAT_VAL(machine)<span class='expansion'>(machine).bytes[0], (machine).bytes[1], (machine).bytes[2], (<br>machine).bytes[3], (machine).bytes[4], (machine).bytes[5], (machine<br>).bytes[6], (machine).bytes[7], (machine).bytes[8], (machine)<br>.bytes[9], (machine).bytes[10], (machine).bytes[11], (machine<br>).bytes[12], (machine).bytes[13], (machine).bytes[14], (machine<br>).bytes[15]</span></span>, uid) &lt; 0)</td></tr>
<tr><td class="num" id="LN299">299</td><td class="line">                <span class='keyword'>return</span> s-&gt;system_journal;</td></tr>
<tr><td class="num" id="LN300">300</td><td class="line"> </td></tr>
<tr><td class="num" id="LN301">301</td><td class="line">        <span class='keyword'>while</span> (ordered_hashmap_size(s-&gt;user_journals) &gt;= <span class='macro'>USER_JOURNALS_MAX<span class='expansion'>1024</span></span>) {</td></tr>
<tr><td class="num" id="LN302">302</td><td class="line">                <span class='comment'>/* Too many open? Then let's close one */</span></td></tr>
<tr><td class="num" id="LN303">303</td><td class="line">                f = ordered_hashmap_steal_first(s-&gt;user_journals);</td></tr>
<tr><td class="num" id="LN304">304</td><td class="line">                <span class='macro'>assert(f)<span class='expansion'>do { if ((__builtin_expect(!!(!(f)),0))) log_assert_failed("f"<br>, "src/journal/journald-server.c", 304, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN305">305</td><td class="line">                (<span class='keyword'>void</span>) journal_file_close(f);</td></tr>
<tr><td class="num" id="LN306">306</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN307">307</td><td class="line"> </td></tr>
<tr><td class="num" id="LN308">308</td><td class="line">        r = open_journal(s, <span class='macro'>true<span class='expansion'>1</span></span>, p, <span class='macro'>O_RDWR<span class='expansion'>02</span></span>|<span class='macro'>O_CREAT<span class='expansion'>0100</span></span>, s-&gt;seal, &amp;s-&gt;system_metrics, &amp;f);</td></tr>
<tr><td class="num" id="LN309">309</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN310">310</td><td class="line">                <span class='keyword'>return</span> s-&gt;system_journal;</td></tr>
<tr><td class="num" id="LN311">311</td><td class="line"> </td></tr>
<tr><td class="num" id="LN312">312</td><td class="line">        server_add_acls(f, uid);</td></tr>
<tr><td class="num" id="LN313">313</td><td class="line"> </td></tr>
<tr><td class="num" id="LN314">314</td><td class="line">        r = ordered_hashmap_put(s-&gt;user_journals, <span class='macro'>UID_TO_PTR(uid)<span class='expansion'>((void*) (((uintptr_t) (uid))+1))</span></span>, f);</td></tr>
<tr><td class="num" id="LN315">315</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0) {</td></tr>
<tr><td class="num" id="LN316">316</td><td class="line">                (<span class='keyword'>void</span>) journal_file_close(f);</td></tr>
<tr><td class="num" id="LN317">317</td><td class="line">                <span class='keyword'>return</span> s-&gt;system_journal;</td></tr>
<tr><td class="num" id="LN318">318</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN319">319</td><td class="line"> </td></tr>
<tr><td class="num" id="LN320">320</td><td class="line">        <span class='keyword'>return</span> f;</td></tr>
<tr><td class="num" id="LN321">321</td><td class="line">}</td></tr>
<tr><td class="num" id="LN322">322</td><td class="line"> </td></tr>
<tr><td class="num" id="LN323">323</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> do_rotate(</td></tr>
<tr><td class="num" id="LN324">324</td><td class="line">                Server *s,</td></tr>
<tr><td class="num" id="LN325">325</td><td class="line">                JournalFile **f,</td></tr>
<tr><td class="num" id="LN326">326</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>char</span>* name,</td></tr>
<tr><td class="num" id="LN327">327</td><td class="line">                <span class='macro'>bool<span class='expansion'>_Bool</span></span> seal,</td></tr>
<tr><td class="num" id="LN328">328</td><td class="line">                uint32_t uid) {</td></tr>
<tr><td class="num" id="LN329">329</td><td class="line"> </td></tr>
<tr><td class="num" id="LN330">330</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN331">331</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 331, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN332">332</td><td class="line"> </td></tr>
<tr><td class="num" id="LN333">333</td><td class="line">        <span class='keyword'>if</span> (!*f)</td></tr>
<tr><td class="num" id="LN334">334</td><td class="line">                <span class='keyword'>return</span> -<span class='macro'>EINVAL<span class='expansion'>22</span></span>;</td></tr>
<tr><td class="num" id="LN335">335</td><td class="line"> </td></tr>
<tr><td class="num" id="LN336">336</td><td class="line">        r = journal_file_rotate(f, s-&gt;compress, seal, s-&gt;deferred_closes);</td></tr>
<tr><td class="num" id="LN337">337</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN338">338</td><td class="line">                <span class='keyword'>if</span> (*f)</td></tr>
<tr><td class="num" id="LN339">339</td><td class="line">                        <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to rotate %s: %m"</span>, (*f)-&gt;path)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 339, __func__, "Failed to rotate %s: %m", (*f)-&gt;path) : -<br>abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN340">340</td><td class="line">                <span class='keyword'>else</span></td></tr>
<tr><td class="num" id="LN341">341</td><td class="line">                        <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to create new %s journal: %m"</span>, name)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 341, __func__, "Failed to create new %s journal: %m", name)<br> : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN342">342</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr><td class="num" id="LN343">343</td><td class="line">                server_add_acls(*f, uid);</td></tr>
<tr><td class="num" id="LN344">344</td><td class="line"> </td></tr>
<tr><td class="num" id="LN345">345</td><td class="line">        <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN346">346</td><td class="line">}</td></tr>
<tr><td class="num" id="LN347">347</td><td class="line"> </td></tr>
<tr><td class="num" id="LN348">348</td><td class="line"><span class='keyword'>void</span> server_rotate(Server *s) {</td></tr>
<tr><td class="num" id="LN349">349</td><td class="line">        JournalFile *f;</td></tr>
<tr><td class="num" id="LN350">350</td><td class="line">        <span class='keyword'>void</span> *k;</td></tr>
<tr><td class="num" id="LN351">351</td><td class="line">        Iterator i;</td></tr>
<tr><td class="num" id="LN352">352</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN353">353</td><td class="line"> </td></tr>
<tr><td class="num" id="LN354">354</td><td class="line">        <span class='macro'>log_debug(<span class='string_literal'>"Rotating..."</span>)<span class='expansion'>({ int _level = (7), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 354, __func__, "Rotating...") : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN355">355</td><td class="line"> </td></tr>
<tr><td class="num" id="LN356">356</td><td class="line">        (<span class='keyword'>void</span>) do_rotate(s, &amp;s-&gt;runtime_journal, <span class='string_literal'>"runtime"</span>, <span class='macro'>false<span class='expansion'>0</span></span>, 0);</td></tr>
<tr><td class="num" id="LN357">357</td><td class="line">        (<span class='keyword'>void</span>) do_rotate(s, &amp;s-&gt;system_journal, <span class='string_literal'>"system"</span>, s-&gt;seal, 0);</td></tr>
<tr><td class="num" id="LN358">358</td><td class="line"> </td></tr>
<tr><td class="num" id="LN359">359</td><td class="line">        <span class='macro'>ORDERED_HASHMAP_FOREACH_KEY(f, k, s-&gt;user_journals, i)<span class='expansion'>for ((i) = ((Iterator) { .idx = ((2147483647 *2U +1U) - 1), .<br>next_key = ((void*)0) }); ordered_hashmap_iterate((s-&gt;user_journals<br>), &amp;(i), (void**)&amp;(f), (const void**) &amp;(k)); )</span></span> {</td></tr>
<tr><td class="num" id="LN360">360</td><td class="line">                r = do_rotate(s, &amp;f, <span class='string_literal'>"user"</span>, s-&gt;seal, <span class='macro'>PTR_TO_UID(k)<span class='expansion'>((uid_t) (((uintptr_t) (k))-1))</span></span>);</td></tr>
<tr><td class="num" id="LN361">361</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0)</td></tr>
<tr><td class="num" id="LN362">362</td><td class="line">                        ordered_hashmap_replace(s-&gt;user_journals, k, f);</td></tr>
<tr><td class="num" id="LN363">363</td><td class="line">                <span class='keyword'>else</span> <span class='keyword'>if</span> (!f)</td></tr>
<tr><td class="num" id="LN364">364</td><td class="line">                        <span class='comment'>/* Old file has been closed and deallocated */</span></td></tr>
<tr><td class="num" id="LN365">365</td><td class="line">                        ordered_hashmap_remove(s-&gt;user_journals, k);</td></tr>
<tr><td class="num" id="LN366">366</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN367">367</td><td class="line"> </td></tr>
<tr><td class="num" id="LN368">368</td><td class="line">        <span class='comment'>/* Perform any deferred closes which aren't still offlining. */</span></td></tr>
<tr><td class="num" id="LN369">369</td><td class="line">        <span class='macro'>SET_FOREACH(f, s-&gt;deferred_closes, i)<span class='expansion'>for ((i) = ((Iterator) { .idx = ((2147483647 *2U +1U) - 1), .<br>next_key = ((void*)0) }); set_iterate((s-&gt;deferred_closes)<br>, &amp;(i), (void**)&amp;(f)); )</span></span></td></tr>
<tr><td class="num" id="LN370">370</td><td class="line">                <span class='keyword'>if</span> (!journal_file_is_offlining(f)) {</td></tr>
<tr><td class="num" id="LN371">371</td><td class="line">                        (<span class='keyword'>void</span>) set_remove(s-&gt;deferred_closes, f);</td></tr>
<tr><td class="num" id="LN372">372</td><td class="line">                        (<span class='keyword'>void</span>) journal_file_close(f);</td></tr>
<tr><td class="num" id="LN373">373</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN374">374</td><td class="line">}</td></tr>
<tr><td class="num" id="LN375">375</td><td class="line"> </td></tr>
<tr><td class="num" id="LN376">376</td><td class="line"><span class='keyword'>void</span> server_sync(Server *s) {</td></tr>
<tr><td class="num" id="LN377">377</td><td class="line">        JournalFile *f;</td></tr>
<tr><td class="num" id="LN378">378</td><td class="line">        Iterator i;</td></tr>
<tr><td class="num" id="LN379">379</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN380">380</td><td class="line"> </td></tr>
<tr><td class="num" id="LN381">381</td><td class="line">        <span class='keyword'>if</span> (s-&gt;system_journal) {</td></tr>
<tr><td class="num" id="LN382">382</td><td class="line">                r = journal_file_set_offline(s-&gt;system_journal, <span class='macro'>false<span class='expansion'>0</span></span>);</td></tr>
<tr><td class="num" id="LN383">383</td><td class="line">                <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN384">384</td><td class="line">                        <span class='macro'>log_warning_errno(r, <span class='string_literal'>"Failed to sync system journal, ignoring: %m"</span>)<span class='expansion'>({ int _level = (4), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 384, __func__, "Failed to sync system journal, ignoring: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN385">385</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN386">386</td><td class="line"> </td></tr>
<tr><td class="num" id="LN387">387</td><td class="line">        <span class='macro'>ORDERED_HASHMAP_FOREACH(f, s-&gt;user_journals, i)<span class='expansion'>for ((i) = ((Iterator) { .idx = ((2147483647 *2U +1U) - 1), .<br>next_key = ((void*)0) }); ordered_hashmap_iterate((s-&gt;user_journals<br>), &amp;(i), (void**)&amp;(f), ((void*)0)); )</span></span> {</td></tr>
<tr><td class="num" id="LN388">388</td><td class="line">                r = journal_file_set_offline(f, <span class='macro'>false<span class='expansion'>0</span></span>);</td></tr>
<tr><td class="num" id="LN389">389</td><td class="line">                <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN390">390</td><td class="line">                        <span class='macro'>log_warning_errno(r, <span class='string_literal'>"Failed to sync user journal, ignoring: %m"</span>)<span class='expansion'>({ int _level = (4), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 390, __func__, "Failed to sync user journal, ignoring: %m")<br> : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN391">391</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN392">392</td><td class="line"> </td></tr>
<tr><td class="num" id="LN393">393</td><td class="line">        <span class='keyword'>if</span> (s-&gt;sync_event_source) {</td></tr>
<tr><td class="num" id="LN394">394</td><td class="line">                r = sd_event_source_set_enabled(s-&gt;sync_event_source, SD_EVENT_OFF);</td></tr>
<tr><td class="num" id="LN395">395</td><td class="line">                <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN396">396</td><td class="line">                        <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to disable sync timer source: %m"</span>)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 396, __func__, "Failed to disable sync timer source: %m") :<br> -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN397">397</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN398">398</td><td class="line"> </td></tr>
<tr><td class="num" id="LN399">399</td><td class="line">        s-&gt;sync_scheduled = <span class='macro'>false<span class='expansion'>0</span></span>;</td></tr>
<tr><td class="num" id="LN400">400</td><td class="line">}</td></tr>
<tr><td class="num" id="LN401">401</td><td class="line"> </td></tr>
<tr><td class="num" id="LN402">402</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> do_vacuum(</td></tr>
<tr><td class="num" id="LN403">403</td><td class="line">                Server *s,</td></tr>
<tr><td class="num" id="LN404">404</td><td class="line">                JournalFile *f,</td></tr>
<tr><td class="num" id="LN405">405</td><td class="line">                JournalMetrics *metrics,</td></tr>
<tr><td class="num" id="LN406">406</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>char</span> *path,</td></tr>
<tr><td class="num" id="LN407">407</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>char</span> *name,</td></tr>
<tr><td class="num" id="LN408">408</td><td class="line">                <span class='macro'>bool<span class='expansion'>_Bool</span></span> verbose,</td></tr>
<tr><td class="num" id="LN409">409</td><td class="line">                <span class='macro'>bool<span class='expansion'>_Bool</span></span> patch_min_use) {</td></tr>
<tr><td class="num" id="LN410">410</td><td class="line"> </td></tr>
<tr><td class="num" id="LN411">411</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span> *p;</td></tr>
<tr><td class="num" id="LN412">412</td><td class="line">        uint64_t limit;</td></tr>
<tr><td class="num" id="LN413">413</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN414">414</td><td class="line"> </td></tr>
<tr><td class="num" id="LN415">415</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 415, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN416">416</td><td class="line">        <span class='macro'>assert(metrics)<span class='expansion'>do { if ((__builtin_expect(!!(!(metrics)),0))) log_assert_failed<br>("metrics", "src/journal/journald-server.c", 416, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN417">417</td><td class="line">        <span class='macro'>assert(path)<span class='expansion'>do { if ((__builtin_expect(!!(!(path)),0))) log_assert_failed<br>("path", "src/journal/journald-server.c", 417, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN418">418</td><td class="line">        <span class='macro'>assert(name)<span class='expansion'>do { if ((__builtin_expect(!!(!(name)),0))) log_assert_failed<br>("name", "src/journal/journald-server.c", 418, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN419">419</td><td class="line"> </td></tr>
<tr><td class="num" id="LN420">420</td><td class="line">        <span class='keyword'>if</span> (!f)</td></tr>
<tr><td class="num" id="LN421">421</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr><td class="num" id="LN422">422</td><td class="line"> </td></tr>
<tr><td class="num" id="LN423">423</td><td class="line">        p = <span class='macro'>strjoina(path, SERVER_MACHINE_ID(s))<span class='expansion'>({ const char *_appendees_[] = { path, ((s)-&gt;machine_id_field<br> + strlen("_MACHINE_ID=")) }; char *_d_, *_p_; int _len_ = 0;<br> unsigned _i_; for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _len_ += strlen<br>(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca (_len_ + 1);<br> for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr(<br> !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN424">424</td><td class="line"> </td></tr>
<tr><td class="num" id="LN425">425</td><td class="line">        limit = metrics-&gt;max_use;</td></tr>
<tr><td class="num" id="LN426">426</td><td class="line">        (<span class='keyword'>void</span>) determine_space_for(s, metrics, path, name, verbose, patch_min_use, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, &amp;limit);</td></tr>
<tr><td class="num" id="LN427">427</td><td class="line"> </td></tr>
<tr><td class="num" id="LN428">428</td><td class="line">        r = journal_directory_vacuum(p, limit, metrics-&gt;n_max_files, s-&gt;max_retention_usec, &amp;s-&gt;oldest_file_usec,  verbose);</td></tr>
<tr><td class="num" id="LN429">429</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0 &amp;&amp; r != -<span class='macro'>ENOENT<span class='expansion'>2</span></span>)</td></tr>
<tr><td class="num" id="LN430">430</td><td class="line">                <span class='macro'>log_warning_errno(r, <span class='string_literal'>"Failed to vacuum %s, ignoring: %m"</span>, p)<span class='expansion'>({ int _level = (4), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 430, __func__, "Failed to vacuum %s, ignoring: %m", p) : -abs<br>(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN431">431</td><td class="line">}</td></tr>
<tr><td class="num" id="LN432">432</td><td class="line"> </td></tr>
<tr><td class="num" id="LN433">433</td><td class="line"><span class='keyword'>int</span> server_vacuum(Server *s, <span class='macro'>bool<span class='expansion'>_Bool</span></span> verbose, <span class='macro'>bool<span class='expansion'>_Bool</span></span> patch_min_use) {</td></tr>
<tr><td class="num" id="LN434">434</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 434, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN435">435</td><td class="line"> </td></tr>
<tr><td class="num" id="LN436">436</td><td class="line">        <span class='macro'>log_debug(<span class='string_literal'>"Vacuuming..."</span>)<span class='expansion'>({ int _level = (7), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 436, __func__, "Vacuuming...") : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN437">437</td><td class="line"> </td></tr>
<tr><td class="num" id="LN438">438</td><td class="line">        s-&gt;oldest_file_usec = 0;</td></tr>
<tr><td class="num" id="LN439">439</td><td class="line"> </td></tr>
<tr><td class="num" id="LN440">440</td><td class="line">        do_vacuum(s, s-&gt;system_journal, &amp;s-&gt;system_metrics, <span class='string_literal'>"/var/log/journal/"</span>, <span class='string_literal'>"System journal"</span>, verbose, patch_min_use);</td></tr>
<tr><td class="num" id="LN441">441</td><td class="line">        do_vacuum(s, s-&gt;runtime_journal, &amp;s-&gt;runtime_metrics, <span class='string_literal'>"/run/log/journal/"</span>, <span class='string_literal'>"Runtime journal"</span>, verbose, patch_min_use);</td></tr>
<tr><td class="num" id="LN442">442</td><td class="line"> </td></tr>
<tr><td class="num" id="LN443">443</td><td class="line">        s-&gt;cached_space_limit = 0;</td></tr>
<tr><td class="num" id="LN444">444</td><td class="line">        s-&gt;cached_space_available = 0;</td></tr>
<tr><td class="num" id="LN445">445</td><td class="line">        s-&gt;cached_space_timestamp = 0;</td></tr>
<tr><td class="num" id="LN446">446</td><td class="line"> </td></tr>
<tr><td class="num" id="LN447">447</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN448">448</td><td class="line">}</td></tr>
<tr><td class="num" id="LN449">449</td><td class="line"> </td></tr>
<tr><td class="num" id="LN450">450</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> server_cache_machine_id(Server *s) {</td></tr>
<tr><td class="num" id="LN451">451</td><td class="line">        sd_id128_t id;</td></tr>
<tr><td class="num" id="LN452">452</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN453">453</td><td class="line"> </td></tr>
<tr><td class="num" id="LN454">454</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 454, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN455">455</td><td class="line"> </td></tr>
<tr><td class="num" id="LN456">456</td><td class="line">        r = sd_id128_get_machine(&amp;id);</td></tr>
<tr><td class="num" id="LN457">457</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN458">458</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr><td class="num" id="LN459">459</td><td class="line"> </td></tr>
<tr><td class="num" id="LN460">460</td><td class="line">        sd_id128_to_string(id, stpcpy(s-&gt;machine_id_field, <span class='string_literal'>"_MACHINE_ID="</span>));</td></tr>
<tr><td class="num" id="LN461">461</td><td class="line">}</td></tr>
<tr><td class="num" id="LN462">462</td><td class="line"> </td></tr>
<tr><td class="num" id="LN463">463</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> server_cache_boot_id(Server *s) {</td></tr>
<tr><td class="num" id="LN464">464</td><td class="line">        sd_id128_t id;</td></tr>
<tr><td class="num" id="LN465">465</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN466">466</td><td class="line"> </td></tr>
<tr><td class="num" id="LN467">467</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 467, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN468">468</td><td class="line"> </td></tr>
<tr><td class="num" id="LN469">469</td><td class="line">        r = sd_id128_get_boot(&amp;id);</td></tr>
<tr><td class="num" id="LN470">470</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN471">471</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr><td class="num" id="LN472">472</td><td class="line"> </td></tr>
<tr><td class="num" id="LN473">473</td><td class="line">        sd_id128_to_string(id, stpcpy(s-&gt;boot_id_field, <span class='string_literal'>"_BOOT_ID="</span>));</td></tr>
<tr><td class="num" id="LN474">474</td><td class="line">}</td></tr>
<tr><td class="num" id="LN475">475</td><td class="line"> </td></tr>
<tr><td class="num" id="LN476">476</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> server_cache_hostname(Server *s) {</td></tr>
<tr><td class="num" id="LN477">477</td><td class="line">        <span class='macro'>_cleanup_free_<span class='expansion'>__attribute__((cleanup(freep)))</span></span> <span class='keyword'>char</span> *t = <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>;</td></tr>
<tr><td class="num" id="LN478">478</td><td class="line">        <span class='keyword'>char</span> *x;</td></tr>
<tr><td class="num" id="LN479">479</td><td class="line"> </td></tr>
<tr><td class="num" id="LN480">480</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 480, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN481">481</td><td class="line"> </td></tr>
<tr><td class="num" id="LN482">482</td><td class="line">        t = gethostname_malloc();</td></tr>
<tr><td class="num" id="LN483">483</td><td class="line">        <span class='keyword'>if</span> (!t)</td></tr>
<tr><td class="num" id="LN484">484</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr><td class="num" id="LN485">485</td><td class="line"> </td></tr>
<tr><td class="num" id="LN486">486</td><td class="line">        x = strappend(<span class='string_literal'>"_HOSTNAME="</span>, t);</td></tr>
<tr><td class="num" id="LN487">487</td><td class="line">        <span class='keyword'>if</span> (!x)</td></tr>
<tr><td class="num" id="LN488">488</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr><td class="num" id="LN489">489</td><td class="line"> </td></tr>
<tr><td class="num" id="LN490">490</td><td class="line">        free(s-&gt;hostname_field);</td></tr>
<tr><td class="num" id="LN491">491</td><td class="line">        s-&gt;hostname_field = x;</td></tr>
<tr><td class="num" id="LN492">492</td><td class="line">}</td></tr>
<tr><td class="num" id="LN493">493</td><td class="line"> </td></tr>
<tr><td class="num" id="LN494">494</td><td class="line"><span class='keyword'>static</span> <span class='macro'>bool<span class='expansion'>_Bool</span></span> shall_try_append_again(JournalFile *f, <span class='keyword'>int</span> r) {</td></tr>
<tr><td class="num" id="LN495">495</td><td class="line"> </td></tr>
<tr><td class="num" id="LN496">496</td><td class="line">        <span class='comment'>/* -E2BIG            Hit configured limit</span></td></tr>
<tr><td class="num" id="LN497">497</td><td class="line">           <span class='comment'>-EFBIG            Hit fs limit</span></td></tr>
<tr><td class="num" id="LN498">498</td><td class="line">           <span class='comment'>-EDQUOT           Quota limit hit</span></td></tr>
<tr><td class="num" id="LN499">499</td><td class="line">           <span class='comment'>-ENOSPC           Disk full</span></td></tr>
<tr><td class="num" id="LN500">500</td><td class="line">           <span class='comment'>-EIO              I/O error of some kind (mmap)</span></td></tr>
<tr><td class="num" id="LN501">501</td><td class="line">           <span class='comment'>-EHOSTDOWN        Other machine</span></td></tr>
<tr><td class="num" id="LN502">502</td><td class="line">           <span class='comment'>-EBUSY            Unclean shutdown</span></td></tr>
<tr><td class="num" id="LN503">503</td><td class="line">           <span class='comment'>-EPROTONOSUPPORT  Unsupported feature</span></td></tr>
<tr><td class="num" id="LN504">504</td><td class="line">           <span class='comment'>-EBADMSG          Corrupted</span></td></tr>
<tr><td class="num" id="LN505">505</td><td class="line">           <span class='comment'>-ENODATA          Truncated</span></td></tr>
<tr><td class="num" id="LN506">506</td><td class="line">           <span class='comment'>-ESHUTDOWN        Already archived</span></td></tr>
<tr><td class="num" id="LN507">507</td><td class="line">           <span class='comment'>-EIDRM            Journal file has been deleted */</span></td></tr>
<tr><td class="num" id="LN508">508</td><td class="line"> </td></tr>
<tr><td class="num" id="LN509">509</td><td class="line">        <span class='keyword'>if</span> (r == -<span class='macro'>E2BIG<span class='expansion'>7</span></span> || r == -<span class='macro'>EFBIG<span class='expansion'>27</span></span> || r == -<span class='macro'>EDQUOT<span class='expansion'>122</span></span> || r == -<span class='macro'>ENOSPC<span class='expansion'>28</span></span>)</td></tr>
<tr><td class="num" id="LN510">510</td><td class="line">                <span class='macro'>log_debug(<span class='string_literal'>"%s: Allocation limit reached, rotating."</span>, f-&gt;path)<span class='expansion'>({ int _level = (7), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 510, __func__, "%s: Allocation limit reached, rotating.", f<br>-&gt;path) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN511">511</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (r == -<span class='macro'>EHOSTDOWN<span class='expansion'>112</span></span>)</td></tr>
<tr><td class="num" id="LN512">512</td><td class="line">                <span class='macro'>log_info(<span class='string_literal'>"%s: Journal file from other machine, rotating."</span>, f-&gt;path)<span class='expansion'>({ int _level = (6), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 512, __func__, "%s: Journal file from other machine, rotating."<br>, f-&gt;path) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN513">513</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (r == -<span class='macro'>EBUSY<span class='expansion'>16</span></span>)</td></tr>
<tr><td class="num" id="LN514">514</td><td class="line">                <span class='macro'>log_info(<span class='string_literal'>"%s: Unclean shutdown, rotating."</span>, f-&gt;path)<span class='expansion'>({ int _level = (6), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 514, __func__, "%s: Unclean shutdown, rotating.", f-&gt;path<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN515">515</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (r == -<span class='macro'>EPROTONOSUPPORT<span class='expansion'>93</span></span>)</td></tr>
<tr><td class="num" id="LN516">516</td><td class="line">                <span class='macro'>log_info(<span class='string_literal'>"%s: Unsupported feature, rotating."</span>, f-&gt;path)<span class='expansion'>({ int _level = (6), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 516, __func__, "%s: Unsupported feature, rotating.", f-&gt;<br>path) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN517">517</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (r == -<span class='macro'>EBADMSG<span class='expansion'>74</span></span> || r == -<span class='macro'>ENODATA<span class='expansion'>61</span></span> || r == <span class='macro'>ESHUTDOWN<span class='expansion'>108</span></span>)</td></tr>
<tr><td class="num" id="LN518">518</td><td class="line">                <span class='macro'>log_warning(<span class='string_literal'>"%s: Journal file corrupted, rotating."</span>, f-&gt;path)<span class='expansion'>({ int _level = (4), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 518, __func__, "%s: Journal file corrupted, rotating.", f-&gt;<br>path) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN519">519</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (r == -<span class='macro'>EIO<span class='expansion'>5</span></span>)</td></tr>
<tr><td class="num" id="LN520">520</td><td class="line">                <span class='macro'>log_warning(<span class='string_literal'>"%s: IO error, rotating."</span>, f-&gt;path)<span class='expansion'>({ int _level = (4), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 520, __func__, "%s: IO error, rotating.", f-&gt;path) : -abs<br>(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN521">521</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (r == -<span class='macro'>EIDRM<span class='expansion'>43</span></span>)</td></tr>
<tr><td class="num" id="LN522">522</td><td class="line">                <span class='macro'>log_warning(<span class='string_literal'>"%s: Journal file has been deleted, rotating."</span>, f-&gt;path)<span class='expansion'>({ int _level = (4), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 522, __func__, "%s: Journal file has been deleted, rotating."<br>, f-&gt;path) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN523">523</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr><td class="num" id="LN524">524</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>false<span class='expansion'>0</span></span>;</td></tr>
<tr><td class="num" id="LN525">525</td><td class="line"> </td></tr>
<tr><td class="num" id="LN526">526</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>true<span class='expansion'>1</span></span>;</td></tr>
<tr><td class="num" id="LN527">527</td><td class="line">}</td></tr>
<tr><td class="num" id="LN528">528</td><td class="line"> </td></tr>
<tr><td class="num" id="LN529">529</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> write_to_journal(Server *s, uid_t uid, <span class='keyword'>struct</span> iovec *iovec, <span class='keyword'>unsigned</span> n, <span class='keyword'>int</span> priority) {</td></tr>
<tr><td class="num" id="LN530">530</td><td class="line">        JournalFile *f;</td></tr>
<tr><td class="num" id="LN531">531</td><td class="line">        <span class='macro'>bool<span class='expansion'>_Bool</span></span> vacuumed = <span class='macro'>false<span class='expansion'>0</span></span>;</td></tr>
<tr><td class="num" id="LN532">532</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN533">533</td><td class="line"> </td></tr>
<tr><td class="num" id="LN534">534</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 534, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN535">535</td><td class="line">        <span class='macro'>assert(iovec)<span class='expansion'>do { if ((__builtin_expect(!!(!(iovec)),0))) log_assert_failed<br>("iovec", "src/journal/journald-server.c", 535, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN536">536</td><td class="line">        <span class='macro'>assert(n &gt; 0)<span class='expansion'>do { if ((__builtin_expect(!!(!(n &gt; 0)),0))) log_assert_failed<br>("n &gt; 0", "src/journal/journald-server.c", 536, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN537">537</td><td class="line"> </td></tr>
<tr><td class="num" id="LN538">538</td><td class="line">        f = find_journal(s, uid);</td></tr>
<tr><td class="num" id="LN539">539</td><td class="line">        <span class='keyword'>if</span> (!f)</td></tr>
<tr><td class="num" id="LN540">540</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr><td class="num" id="LN541">541</td><td class="line"> </td></tr>
<tr><td class="num" id="LN542">542</td><td class="line">        <span class='keyword'>if</span> (journal_file_rotate_suggested(f, s-&gt;max_file_usec)) {</td></tr>
<tr><td class="num" id="LN543">543</td><td class="line">                <span class='macro'>log_debug(<span class='string_literal'>"%s: Journal header limits reached or header out-of-date, rotating."</span>, f-&gt;path)<span class='expansion'>({ int _level = (7), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 543, __func__, "%s: Journal header limits reached or header out-of-date, rotating."<br>, f-&gt;path) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN544">544</td><td class="line">                server_rotate(s);</td></tr>
<tr><td class="num" id="LN545">545</td><td class="line">                server_vacuum(s, <span class='macro'>false<span class='expansion'>0</span></span>, <span class='macro'>false<span class='expansion'>0</span></span>);</td></tr>
<tr><td class="num" id="LN546">546</td><td class="line">                vacuumed = <span class='macro'>true<span class='expansion'>1</span></span>;</td></tr>
<tr><td class="num" id="LN547">547</td><td class="line"> </td></tr>
<tr><td class="num" id="LN548">548</td><td class="line">                f = find_journal(s, uid);</td></tr>
<tr><td class="num" id="LN549">549</td><td class="line">                <span class='keyword'>if</span> (!f)</td></tr>
<tr><td class="num" id="LN550">550</td><td class="line">                        <span class='keyword'>return</span>;</td></tr>
<tr><td class="num" id="LN551">551</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN552">552</td><td class="line"> </td></tr>
<tr><td class="num" id="LN553">553</td><td class="line">        r = journal_file_append_entry(f, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, iovec, n, &amp;s-&gt;seqnum, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>);</td></tr>
<tr><td class="num" id="LN554">554</td><td class="line">        <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN555">555</td><td class="line">                server_schedule_sync(s, priority);</td></tr>
<tr><td class="num" id="LN556">556</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr><td class="num" id="LN557">557</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN558">558</td><td class="line"> </td></tr>
<tr><td class="num" id="LN559">559</td><td class="line">        <span class='keyword'>if</span> (vacuumed || !shall_try_append_again(f, r)) {</td></tr>
<tr><td class="num" id="LN560">560</td><td class="line">                <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to write entry (%d items, %zu bytes), ignoring: %m"</span>, n, IOVEC_TOTAL_SIZE(iovec, n))<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 560, __func__, "Failed to write entry (%d items, %zu bytes), ignoring: %m"<br>, n, IOVEC_TOTAL_SIZE(iovec, n)) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN561">561</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr><td class="num" id="LN562">562</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN563">563</td><td class="line"> </td></tr>
<tr><td class="num" id="LN564">564</td><td class="line">        server_rotate(s);</td></tr>
<tr><td class="num" id="LN565">565</td><td class="line">        server_vacuum(s, <span class='macro'>false<span class='expansion'>0</span></span>, <span class='macro'>false<span class='expansion'>0</span></span>);</td></tr>
<tr><td class="num" id="LN566">566</td><td class="line"> </td></tr>
<tr><td class="num" id="LN567">567</td><td class="line">        f = find_journal(s, uid);</td></tr>
<tr><td class="num" id="LN568">568</td><td class="line">        <span class='keyword'>if</span> (!f)</td></tr>
<tr><td class="num" id="LN569">569</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr><td class="num" id="LN570">570</td><td class="line"> </td></tr>
<tr><td class="num" id="LN571">571</td><td class="line">        <span class='macro'>log_debug(<span class='string_literal'>"Retrying write."</span>)<span class='expansion'>({ int _level = (7), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 571, __func__, "Retrying write.") : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN572">572</td><td class="line">        r = journal_file_append_entry(f, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, iovec, n, &amp;s-&gt;seqnum, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>);</td></tr>
<tr><td class="num" id="LN573">573</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN574">574</td><td class="line">                <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to write entry (%d items, %zu bytes) despite vacuuming, ignoring: %m"</span>, n, IOVEC_TOTAL_SIZE(iovec, n))<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 574, __func__, "Failed to write entry (%d items, %zu bytes) despite vacuuming, ignoring: %m"<br>, n, IOVEC_TOTAL_SIZE(iovec, n)) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN575">575</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr><td class="num" id="LN576">576</td><td class="line">                server_schedule_sync(s, priority);</td></tr>
<tr><td class="num" id="LN577">577</td><td class="line">}</td></tr>
<tr><td class="num" id="LN578">578</td><td class="line"> </td></tr>
<tr><td class="num" id="LN579">579</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> dispatch_message_real(</td></tr>
<tr><td class="num" id="LN580">580</td><td class="line">                Server *s,</td></tr>
<tr><td class="num" id="LN581">581</td><td class="line">                <span class='keyword'>struct</span> iovec *iovec, <span class='keyword'>unsigned</span> n, <span class='keyword'>unsigned</span> m,</td></tr>
<tr><td class="num" id="LN582">582</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>struct</span> ucred *ucred,</td></tr>
<tr><td class="num" id="LN583">583</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>struct</span> timeval *tv,</td></tr>
<tr><td class="num" id="LN584">584</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>char</span> *label, size_t label_len,</td></tr>
<tr><td class="num" id="LN585">585</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>char</span> *unit_id,</td></tr>
<tr><td class="num" id="LN586">586</td><td class="line">                <span class='keyword'>int</span> priority,</td></tr>
<tr><td class="num" id="LN587">587</td><td class="line">                pid_t object_pid) {</td></tr>
<tr><td class="num" id="LN588">588</td><td class="line"> </td></tr>
<tr><td class="num" id="LN589">589</td><td class="line">        <span class='keyword'>char</span>    pid[<span class='keyword'>sizeof</span>(<span class='string_literal'>"_PID="</span>) + <span class='macro'>DECIMAL_STR_MAX(pid_t)<span class='expansion'>(2+(sizeof(pid_t) &lt;= 1 ? 3 : sizeof(pid_t) &lt;= 2 ? 5 : sizeof<br>(pid_t) &lt;= 4 ? 10 : sizeof(pid_t) &lt;= 8 ? 20 : sizeof(int<br>[-2*(sizeof(pid_t) &gt; 8)])))</span></span>],</td></tr>
<tr><td class="num" id="LN590">590</td><td class="line">                uid[<span class='keyword'>sizeof</span>(<span class='string_literal'>"_UID="</span>) + <span class='macro'>DECIMAL_STR_MAX(uid_t)<span class='expansion'>(2+(sizeof(uid_t) &lt;= 1 ? 3 : sizeof(uid_t) &lt;= 2 ? 5 : sizeof<br>(uid_t) &lt;= 4 ? 10 : sizeof(uid_t) &lt;= 8 ? 20 : sizeof(int<br>[-2*(sizeof(uid_t) &gt; 8)])))</span></span>],</td></tr>
<tr><td class="num" id="LN591">591</td><td class="line">                gid[<span class='keyword'>sizeof</span>(<span class='string_literal'>"_GID="</span>) + <span class='macro'>DECIMAL_STR_MAX(gid_t)<span class='expansion'>(2+(sizeof(gid_t) &lt;= 1 ? 3 : sizeof(gid_t) &lt;= 2 ? 5 : sizeof<br>(gid_t) &lt;= 4 ? 10 : sizeof(gid_t) &lt;= 8 ? 20 : sizeof(int<br>[-2*(sizeof(gid_t) &gt; 8)])))</span></span>],</td></tr>
<tr><td class="num" id="LN592">592</td><td class="line">                owner_uid[<span class='keyword'>sizeof</span>(<span class='string_literal'>"_SYSTEMD_OWNER_UID="</span>) + <span class='macro'>DECIMAL_STR_MAX(uid_t)<span class='expansion'>(2+(sizeof(uid_t) &lt;= 1 ? 3 : sizeof(uid_t) &lt;= 2 ? 5 : sizeof<br>(uid_t) &lt;= 4 ? 10 : sizeof(uid_t) &lt;= 8 ? 20 : sizeof(int<br>[-2*(sizeof(uid_t) &gt; 8)])))</span></span>],</td></tr>
<tr><td class="num" id="LN593">593</td><td class="line">                source_time[<span class='keyword'>sizeof</span>(<span class='string_literal'>"_SOURCE_REALTIME_TIMESTAMP="</span>) + <span class='macro'>DECIMAL_STR_MAX(usec_t)<span class='expansion'>(2+(sizeof(usec_t) &lt;= 1 ? 3 : sizeof(usec_t) &lt;= 2 ? 5 :<br> sizeof(usec_t) &lt;= 4 ? 10 : sizeof(usec_t) &lt;= 8 ? 20 : sizeof<br>(int[-2*(sizeof(usec_t) &gt; 8)])))</span></span>],</td></tr>
<tr><td class="num" id="LN594">594</td><td class="line">                o_uid[<span class='keyword'>sizeof</span>(<span class='string_literal'>"OBJECT_UID="</span>) + <span class='macro'>DECIMAL_STR_MAX(uid_t)<span class='expansion'>(2+(sizeof(uid_t) &lt;= 1 ? 3 : sizeof(uid_t) &lt;= 2 ? 5 : sizeof<br>(uid_t) &lt;= 4 ? 10 : sizeof(uid_t) &lt;= 8 ? 20 : sizeof(int<br>[-2*(sizeof(uid_t) &gt; 8)])))</span></span>],</td></tr>
<tr><td class="num" id="LN595">595</td><td class="line">                o_gid[<span class='keyword'>sizeof</span>(<span class='string_literal'>"OBJECT_GID="</span>) + <span class='macro'>DECIMAL_STR_MAX(gid_t)<span class='expansion'>(2+(sizeof(gid_t) &lt;= 1 ? 3 : sizeof(gid_t) &lt;= 2 ? 5 : sizeof<br>(gid_t) &lt;= 4 ? 10 : sizeof(gid_t) &lt;= 8 ? 20 : sizeof(int<br>[-2*(sizeof(gid_t) &gt; 8)])))</span></span>],</td></tr>
<tr><td class="num" id="LN596">596</td><td class="line">                o_owner_uid[<span class='keyword'>sizeof</span>(<span class='string_literal'>"OBJECT_SYSTEMD_OWNER_UID="</span>) + <span class='macro'>DECIMAL_STR_MAX(uid_t)<span class='expansion'>(2+(sizeof(uid_t) &lt;= 1 ? 3 : sizeof(uid_t) &lt;= 2 ? 5 : sizeof<br>(uid_t) &lt;= 4 ? 10 : sizeof(uid_t) &lt;= 8 ? 20 : sizeof(int<br>[-2*(sizeof(uid_t) &gt; 8)])))</span></span>];</td></tr>
<tr><td class="num" id="LN597">597</td><td class="line">        uid_t object_uid;</td></tr>
<tr><td class="num" id="LN598">598</td><td class="line">        gid_t object_gid;</td></tr>
<tr><td class="num" id="LN599">599</td><td class="line">        <span class='keyword'>char</span> *x;</td></tr>
<tr><td class="num" id="LN600">600</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN601">601</td><td class="line">        <span class='keyword'>char</span> *t, *c;</td></tr>
<tr><td class="num" id="LN602">602</td><td class="line">        uid_t realuid = 0, owner = 0, journal_uid;</td></tr>
<tr><td class="num" id="LN603">603</td><td class="line">        <span class='macro'>bool<span class='expansion'>_Bool</span></span> owner_valid = <span class='macro'>false<span class='expansion'>0</span></span>;</td></tr>
<tr><td class="num" id="LN604">604</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_AUDIT<span class='expansion'>1</span></span></span></td></tr>
<tr><td class="num" id="LN605">605</td><td class="line">        <span class='keyword'>char</span>    audit_session[<span class='keyword'>sizeof</span>(<span class='string_literal'>"_AUDIT_SESSION="</span>) + <span class='macro'>DECIMAL_STR_MAX(uint32_t)<span class='expansion'>(2+(sizeof(uint32_t) &lt;= 1 ? 3 : sizeof(uint32_t) &lt;= 2 ?<br> 5 : sizeof(uint32_t) &lt;= 4 ? 10 : sizeof(uint32_t) &lt;= 8<br> ? 20 : sizeof(int[-2*(sizeof(uint32_t) &gt; 8)])))</span></span>],</td></tr>
<tr><td class="num" id="LN606">606</td><td class="line">                audit_loginuid[<span class='keyword'>sizeof</span>(<span class='string_literal'>"_AUDIT_LOGINUID="</span>) + <span class='macro'>DECIMAL_STR_MAX(uid_t)<span class='expansion'>(2+(sizeof(uid_t) &lt;= 1 ? 3 : sizeof(uid_t) &lt;= 2 ? 5 : sizeof<br>(uid_t) &lt;= 4 ? 10 : sizeof(uid_t) &lt;= 8 ? 20 : sizeof(int<br>[-2*(sizeof(uid_t) &gt; 8)])))</span></span>],</td></tr>
<tr><td class="num" id="LN607">607</td><td class="line">                o_audit_session[<span class='keyword'>sizeof</span>(<span class='string_literal'>"OBJECT_AUDIT_SESSION="</span>) + <span class='macro'>DECIMAL_STR_MAX(uint32_t)<span class='expansion'>(2+(sizeof(uint32_t) &lt;= 1 ? 3 : sizeof(uint32_t) &lt;= 2 ?<br> 5 : sizeof(uint32_t) &lt;= 4 ? 10 : sizeof(uint32_t) &lt;= 8<br> ? 20 : sizeof(int[-2*(sizeof(uint32_t) &gt; 8)])))</span></span>],</td></tr>
<tr><td class="num" id="LN608">608</td><td class="line">                o_audit_loginuid[<span class='keyword'>sizeof</span>(<span class='string_literal'>"OBJECT_AUDIT_LOGINUID="</span>) + <span class='macro'>DECIMAL_STR_MAX(uid_t)<span class='expansion'>(2+(sizeof(uid_t) &lt;= 1 ? 3 : sizeof(uid_t) &lt;= 2 ? 5 : sizeof<br>(uid_t) &lt;= 4 ? 10 : sizeof(uid_t) &lt;= 8 ? 20 : sizeof(int<br>[-2*(sizeof(uid_t) &gt; 8)])))</span></span>];</td></tr>
<tr><td class="num" id="LN609">609</td><td class="line"> </td></tr>
<tr><td class="num" id="LN610">610</td><td class="line">        uint32_t audit;</td></tr>
<tr><td class="num" id="LN611">611</td><td class="line">        uid_t loginuid;</td></tr>
<tr><td class="num" id="LN612">612</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr><td class="num" id="LN613">613</td><td class="line"> </td></tr>
<tr><td class="num" id="LN614">614</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 614, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN615">615</td><td class="line">        <span class='macro'>assert(iovec)<span class='expansion'>do { if ((__builtin_expect(!!(!(iovec)),0))) log_assert_failed<br>("iovec", "src/journal/journald-server.c", 615, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN616">616</td><td class="line">        <span class='macro'>assert(n &gt; 0)<span class='expansion'>do { if ((__builtin_expect(!!(!(n &gt; 0)),0))) log_assert_failed<br>("n &gt; 0", "src/journal/journald-server.c", 616, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN617">617</td><td class="line">        <span class='macro'>assert(n + N_IOVEC_META_FIELDS + (object_pid ? N_IOVEC_OBJECT_FIELDS : 0) &lt;= m)<span class='expansion'>do { if ((__builtin_expect(!!(!(n + 20 + (object_pid ? 12 : 0<br>) &lt;= m)),0))) log_assert_failed("n + N_IOVEC_META_FIELDS + (object_pid ? N_IOVEC_OBJECT_FIELDS : 0) &lt;= m"<br>, "src/journal/journald-server.c", 617, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN618">618</td><td class="line"> </td></tr>
<tr><td class="num" id="LN619">619</td><td class="line">        <span class='keyword'>if</span> (ucred) {</td></tr>
<tr><td class="num" id="LN620">620</td><td class="line">                realuid = ucred-&gt;uid;</td></tr>
<tr><td class="num" id="LN621">621</td><td class="line"> </td></tr>
<tr><td class="num" id="LN622">622</td><td class="line">                sprintf(pid, <span class='string_literal'>"_PID="</span><span class='macro'>PID_FMT<span class='expansion'>"%" "i"</span></span>, ucred-&gt;pid);</td></tr>
<tr><td class="num" id="LN623">623</td><td class="line">                <span class='macro'>IOVEC_SET_STRING(iovec[n++], pid)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(pid); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN624">624</td><td class="line"> </td></tr>
<tr><td class="num" id="LN625">625</td><td class="line">                sprintf(uid, <span class='string_literal'>"_UID="</span><span class='macro'>UID_FMT<span class='expansion'>"%" "u"</span></span>, ucred-&gt;uid);</td></tr>
<tr><td class="num" id="LN626">626</td><td class="line">                <span class='macro'>IOVEC_SET_STRING(iovec[n++], uid)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(uid); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN627">627</td><td class="line"> </td></tr>
<tr><td class="num" id="LN628">628</td><td class="line">                sprintf(gid, <span class='string_literal'>"_GID="</span><span class='macro'>GID_FMT<span class='expansion'>"%" "u"</span></span>, ucred-&gt;gid);</td></tr>
<tr><td class="num" id="LN629">629</td><td class="line">                <span class='macro'>IOVEC_SET_STRING(iovec[n++], gid)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(gid); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN630">630</td><td class="line"> </td></tr>
<tr><td class="num" id="LN631">631</td><td class="line">                r = get_process_comm(ucred-&gt;pid, &amp;t);</td></tr>
<tr><td class="num" id="LN632">632</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN633">633</td><td class="line">                        x = <span class='macro'>strjoina(<span class='string_literal'>"_COMM="</span>, t)<span class='expansion'>({ const char *_appendees_[] = { "_COMM=", t }; char *_d_, *_p_<br>; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_ &lt; __extension__<br> (__builtin_choose_expr( !__builtin_types_compatible_p(typeof<br>(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN634">634</td><td class="line">                        free(t);</td></tr>
<tr><td class="num" id="LN635">635</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN636">636</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN637">637</td><td class="line"> </td></tr>
<tr><td class="num" id="LN638">638</td><td class="line">                r = get_process_exe(ucred-&gt;pid, &amp;t);</td></tr>
<tr><td class="num" id="LN639">639</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN640">640</td><td class="line">                        x = <span class='macro'>strjoina(<span class='string_literal'>"_EXE="</span>, t)<span class='expansion'>({ const char *_appendees_[] = { "_EXE=", t }; char *_d_, *_p_<br>; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_ &lt; __extension__<br> (__builtin_choose_expr( !__builtin_types_compatible_p(typeof<br>(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN641">641</td><td class="line">                        free(t);</td></tr>
<tr><td class="num" id="LN642">642</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN643">643</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN644">644</td><td class="line"> </td></tr>
<tr><td class="num" id="LN645">645</td><td class="line">                r = get_process_cmdline(ucred-&gt;pid, 0, <span class='macro'>false<span class='expansion'>0</span></span>, &amp;t);</td></tr>
<tr><td class="num" id="LN646">646</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN647">647</td><td class="line">                        x = <span class='macro'>strjoina(<span class='string_literal'>"_CMDLINE="</span>, t)<span class='expansion'>({ const char *_appendees_[] = { "_CMDLINE=", t }; char *_d_,<br> *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_ &lt; __extension__<br> (__builtin_choose_expr( !__builtin_types_compatible_p(typeof<br>(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN648">648</td><td class="line">                        free(t);</td></tr>
<tr><td class="num" id="LN649">649</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN650">650</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN651">651</td><td class="line"> </td></tr>
<tr><td class="num" id="LN652">652</td><td class="line">                r = get_process_capeff(ucred-&gt;pid, &amp;t);</td></tr>
<tr><td class="num" id="LN653">653</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN654">654</td><td class="line">                        x = <span class='macro'>strjoina(<span class='string_literal'>"_CAP_EFFECTIVE="</span>, t)<span class='expansion'>({ const char *_appendees_[] = { "_CAP_EFFECTIVE=", t }; char<br> *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_ &lt;<br> __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN655">655</td><td class="line">                        free(t);</td></tr>
<tr><td class="num" id="LN656">656</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN657">657</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN658">658</td><td class="line"> </td></tr>
<tr><td class="num" id="LN659">659</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_AUDIT<span class='expansion'>1</span></span></span></td></tr>
<tr><td class="num" id="LN660">660</td><td class="line">                r = audit_session_from_pid(ucred-&gt;pid, &amp;audit);</td></tr>
<tr><td class="num" id="LN661">661</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN662">662</td><td class="line">                        sprintf(audit_session, <span class='string_literal'>"_AUDIT_SESSION=%"</span><span class='macro'>PRIu32<span class='expansion'>"u"</span></span>, audit);</td></tr>
<tr><td class="num" id="LN663">663</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], audit_session)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(audit_session); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen<br>(_s); } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN664">664</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN665">665</td><td class="line"> </td></tr>
<tr><td class="num" id="LN666">666</td><td class="line">                r = audit_loginuid_from_pid(ucred-&gt;pid, &amp;loginuid);</td></tr>
<tr><td class="num" id="LN667">667</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN668">668</td><td class="line">                        sprintf(audit_loginuid, <span class='string_literal'>"_AUDIT_LOGINUID="</span><span class='macro'>UID_FMT<span class='expansion'>"%" "u"</span></span>, loginuid);</td></tr>
<tr><td class="num" id="LN669">669</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], audit_loginuid)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(audit_loginuid); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen<br>(_s); } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN670">670</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN671">671</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr><td class="num" id="LN672">672</td><td class="line"> </td></tr>
<tr><td class="num" id="LN673">673</td><td class="line">                r = cg_pid_get_path_shifted(ucred-&gt;pid, s-&gt;cgroup_root, &amp;c);</td></tr>
<tr><td class="num" id="LN674">674</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN675">675</td><td class="line">                        <span class='keyword'>char</span> *session = <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>;</td></tr>
<tr><td class="num" id="LN676">676</td><td class="line"> </td></tr>
<tr><td class="num" id="LN677">677</td><td class="line">                        x = <span class='macro'>strjoina(<span class='string_literal'>"_SYSTEMD_CGROUP="</span>, c)<span class='expansion'>({ const char *_appendees_[] = { "_SYSTEMD_CGROUP=", c }; char<br> *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_ &lt;<br> __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN678">678</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN679">679</td><td class="line"> </td></tr>
<tr><td class="num" id="LN680">680</td><td class="line">                        r = cg_path_get_session(c, &amp;t);</td></tr>
<tr><td class="num" id="LN681">681</td><td class="line">                        <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN682">682</td><td class="line">                                session = <span class='macro'>strjoina(<span class='string_literal'>"_SYSTEMD_SESSION="</span>, t)<span class='expansion'>({ const char *_appendees_[] = { "_SYSTEMD_SESSION=", t }; char<br> *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_ &lt;<br> __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN683">683</td><td class="line">                                free(t);</td></tr>
<tr><td class="num" id="LN684">684</td><td class="line">                                <span class='macro'>IOVEC_SET_STRING(iovec[n++], session)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(session); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s)<br>; } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN685">685</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN686">686</td><td class="line"> </td></tr>
<tr><td class="num" id="LN687">687</td><td class="line">                        <span class='keyword'>if</span> (cg_path_get_owner_uid(c, &amp;owner) &gt;= 0) {</td></tr>
<tr><td class="num" id="LN688">688</td><td class="line">                                owner_valid = <span class='macro'>true<span class='expansion'>1</span></span>;</td></tr>
<tr><td class="num" id="LN689">689</td><td class="line"> </td></tr>
<tr><td class="num" id="LN690">690</td><td class="line">                                sprintf(owner_uid, <span class='string_literal'>"_SYSTEMD_OWNER_UID="</span><span class='macro'>UID_FMT<span class='expansion'>"%" "u"</span></span>, owner);</td></tr>
<tr><td class="num" id="LN691">691</td><td class="line">                                <span class='macro'>IOVEC_SET_STRING(iovec[n++], owner_uid)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(owner_uid); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s<br>); } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN692">692</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN693">693</td><td class="line"> </td></tr>
<tr><td class="num" id="LN694">694</td><td class="line">                        <span class='keyword'>if</span> (cg_path_get_unit(c, &amp;t) &gt;= 0) {</td></tr>
<tr><td class="num" id="LN695">695</td><td class="line">                                x = <span class='macro'>strjoina(<span class='string_literal'>"_SYSTEMD_UNIT="</span>, t)<span class='expansion'>({ const char *_appendees_[] = { "_SYSTEMD_UNIT=", t }; char *<br>_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_ &lt;<br> __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN696">696</td><td class="line">                                free(t);</td></tr>
<tr><td class="num" id="LN697">697</td><td class="line">                                <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN698">698</td><td class="line">                        } <span class='keyword'>else</span> <span class='keyword'>if</span> (unit_id &amp;&amp; !session) {</td></tr>
<tr><td class="num" id="LN699">699</td><td class="line">                                x = <span class='macro'>strjoina(<span class='string_literal'>"_SYSTEMD_UNIT="</span>, unit_id)<span class='expansion'>({ const char *_appendees_[] = { "_SYSTEMD_UNIT=", unit_id };<br> char *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_<br> &lt; __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN700">700</td><td class="line">                                <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN701">701</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN702">702</td><td class="line"> </td></tr>
<tr><td class="num" id="LN703">703</td><td class="line">                        <span class='keyword'>if</span> (cg_path_get_user_unit(c, &amp;t) &gt;= 0) {</td></tr>
<tr><td class="num" id="LN704">704</td><td class="line">                                x = <span class='macro'>strjoina(<span class='string_literal'>"_SYSTEMD_USER_UNIT="</span>, t)<span class='expansion'>({ const char *_appendees_[] = { "_SYSTEMD_USER_UNIT=", t }; char<br> *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_ &lt;<br> __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN705">705</td><td class="line">                                free(t);</td></tr>
<tr><td class="num" id="LN706">706</td><td class="line">                                <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN707">707</td><td class="line">                        } <span class='keyword'>else</span> <span class='keyword'>if</span> (unit_id &amp;&amp; session) {</td></tr>
<tr><td class="num" id="LN708">708</td><td class="line">                                x = <span class='macro'>strjoina(<span class='string_literal'>"_SYSTEMD_USER_UNIT="</span>, unit_id)<span class='expansion'>({ const char *_appendees_[] = { "_SYSTEMD_USER_UNIT=", unit_id<br> }; char *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0<br>; _i_ &lt; __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN709">709</td><td class="line">                                <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN710">710</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN711">711</td><td class="line"> </td></tr>
<tr><td class="num" id="LN712">712</td><td class="line">                        <span class='keyword'>if</span> (cg_path_get_slice(c, &amp;t) &gt;= 0) {</td></tr>
<tr><td class="num" id="LN713">713</td><td class="line">                                x = <span class='macro'>strjoina(<span class='string_literal'>"_SYSTEMD_SLICE="</span>, t)<span class='expansion'>({ const char *_appendees_[] = { "_SYSTEMD_SLICE=", t }; char<br> *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_ &lt;<br> __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN714">714</td><td class="line">                                free(t);</td></tr>
<tr><td class="num" id="LN715">715</td><td class="line">                                <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN716">716</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN717">717</td><td class="line"> </td></tr>
<tr><td class="num" id="LN718">718</td><td class="line">                        free(c);</td></tr>
<tr><td class="num" id="LN719">719</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (unit_id) {</td></tr>
<tr><td class="num" id="LN720">720</td><td class="line">                        x = <span class='macro'>strjoina(<span class='string_literal'>"_SYSTEMD_UNIT="</span>, unit_id)<span class='expansion'>({ const char *_appendees_[] = { "_SYSTEMD_UNIT=", unit_id };<br> char *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_<br> &lt; __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN721">721</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN722">722</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN723">723</td><td class="line"> </td></tr>
<tr><td class="num" id="LN724">724</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_SELINUX<span class='expansion'>1</span></span></span></td></tr>
<tr><td class="num" id="LN725">725</td><td class="line">                <span class='keyword'>if</span> (mac_selinux_have()) {</td></tr>
<tr><td class="num" id="LN726">726</td><td class="line">                        <span class='keyword'>if</span> (label) {</td></tr>
<tr><td class="num" id="LN727">727</td><td class="line">                                x = <span class='macro'>alloca(strlen(<span class='string_literal'>"_SELINUX_CONTEXT="</span>) + label_len + 1)<span class='expansion'>__builtin_alloca (strlen("_SELINUX_CONTEXT=") + label_len + 1<br>)</span></span>;</td></tr>
<tr><td class="num" id="LN728">728</td><td class="line"> </td></tr>
<tr><td class="num" id="LN729">729</td><td class="line">                                *((<span class='keyword'>char</span>*) mempcpy(stpcpy(x, <span class='string_literal'>"_SELINUX_CONTEXT="</span>), label, label_len)) = 0;</td></tr>
<tr><td class="num" id="LN730">730</td><td class="line">                                <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN731">731</td><td class="line">                        } <span class='keyword'>else</span> {</td></tr>
<tr><td class="num" id="LN732">732</td><td class="line">                                security_context_t con;</td></tr>
<tr><td class="num" id="LN733">733</td><td class="line"> </td></tr>
<tr><td class="num" id="LN734">734</td><td class="line">                                <span class='keyword'>if</span> (getpidcon(ucred-&gt;pid, &amp;con) &gt;= 0) {</td></tr>
<tr><td class="num" id="LN735">735</td><td class="line">                                        x = <span class='macro'>strjoina(<span class='string_literal'>"_SELINUX_CONTEXT="</span>, con)<span class='expansion'>({ const char *_appendees_[] = { "_SELINUX_CONTEXT=", con }; char<br> *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_ &lt;<br> __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN736">736</td><td class="line"> </td></tr>
<tr><td class="num" id="LN737">737</td><td class="line">                                        freecon(con);</td></tr>
<tr><td class="num" id="LN738">738</td><td class="line">                                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN739">739</td><td class="line">                                }</td></tr>
<tr><td class="num" id="LN740">740</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN741">741</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN742">742</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr><td class="num" id="LN743">743</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN744">744</td><td class="line">        <span class='macro'>assert(n &lt;= m)<span class='expansion'>do { if ((__builtin_expect(!!(!(n &lt;= m)),0))) log_assert_failed<br>("n &lt;= m", "src/journal/journald-server.c", 744, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN745">745</td><td class="line"> </td></tr>
<tr><td class="num" id="LN746">746</td><td class="line">        <span class='keyword'>if</span> (object_pid) {</td></tr>
<tr><td class="num" id="LN747">747</td><td class="line">                r = get_process_uid(object_pid, &amp;object_uid);</td></tr>
<tr><td class="num" id="LN748">748</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN749">749</td><td class="line">                        sprintf(o_uid, <span class='string_literal'>"OBJECT_UID="</span><span class='macro'>UID_FMT<span class='expansion'>"%" "u"</span></span>, object_uid);</td></tr>
<tr><td class="num" id="LN750">750</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], o_uid)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(o_uid); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); }<br> while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN751">751</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN752">752</td><td class="line"> </td></tr>
<tr><td class="num" id="LN753">753</td><td class="line">                r = get_process_gid(object_pid, &amp;object_gid);</td></tr>
<tr><td class="num" id="LN754">754</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN755">755</td><td class="line">                        sprintf(o_gid, <span class='string_literal'>"OBJECT_GID="</span><span class='macro'>GID_FMT<span class='expansion'>"%" "u"</span></span>, object_gid);</td></tr>
<tr><td class="num" id="LN756">756</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], o_gid)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(o_gid); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); }<br> while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN757">757</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN758">758</td><td class="line"> </td></tr>
<tr><td class="num" id="LN759">759</td><td class="line">                r = get_process_comm(object_pid, &amp;t);</td></tr>
<tr><td class="num" id="LN760">760</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN761">761</td><td class="line">                        x = <span class='macro'>strjoina(<span class='string_literal'>"OBJECT_COMM="</span>, t)<span class='expansion'>({ const char *_appendees_[] = { "OBJECT_COMM=", t }; char *_d_<br>, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_ &lt; __extension__<br> (__builtin_choose_expr( !__builtin_types_compatible_p(typeof<br>(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN762">762</td><td class="line">                        free(t);</td></tr>
<tr><td class="num" id="LN763">763</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN764">764</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN765">765</td><td class="line"> </td></tr>
<tr><td class="num" id="LN766">766</td><td class="line">                r = get_process_exe(object_pid, &amp;t);</td></tr>
<tr><td class="num" id="LN767">767</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN768">768</td><td class="line">                        x = <span class='macro'>strjoina(<span class='string_literal'>"OBJECT_EXE="</span>, t)<span class='expansion'>({ const char *_appendees_[] = { "OBJECT_EXE=", t }; char *_d_<br>, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_ &lt; __extension__<br> (__builtin_choose_expr( !__builtin_types_compatible_p(typeof<br>(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN769">769</td><td class="line">                        free(t);</td></tr>
<tr><td class="num" id="LN770">770</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN771">771</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN772">772</td><td class="line"> </td></tr>
<tr><td class="num" id="LN773">773</td><td class="line">                r = get_process_cmdline(object_pid, 0, <span class='macro'>false<span class='expansion'>0</span></span>, &amp;t);</td></tr>
<tr><td class="num" id="LN774">774</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN775">775</td><td class="line">                        x = <span class='macro'>strjoina(<span class='string_literal'>"OBJECT_CMDLINE="</span>, t)<span class='expansion'>({ const char *_appendees_[] = { "OBJECT_CMDLINE=", t }; char<br> *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_ &lt;<br> __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN776">776</td><td class="line">                        free(t);</td></tr>
<tr><td class="num" id="LN777">777</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN778">778</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN779">779</td><td class="line"> </td></tr>
<tr><td class="num" id="LN780">780</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_AUDIT<span class='expansion'>1</span></span></span></td></tr>
<tr><td class="num" id="LN781">781</td><td class="line">                r = audit_session_from_pid(object_pid, &amp;audit);</td></tr>
<tr><td class="num" id="LN782">782</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN783">783</td><td class="line">                        sprintf(o_audit_session, <span class='string_literal'>"OBJECT_AUDIT_SESSION=%"</span><span class='macro'>PRIu32<span class='expansion'>"u"</span></span>, audit);</td></tr>
<tr><td class="num" id="LN784">784</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], o_audit_session)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(o_audit_session); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen<br>(_s); } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN785">785</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN786">786</td><td class="line"> </td></tr>
<tr><td class="num" id="LN787">787</td><td class="line">                r = audit_loginuid_from_pid(object_pid, &amp;loginuid);</td></tr>
<tr><td class="num" id="LN788">788</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN789">789</td><td class="line">                        sprintf(o_audit_loginuid, <span class='string_literal'>"OBJECT_AUDIT_LOGINUID="</span><span class='macro'>UID_FMT<span class='expansion'>"%" "u"</span></span>, loginuid);</td></tr>
<tr><td class="num" id="LN790">790</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], o_audit_loginuid)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(o_audit_loginuid); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen<br>(_s); } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN791">791</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN792">792</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr><td class="num" id="LN793">793</td><td class="line"> </td></tr>
<tr><td class="num" id="LN794">794</td><td class="line">                r = cg_pid_get_path_shifted(object_pid, s-&gt;cgroup_root, &amp;c);</td></tr>
<tr><td class="num" id="LN795">795</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN796">796</td><td class="line">                        x = <span class='macro'>strjoina(<span class='string_literal'>"OBJECT_SYSTEMD_CGROUP="</span>, c)<span class='expansion'>({ const char *_appendees_[] = { "OBJECT_SYSTEMD_CGROUP=", c }<br>; char *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0;<br> _i_ &lt; __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN797">797</td><td class="line">                        <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN798">798</td><td class="line"> </td></tr>
<tr><td class="num" id="LN799">799</td><td class="line">                        r = cg_path_get_session(c, &amp;t);</td></tr>
<tr><td class="num" id="LN800">800</td><td class="line">                        <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN801">801</td><td class="line">                                x = <span class='macro'>strjoina(<span class='string_literal'>"OBJECT_SYSTEMD_SESSION="</span>, t)<span class='expansion'>({ const char *_appendees_[] = { "OBJECT_SYSTEMD_SESSION=", t<br> }; char *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0<br>; _i_ &lt; __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN802">802</td><td class="line">                                free(t);</td></tr>
<tr><td class="num" id="LN803">803</td><td class="line">                                <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN804">804</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN805">805</td><td class="line"> </td></tr>
<tr><td class="num" id="LN806">806</td><td class="line">                        <span class='keyword'>if</span> (cg_path_get_owner_uid(c, &amp;owner) &gt;= 0) {</td></tr>
<tr><td class="num" id="LN807">807</td><td class="line">                                sprintf(o_owner_uid, <span class='string_literal'>"OBJECT_SYSTEMD_OWNER_UID="</span><span class='macro'>UID_FMT<span class='expansion'>"%" "u"</span></span>, owner);</td></tr>
<tr><td class="num" id="LN808">808</td><td class="line">                                <span class='macro'>IOVEC_SET_STRING(iovec[n++], o_owner_uid)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(o_owner_uid); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen<br>(_s); } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN809">809</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN810">810</td><td class="line"> </td></tr>
<tr><td class="num" id="LN811">811</td><td class="line">                        <span class='keyword'>if</span> (cg_path_get_unit(c, &amp;t) &gt;= 0) {</td></tr>
<tr><td class="num" id="LN812">812</td><td class="line">                                x = <span class='macro'>strjoina(<span class='string_literal'>"OBJECT_SYSTEMD_UNIT="</span>, t)<span class='expansion'>({ const char *_appendees_[] = { "OBJECT_SYSTEMD_UNIT=", t };<br> char *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_<br> &lt; __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN813">813</td><td class="line">                                free(t);</td></tr>
<tr><td class="num" id="LN814">814</td><td class="line">                                <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN815">815</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN816">816</td><td class="line"> </td></tr>
<tr><td class="num" id="LN817">817</td><td class="line">                        <span class='keyword'>if</span> (cg_path_get_user_unit(c, &amp;t) &gt;= 0) {</td></tr>
<tr><td class="num" id="LN818">818</td><td class="line">                                x = <span class='macro'>strjoina(<span class='string_literal'>"OBJECT_SYSTEMD_USER_UNIT="</span>, t)<span class='expansion'>({ const char *_appendees_[] = { "OBJECT_SYSTEMD_USER_UNIT=",<br> t }; char *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ =<br> 0; _i_ &lt; __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN819">819</td><td class="line">                                free(t);</td></tr>
<tr><td class="num" id="LN820">820</td><td class="line">                                <span class='macro'>IOVEC_SET_STRING(iovec[n++], x)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(x); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN821">821</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN822">822</td><td class="line"> </td></tr>
<tr><td class="num" id="LN823">823</td><td class="line">                        free(c);</td></tr>
<tr><td class="num" id="LN824">824</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN825">825</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN826">826</td><td class="line">        <span class='macro'>assert(n &lt;= m)<span class='expansion'>do { if ((__builtin_expect(!!(!(n &lt;= m)),0))) log_assert_failed<br>("n &lt;= m", "src/journal/journald-server.c", 826, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN827">827</td><td class="line"> </td></tr>
<tr><td class="num" id="LN828">828</td><td class="line">        <span class='keyword'>if</span> (tv) {</td></tr>
<tr><td class="num" id="LN829">829</td><td class="line">                sprintf(source_time, <span class='string_literal'>"_SOURCE_REALTIME_TIMESTAMP=%llu"</span>, (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) timeval_load(tv));</td></tr>
<tr><td class="num" id="LN830">830</td><td class="line">                <span class='macro'>IOVEC_SET_STRING(iovec[n++], source_time)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(source_time); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen<br>(_s); } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN831">831</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN832">832</td><td class="line"> </td></tr>
<tr><td class="num" id="LN833">833</td><td class="line">        <span class='comment'>/* Note that strictly speaking storing the boot id here is</span></td></tr>
<tr><td class="num" id="LN834">834</td><td class="line">         <span class='comment'>* redundant since the entry includes this in-line</span></td></tr>
<tr><td class="num" id="LN835">835</td><td class="line">         <span class='comment'>* anyway. However, we need this indexed, too. */</span></td></tr>
<tr><td class="num" id="LN836">836</td><td class="line">        <span class='keyword'>if</span> (!isempty(s-&gt;boot_id_field))</td></tr>
<tr><td class="num" id="LN837">837</td><td class="line">                <span class='macro'>IOVEC_SET_STRING(iovec[n++], s-&gt;boot_id_field)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(s-&gt;boot_id_field); _i-&gt;iov_base = _s; _i-&gt;iov_len =<br> strlen(_s); } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN838">838</td><td class="line"> </td></tr>
<tr><td class="num" id="LN839">839</td><td class="line">        <span class='keyword'>if</span> (!isempty(s-&gt;machine_id_field))</td></tr>
<tr><td class="num" id="LN840">840</td><td class="line">                <span class='macro'>IOVEC_SET_STRING(iovec[n++], s-&gt;machine_id_field)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(s-&gt;machine_id_field); _i-&gt;iov_base = _s; _i-&gt;iov_len<br> = strlen(_s); } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN841">841</td><td class="line"> </td></tr>
<tr><td class="num" id="LN842">842</td><td class="line">        <span class='keyword'>if</span> (!isempty(s-&gt;hostname_field))</td></tr>
<tr><td class="num" id="LN843">843</td><td class="line">                <span class='macro'>IOVEC_SET_STRING(iovec[n++], s-&gt;hostname_field)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(s-&gt;hostname_field); _i-&gt;iov_base = _s; _i-&gt;iov_len<br> = strlen(_s); } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN844">844</td><td class="line"> </td></tr>
<tr><td class="num" id="LN845">845</td><td class="line">        <span class='macro'>assert(n &lt;= m)<span class='expansion'>do { if ((__builtin_expect(!!(!(n &lt;= m)),0))) log_assert_failed<br>("n &lt;= m", "src/journal/journald-server.c", 845, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN846">846</td><td class="line"> </td></tr>
<tr><td class="num" id="LN847">847</td><td class="line">        <span class='keyword'>if</span> (s-&gt;split_mode == SPLIT_UID &amp;&amp; realuid &gt; 0)</td></tr>
<tr><td class="num" id="LN848">848</td><td class="line">                <span class='comment'>/* Split up strictly by any UID */</span></td></tr>
<tr><td class="num" id="LN849">849</td><td class="line">                journal_uid = realuid;</td></tr>
<tr><td class="num" id="LN850">850</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (s-&gt;split_mode == SPLIT_LOGIN &amp;&amp; realuid &gt; 0 &amp;&amp; owner_valid &amp;&amp; owner &gt; 0)</td></tr>
<tr><td class="num" id="LN851">851</td><td class="line">                <span class='comment'>/* Split up by login UIDs.  We do this only if the</span></td></tr>
<tr><td class="num" id="LN852">852</td><td class="line">                 <span class='comment'>* realuid is not root, in order not to accidentally</span></td></tr>
<tr><td class="num" id="LN853">853</td><td class="line">                 <span class='comment'>* leak privileged information to the user that is</span></td></tr>
<tr><td class="num" id="LN854">854</td><td class="line">                 <span class='comment'>* logged by a privileged process that is part of an</span></td></tr>
<tr><td class="num" id="LN855">855</td><td class="line">                 <span class='comment'>* unprivileged session. */</span></td></tr>
<tr><td class="num" id="LN856">856</td><td class="line">                journal_uid = owner;</td></tr>
<tr><td class="num" id="LN857">857</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr><td class="num" id="LN858">858</td><td class="line">                journal_uid = 0;</td></tr>
<tr><td class="num" id="LN859">859</td><td class="line"> </td></tr>
<tr><td class="num" id="LN860">860</td><td class="line">        write_to_journal(s, journal_uid, iovec, n, priority);</td></tr>
<tr><td class="num" id="LN861">861</td><td class="line">}</td></tr>
<tr><td class="num" id="LN862">862</td><td class="line"> </td></tr>
<tr><td class="num" id="LN863">863</td><td class="line"><span class='keyword'>void</span> server_driver_message(Server *s, sd_id128_t message_id, <span class='keyword'>const</span> <span class='keyword'>char</span> *format, ...) {</td></tr>
<tr><td class="num" id="LN864">864</td><td class="line">        <span class='keyword'>char</span> mid[11 + 32 + 1];</td></tr>
<tr><td class="num" id="LN865">865</td><td class="line">        <span class='keyword'>struct</span> iovec iovec[<span class='macro'>N_IOVEC_META_FIELDS<span class='expansion'>20</span></span> + 5 + <span class='macro'>N_IOVEC_PAYLOAD_FIELDS<span class='expansion'>15</span></span>];</td></tr>
<tr><td class="num" id="LN866">866</td><td class="line">        <span class='keyword'>unsigned</span> n = 0, m;</td></tr>
<tr><td class="num" id="LN867">867</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN868">868</td><td class="line">        va_list ap;</td></tr>
<tr><td class="num" id="LN869">869</td><td class="line">        <span class='keyword'>struct</span> ucred ucred = {};</td></tr>
<tr><td class="num" id="LN870">870</td><td class="line"> </td></tr>
<tr><td class="num" id="LN871">871</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 871, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN872">872</td><td class="line">        <span class='macro'>assert(format)<span class='expansion'>do { if ((__builtin_expect(!!(!(format)),0))) log_assert_failed<br>("format", "src/journal/journald-server.c", 872, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN873">873</td><td class="line"> </td></tr>
<tr><td class="num" id="LN874">874</td><td class="line">        <span class='macro'>assert_cc(3 == LOG_FAC(LOG_DAEMON))<span class='expansion'>GCC diagnostic push
; GCC diagnostic ignored "-Wdeclaration-after-statement"<br>
; _Static_assert(3 == ((((3&lt;&lt;3)) &amp; 0x03f8) &gt;&gt;<br> 3), "3 == LOG_FAC(LOG_DAEMON)"); GCC diagnostic pop
</span></span>;</td></tr>
<tr><td class="num" id="LN875">875</td><td class="line">        <span class='macro'>IOVEC_SET_STRING(iovec[n++], <span class='string_literal'>"SYSLOG_FACILITY=3"</span>)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)("SYSLOG_FACILITY=3"); _i-&gt;iov_base = _s; _i-&gt;iov_len =<br> strlen(_s); } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN876">876</td><td class="line">        <span class='macro'>IOVEC_SET_STRING(iovec[n++], <span class='string_literal'>"SYSLOG_IDENTIFIER=systemd-journald"</span>)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)("SYSLOG_IDENTIFIER=systemd-journald"); _i-&gt;iov_base = _s<br>; _i-&gt;iov_len = strlen(_s); } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN877">877</td><td class="line"> </td></tr>
<tr><td class="num" id="LN878">878</td><td class="line">        <span class='macro'>IOVEC_SET_STRING(iovec[n++], <span class='string_literal'>"_TRANSPORT=driver"</span>)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)("_TRANSPORT=driver"); _i-&gt;iov_base = _s; _i-&gt;iov_len =<br> strlen(_s); } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN879">879</td><td class="line">        <span class='macro'>assert_cc(6 == LOG_INFO)<span class='expansion'>GCC diagnostic push
; GCC diagnostic ignored "-Wdeclaration-after-statement"<br>
; _Static_assert(6 == 6, "6 == LOG_INFO"); GCC diagnostic pop<br>
</span></span>;</td></tr>
<tr><td class="num" id="LN880">880</td><td class="line">        <span class='macro'>IOVEC_SET_STRING(iovec[n++], <span class='string_literal'>"PRIORITY=6"</span>)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)("PRIORITY=6"); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen<br>(_s); } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN881">881</td><td class="line"> </td></tr>
<tr><td class="num" id="LN882">882</td><td class="line">        <span class='keyword'>if</span> (!sd_id128_equal(message_id, <span class='macro'>SD_ID128_NULL<span class='expansion'>((const sd_id128_t) { .qwords = { 0, 0 }})</span></span>)) {</td></tr>
<tr><td class="num" id="LN883">883</td><td class="line">                snprintf(mid, <span class='keyword'>sizeof</span>(mid), <span class='macro'>LOG_MESSAGE_ID(message_id)<span class='expansion'>"MESSAGE_ID=" "%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x"<br>, (message_id).bytes[0], (message_id).bytes[1], (message_id).<br>bytes[2], (message_id).bytes[3], (message_id).bytes[4], (message_id<br>).bytes[5], (message_id).bytes[6], (message_id).bytes[7], (message_id<br>).bytes[8], (message_id).bytes[9], (message_id).bytes[10], (message_id<br>).bytes[11], (message_id).bytes[12], (message_id).bytes[13], (<br>message_id).bytes[14], (message_id).bytes[15]</span></span>);</td></tr>
<tr><td class="num" id="LN884">884</td><td class="line">                <span class='macro'>IOVEC_SET_STRING(iovec[n++], mid)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(mid); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN885">885</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN886">886</td><td class="line"> </td></tr>
<tr><td class="num" id="LN887">887</td><td class="line">        m = n;</td></tr>
<tr><td class="num" id="LN888">888</td><td class="line"> </td></tr>
<tr><td class="num" id="LN889">889</td><td class="line">        <span class='macro'>va_start(ap, format)<span class='expansion'>__builtin_va_start(ap, format)</span></span>;</td></tr>
<tr><td class="num" id="LN890">890</td><td class="line">        r = log_format_iovec(iovec, <span class='macro'>ELEMENTSOF(iovec)<span class='expansion'>__extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(iovec), typeof(&amp;*(iovec))), sizeof(iovec)/sizeof(<br>(iovec)[0]), (void)0))</span></span>, &amp;n, <span class='macro'>false<span class='expansion'>0</span></span>, 0, format, ap);</td></tr>
<tr><td class="num" id="LN891">891</td><td class="line">        <span class='comment'>/* Error handling below */</span></td></tr>
<tr><td class="num" id="LN892">892</td><td class="line">        <span class='macro'>va_end(ap)<span class='expansion'>__builtin_va_end(ap)</span></span>;</td></tr>
<tr><td class="num" id="LN893">893</td><td class="line"> </td></tr>
<tr><td class="num" id="LN894">894</td><td class="line">        ucred.pid = getpid();</td></tr>
<tr><td class="num" id="LN895">895</td><td class="line">        ucred.uid = getuid();</td></tr>
<tr><td class="num" id="LN896">896</td><td class="line">        ucred.gid = getgid();</td></tr>
<tr><td class="num" id="LN897">897</td><td class="line"> </td></tr>
<tr><td class="num" id="LN898">898</td><td class="line">        <span class='keyword'>if</span> (r &gt;= 0)</td></tr>
<tr><td class="num" id="LN899">899</td><td class="line">                dispatch_message_real(s, iovec, n, <span class='macro'>ELEMENTSOF(iovec)<span class='expansion'>__extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(iovec), typeof(&amp;*(iovec))), sizeof(iovec)/sizeof(<br>(iovec)[0]), (void)0))</span></span>, &amp;ucred, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, 0, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, <span class='macro'>LOG_INFO<span class='expansion'>6</span></span>, 0);</td></tr>
<tr><td class="num" id="LN900">900</td><td class="line"> </td></tr>
<tr><td class="num" id="LN901">901</td><td class="line">        <span class='keyword'>while</span> (m &lt; n)</td></tr>
<tr><td class="num" id="LN902">902</td><td class="line">                free(iovec[m++].iov_base);</td></tr>
<tr><td class="num" id="LN903">903</td><td class="line"> </td></tr>
<tr><td class="num" id="LN904">904</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0) {</td></tr>
<tr><td class="num" id="LN905">905</td><td class="line">                <span class='comment'>/* We failed to format the message. Emit a warning instead. */</span></td></tr>
<tr><td class="num" id="LN906">906</td><td class="line">                <span class='keyword'>char</span> buf[<span class='macro'>LINE_MAX<span class='expansion'>2048</span></span>];</td></tr>
<tr><td class="num" id="LN907">907</td><td class="line"> </td></tr>
<tr><td class="num" id="LN908">908</td><td class="line">                <span class='macro'>xsprintf(buf, <span class='string_literal'>"MESSAGE=Entry printing failed: %s"</span>, strerror(-r))<span class='expansion'>do { if ((__builtin_expect(!!(!((size_t) snprintf(buf, __extension__<br> (__builtin_choose_expr( !__builtin_types_compatible_p(typeof<br>(buf), typeof(&amp;*(buf))), sizeof(buf)/sizeof((buf)[0]), (void<br>)0)), "MESSAGE=Entry printing failed: %s", strerror(-r)) &lt;<br> __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(buf), typeof(&amp;*(buf))), sizeof(buf)/sizeof((buf)[<br>0]), (void)0)))),0))) log_assert_failed("xsprintf: " "buf" "[] must be big enough"<br>, "src/journal/journald-server.c", 908, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN909">909</td><td class="line"> </td></tr>
<tr><td class="num" id="LN910">910</td><td class="line">                n = 3;</td></tr>
<tr><td class="num" id="LN911">911</td><td class="line">                <span class='macro'>IOVEC_SET_STRING(iovec[n++], <span class='string_literal'>"PRIORITY=4"</span>)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)("PRIORITY=4"); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen<br>(_s); } while(0)</span></span>;</td></tr>
<tr><td class="num" id="LN912">912</td><td class="line">                <span class='macro'>IOVEC_SET_STRING(iovec[n++], buf)<span class='expansion'>do { struct iovec *_i = &amp;(iovec[n++]); char *_s = (char *<br>)(buf); _i-&gt;iov_base = _s; _i-&gt;iov_len = strlen(_s); } while<br>(0)</span></span>;</td></tr>
<tr><td class="num" id="LN913">913</td><td class="line">                dispatch_message_real(s, iovec, n, <span class='macro'>ELEMENTSOF(iovec)<span class='expansion'>__extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(iovec), typeof(&amp;*(iovec))), sizeof(iovec)/sizeof(<br>(iovec)[0]), (void)0))</span></span>, &amp;ucred, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, 0, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, <span class='macro'>LOG_INFO<span class='expansion'>6</span></span>, 0);</td></tr>
<tr><td class="num" id="LN914">914</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN915">915</td><td class="line">}</td></tr>
<tr><td class="num" id="LN916">916</td><td class="line"> </td></tr>
<tr><td class="num" id="LN917">917</td><td class="line"><span class='keyword'>void</span> server_dispatch_message(</td></tr>
<tr><td class="num" id="LN918">918</td><td class="line">                Server *s,</td></tr>
<tr><td class="num" id="LN919">919</td><td class="line">                <span class='keyword'>struct</span> iovec *iovec, <span class='keyword'>unsigned</span> n, <span class='keyword'>unsigned</span> m,</td></tr>
<tr><td class="num" id="LN920">920</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>struct</span> ucred *ucred,</td></tr>
<tr><td class="num" id="LN921">921</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>struct</span> timeval *tv,</td></tr>
<tr><td class="num" id="LN922">922</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>char</span> *label, size_t label_len,</td></tr>
<tr><td class="num" id="LN923">923</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>char</span> *unit_id,</td></tr>
<tr><td class="num" id="LN924">924</td><td class="line">                <span class='keyword'>int</span> priority,</td></tr>
<tr><td class="num" id="LN925">925</td><td class="line">                pid_t object_pid) {</td></tr>
<tr><td class="num" id="LN926">926</td><td class="line"> </td></tr>
<tr><td class="num" id="LN927">927</td><td class="line">        <span class='keyword'>int</span> rl, r;</td></tr>
<tr><td class="num" id="LN928">928</td><td class="line">        <span class='macro'>_cleanup_free_<span class='expansion'>__attribute__((cleanup(freep)))</span></span> <span class='keyword'>char</span> *path = <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>;</td></tr>
<tr><td class="num" id="LN929">929</td><td class="line">        uint64_t available = 0;</td></tr>
<tr><td class="num" id="LN930">930</td><td class="line">        <span class='keyword'>char</span> *c;</td></tr>
<tr><td class="num" id="LN931">931</td><td class="line"> </td></tr>
<tr><td class="num" id="LN932">932</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 932, __PRETTY_FUNCTION__);<br> } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN933">933</td><td class="line">        <span class='macro'>assert(iovec || n == 0)<span class='expansion'>do { if ((__builtin_expect(!!(!(iovec || n == 0)),0))) log_assert_failed<br>("iovec || n == 0", "src/journal/journald-server.c", 933, __PRETTY_FUNCTION__<br>); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN934">934</td><td class="line"> </td></tr>
<tr><td class="num" id="LN935">935</td><td class="line">        <span class='keyword'>if</span> (n == 0)</td></tr>
<tr><td class="num" id="LN936">936</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr><td class="num" id="LN937">937</td><td class="line"> </td></tr>
<tr><td class="num" id="LN938">938</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>LOG_PRI(priority)<span class='expansion'>((priority) &amp; 0x07)</span></span> &gt; s-&gt;max_level_store)</td></tr>
<tr><td class="num" id="LN939">939</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr><td class="num" id="LN940">940</td><td class="line"> </td></tr>
<tr><td class="num" id="LN941">941</td><td class="line">        <span class='comment'>/* Stop early in case the information will not be stored</span></td></tr>
<tr><td class="num" id="LN942">942</td><td class="line">         <span class='comment'>* in a journal. */</span></td></tr>
<tr><td class="num" id="LN943">943</td><td class="line">        <span class='keyword'>if</span> (s-&gt;storage == STORAGE_NONE)</td></tr>
<tr><td class="num" id="LN944">944</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr><td class="num" id="LN945">945</td><td class="line"> </td></tr>
<tr><td class="num" id="LN946">946</td><td class="line">        <span class='keyword'>if</span> (!ucred)</td></tr>
<tr><td class="num" id="LN947">947</td><td class="line">                <span class='keyword'>goto</span> finish;</td></tr>
<tr><td class="num" id="LN948">948</td><td class="line"> </td></tr>
<tr><td class="num" id="LN949">949</td><td class="line">        r = cg_pid_get_path_shifted(ucred-&gt;pid, s-&gt;cgroup_root, &amp;path);</td></tr>
<tr><td class="num" id="LN950">950</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN951">951</td><td class="line">                <span class='keyword'>goto</span> finish;</td></tr>
<tr><td class="num" id="LN952">952</td><td class="line"> </td></tr>
<tr><td class="num" id="LN953">953</td><td class="line">        <span class='comment'>/* example: /user/lennart/3/foobar</span></td></tr>
<tr><td class="num" id="LN954">954</td><td class="line">         <span class='comment'>*          /system/dbus.service/foobar</span></td></tr>
<tr><td class="num" id="LN955">955</td><td class="line">         <span class='comment'>*</span></td></tr>
<tr><td class="num" id="LN956">956</td><td class="line">         <span class='comment'>* So let's cut of everything past the third /, since that is</span></td></tr>
<tr><td class="num" id="LN957">957</td><td class="line">         <span class='comment'>* where user directories start */</span></td></tr>
<tr><td class="num" id="LN958">958</td><td class="line"> </td></tr>
<tr><td class="num" id="LN959">959</td><td class="line">        c = strchr(path, '/');</td></tr>
<tr><td class="num" id="LN960">960</td><td class="line">        <span class='keyword'>if</span> (c) {</td></tr>
<tr><td class="num" id="LN961">961</td><td class="line">                c = strchr(c+1, '/');</td></tr>
<tr><td class="num" id="LN962">962</td><td class="line">                <span class='keyword'>if</span> (c) {</td></tr>
<tr><td class="num" id="LN963">963</td><td class="line">                        c = strchr(c+1, '/');</td></tr>
<tr><td class="num" id="LN964">964</td><td class="line">                        <span class='keyword'>if</span> (c)</td></tr>
<tr><td class="num" id="LN965">965</td><td class="line">                                *c = 0;</td></tr>
<tr><td class="num" id="LN966">966</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN967">967</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN968">968</td><td class="line"> </td></tr>
<tr><td class="num" id="LN969">969</td><td class="line">        (<span class='keyword'>void</span>) determine_space(s, <span class='macro'>false<span class='expansion'>0</span></span>, <span class='macro'>false<span class='expansion'>0</span></span>, &amp;available, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>);</td></tr>
<tr><td class="num" id="LN970">970</td><td class="line">        rl = journal_rate_limit_test(s-&gt;rate_limit, path, priority &amp; <span class='macro'>LOG_PRIMASK<span class='expansion'>0x07</span></span>, available);</td></tr>
<tr><td class="num" id="LN971">971</td><td class="line">        <span class='keyword'>if</span> (rl == 0)</td></tr>
<tr><td class="num" id="LN972">972</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr><td class="num" id="LN973">973</td><td class="line"> </td></tr>
<tr><td class="num" id="LN974">974</td><td class="line">        <span class='comment'>/* Write a suppression message if we suppressed something */</span></td></tr>
<tr><td class="num" id="LN975">975</td><td class="line">        <span class='keyword'>if</span> (rl &gt; 1)</td></tr>
<tr><td class="num" id="LN976">976</td><td class="line">                server_driver_message(s, <span class='macro'>SD_MESSAGE_JOURNAL_DROPPED<span class='expansion'>((const sd_id128_t) { .bytes = { 0xa5, 0x96, 0xd6, 0xfe, 0x7b<br>, 0xfa, 0x49, 0x94, 0x82, 0x8e, 0x72, 0x30, 0x9e, 0x95, 0xd6,<br> 0x1e }})</span></span>,</td></tr>
<tr><td class="num" id="LN977">977</td><td class="line">                                      <span class='macro'>LOG_MESSAGE(<span class='string_literal'>"Suppressed %u messages from %s"</span>, rl - 1, path)<span class='expansion'>"MESSAGE=" "Suppressed %u messages from %s", rl - 1, path</span></span>,</td></tr>
<tr><td class="num" id="LN978">978</td><td class="line">                                      <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>);</td></tr>
<tr><td class="num" id="LN979">979</td><td class="line"> </td></tr>
<tr><td class="num" id="LN980">980</td><td class="line">finish:</td></tr>
<tr><td class="num" id="LN981">981</td><td class="line">        dispatch_message_real(s, iovec, n, m, ucred, tv, label, label_len, unit_id, priority, object_pid);</td></tr>
<tr><td class="num" id="LN982">982</td><td class="line">}</td></tr>
<tr><td class="num" id="LN983">983</td><td class="line"> </td></tr>
<tr><td class="num" id="LN984">984</td><td class="line"> </td></tr>
<tr><td class="num" id="LN985">985</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> system_journal_open(Server *s, <span class='macro'>bool<span class='expansion'>_Bool</span></span> flush_requested) {</td></tr>
<tr><td class="num" id="LN986">986</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span> *fn;</td></tr>
<tr><td class="num" id="LN987">987</td><td class="line">        <span class='keyword'>int</span> r = 0;</td></tr>
<tr><td class="num" id="LN988">988</td><td class="line"> </td></tr>
<tr><td class="num" id="LN989">989</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;system_journal &amp;&amp;</td></tr>
<tr><td class="num" id="LN990">990</td><td class="line">            (s-&gt;storage == STORAGE_PERSISTENT || s-&gt;storage == STORAGE_AUTO) &amp;&amp;</td></tr>
<tr><td class="num" id="LN991">991</td><td class="line">            (flush_requested</td></tr>
<tr><td class="num" id="LN992">992</td><td class="line">             || access(<span class='string_literal'>"/run/systemd/journal/flushed"</span>, <span class='macro'>F_OK<span class='expansion'>0</span></span>) &gt;= 0)) {</td></tr>
<tr><td class="num" id="LN993">993</td><td class="line"> </td></tr>
<tr><td class="num" id="LN994">994</td><td class="line">                <span class='comment'>/* If in auto mode: first try to create the machine</span></td></tr>
<tr><td class="num" id="LN995">995</td><td class="line">                 <span class='comment'>* path, but not the prefix.</span></td></tr>
<tr><td class="num" id="LN996">996</td><td class="line">                 <span class='comment'>*</span></td></tr>
<tr><td class="num" id="LN997">997</td><td class="line">                 <span class='comment'>* If in persistent mode: create /var/log/journal and</span></td></tr>
<tr><td class="num" id="LN998">998</td><td class="line">                 <span class='comment'>* the machine path */</span></td></tr>
<tr><td class="num" id="LN999">999</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1000">1000</td><td class="line">                <span class='keyword'>if</span> (s-&gt;storage == STORAGE_PERSISTENT)</td></tr>
<tr><td class="num" id="LN1001">1001</td><td class="line">                        (<span class='keyword'>void</span>) mkdir_p(<span class='string_literal'>"/var/log/journal/"</span>, 0755);</td></tr>
<tr><td class="num" id="LN1002">1002</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1003">1003</td><td class="line">                fn = <span class='macro'>strjoina(<span class='string_literal'>"/var/log/journal/"</span>, SERVER_MACHINE_ID(s))<span class='expansion'>({ const char *_appendees_[] = { "/var/log/journal/", ((s)-&gt;<br>machine_id_field + strlen("_MACHINE_ID=")) }; char *_d_, *_p_<br>; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_ &lt; __extension__<br> (__builtin_choose_expr( !__builtin_types_compatible_p(typeof<br>(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN1004">1004</td><td class="line">                (<span class='keyword'>void</span>) mkdir(fn, 0755);</td></tr>
<tr><td class="num" id="LN1005">1005</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1006">1006</td><td class="line">                fn = <span class='macro'>strjoina(fn, <span class='string_literal'>"/system.journal"</span>)<span class='expansion'>({ const char *_appendees_[] = { fn, "/system.journal" }; char<br> *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0; _i_ &lt;<br> __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN1007">1007</td><td class="line">                r = open_journal(s, <span class='macro'>true<span class='expansion'>1</span></span>, fn, <span class='macro'>O_RDWR<span class='expansion'>02</span></span>|<span class='macro'>O_CREAT<span class='expansion'>0100</span></span>, s-&gt;seal, &amp;s-&gt;system_metrics, &amp;s-&gt;system_journal);</td></tr>
<tr><td class="num" id="LN1008">1008</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0) {</td></tr>
<tr><td class="num" id="LN1009">1009</td><td class="line">                        server_add_acls(s-&gt;system_journal, 0);</td></tr>
<tr><td class="num" id="LN1010">1010</td><td class="line">                        (<span class='keyword'>void</span>) determine_space_for(s, &amp;s-&gt;system_metrics, <span class='string_literal'>"/var/log/journal/"</span>, <span class='string_literal'>"System journal"</span>, <span class='macro'>true<span class='expansion'>1</span></span>, <span class='macro'>true<span class='expansion'>1</span></span>, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>);</td></tr>
<tr><td class="num" id="LN1011">1011</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (r &lt; 0) {</td></tr>
<tr><td class="num" id="LN1012">1012</td><td class="line">                        <span class='keyword'>if</span> (r != -<span class='macro'>ENOENT<span class='expansion'>2</span></span> &amp;&amp; r != -<span class='macro'>EROFS<span class='expansion'>30</span></span>)</td></tr>
<tr><td class="num" id="LN1013">1013</td><td class="line">                                <span class='macro'>log_warning_errno(r, <span class='string_literal'>"Failed to open system journal: %m"</span>)<span class='expansion'>({ int _level = (4), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1013, __func__, "Failed to open system journal: %m") : -abs<br>(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1014">1014</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1015">1015</td><td class="line">                        r = 0;</td></tr>
<tr><td class="num" id="LN1016">1016</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN1017">1017</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1018">1018</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1019">1019</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;runtime_journal &amp;&amp;</td></tr>
<tr><td class="num" id="LN1020">1020</td><td class="line">            (s-&gt;storage != STORAGE_NONE)) {</td></tr>
<tr><td class="num" id="LN1021">1021</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1022">1022</td><td class="line">                fn = <span class='macro'>strjoina(<span class='string_literal'>"/run/log/journal/"</span>, SERVER_MACHINE_ID(s), <span class='string_literal'>"/system.journal"</span>)<span class='expansion'>({ const char *_appendees_[] = { "/run/log/journal/", ((s)-&gt;<br>machine_id_field + strlen("_MACHINE_ID=")), "/system.journal"<br> }; char *_d_, *_p_; int _len_ = 0; unsigned _i_; for (_i_ = 0<br>; _i_ &lt; __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(_appendees_), typeof(&amp;*(_appendees_))), sizeof(_appendees_<br>)/sizeof((_appendees_)[0]), (void)0)) &amp;&amp; _appendees_[<br>_i_]; _i_++) _len_ += strlen(_appendees_[_i_]); _p_ = _d_ = __builtin_alloca<br> (_len_ + 1); for (_i_ = 0; _i_ &lt; __extension__ (__builtin_choose_expr<br>( !__builtin_types_compatible_p(typeof(_appendees_), typeof(&amp;<br>*(_appendees_))), sizeof(_appendees_)/sizeof((_appendees_)[0]<br>), (void)0)) &amp;&amp; _appendees_[_i_]; _i_++) _p_ = stpcpy<br>(_p_, _appendees_[_i_]); *_p_ = 0; _d_; })</span></span>;</td></tr>
<tr><td class="num" id="LN1023">1023</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1024">1024</td><td class="line">                <span class='keyword'>if</span> (s-&gt;system_journal) {</td></tr>
<tr><td class="num" id="LN1025">1025</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1026">1026</td><td class="line">                        <span class='comment'>/* Try to open the runtime journal, but only</span></td></tr>
<tr><td class="num" id="LN1027">1027</td><td class="line">                         <span class='comment'>* if it already exists, so that we can flush</span></td></tr>
<tr><td class="num" id="LN1028">1028</td><td class="line">                         <span class='comment'>* it into the system journal */</span></td></tr>
<tr><td class="num" id="LN1029">1029</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1030">1030</td><td class="line">                        r = open_journal(s, <span class='macro'>false<span class='expansion'>0</span></span>, fn, <span class='macro'>O_RDWR<span class='expansion'>02</span></span>, <span class='macro'>false<span class='expansion'>0</span></span>, &amp;s-&gt;runtime_metrics, &amp;s-&gt;runtime_journal);</td></tr>
<tr><td class="num" id="LN1031">1031</td><td class="line">                        <span class='keyword'>if</span> (r &lt; 0) {</td></tr>
<tr><td class="num" id="LN1032">1032</td><td class="line">                                <span class='keyword'>if</span> (r != -<span class='macro'>ENOENT<span class='expansion'>2</span></span>)</td></tr>
<tr><td class="num" id="LN1033">1033</td><td class="line">                                        <span class='macro'>log_warning_errno(r, <span class='string_literal'>"Failed to open runtime journal: %m"</span>)<span class='expansion'>({ int _level = (4), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1033, __func__, "Failed to open runtime journal: %m") : -abs<br>(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1034">1034</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1035">1035</td><td class="line">                                r = 0;</td></tr>
<tr><td class="num" id="LN1036">1036</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN1037">1037</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1038">1038</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr><td class="num" id="LN1039">1039</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1040">1040</td><td class="line">                        <span class='comment'>/* OK, we really need the runtime journal, so create</span></td></tr>
<tr><td class="num" id="LN1041">1041</td><td class="line">                         <span class='comment'>* it if necessary. */</span></td></tr>
<tr><td class="num" id="LN1042">1042</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1043">1043</td><td class="line">                        (<span class='keyword'>void</span>) mkdir(<span class='string_literal'>"/run/log"</span>, 0755);</td></tr>
<tr><td class="num" id="LN1044">1044</td><td class="line">                        (<span class='keyword'>void</span>) mkdir(<span class='string_literal'>"/run/log/journal"</span>, 0755);</td></tr>
<tr><td class="num" id="LN1045">1045</td><td class="line">                        (<span class='keyword'>void</span>) mkdir_parents(fn, 0750);</td></tr>
<tr><td class="num" id="LN1046">1046</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1047">1047</td><td class="line">                        r = open_journal(s, <span class='macro'>true<span class='expansion'>1</span></span>, fn, <span class='macro'>O_RDWR<span class='expansion'>02</span></span>|<span class='macro'>O_CREAT<span class='expansion'>0100</span></span>, <span class='macro'>false<span class='expansion'>0</span></span>, &amp;s-&gt;runtime_metrics, &amp;s-&gt;runtime_journal);</td></tr>
<tr><td class="num" id="LN1048">1048</td><td class="line">                        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1049">1049</td><td class="line">                                <span class='keyword'>return</span> <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to open runtime journal: %m"</span>)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1049, __func__, "Failed to open runtime journal: %m") : -abs<br>(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1050">1050</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN1051">1051</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1052">1052</td><td class="line">                <span class='keyword'>if</span> (s-&gt;runtime_journal) {</td></tr>
<tr><td class="num" id="LN1053">1053</td><td class="line">                        server_add_acls(s-&gt;runtime_journal, 0);</td></tr>
<tr><td class="num" id="LN1054">1054</td><td class="line">                        (<span class='keyword'>void</span>) determine_space_for(s, &amp;s-&gt;runtime_metrics, <span class='string_literal'>"/run/log/journal/"</span>, <span class='string_literal'>"Runtime journal"</span>, <span class='macro'>true<span class='expansion'>1</span></span>, <span class='macro'>true<span class='expansion'>1</span></span>, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>);</td></tr>
<tr><td class="num" id="LN1055">1055</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN1056">1056</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1057">1057</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1058">1058</td><td class="line">        <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1059">1059</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1060">1060</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1061">1061</td><td class="line"><span class='keyword'>int</span> server_flush_to_var(Server *s) {</td></tr>
<tr><td class="num" id="LN1062">1062</td><td class="line">        sd_id128_t machine;</td></tr>
<tr><td class="num" id="LN1063">1063</td><td class="line">        sd_journal *j = <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>;</td></tr>
<tr><td class="num" id="LN1064">1064</td><td class="line">        <span class='keyword'>char</span> ts[<span class='macro'>FORMAT_TIMESPAN_MAX<span class='expansion'>64</span></span>];</td></tr>
<tr><td class="num" id="LN1065">1065</td><td class="line">        usec_t start;</td></tr>
<tr><td class="num" id="LN1066">1066</td><td class="line">        <span class='keyword'>unsigned</span> n = 0;</td></tr>
<tr><td class="num" id="LN1067">1067</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN1068">1068</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1069">1069</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1069, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1070">1070</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1071">1071</td><td class="line">        <span class='keyword'>if</span> (s-&gt;storage != STORAGE_AUTO &amp;&amp;</td></tr>
<tr><td class="num" id="LN1072">1072</td><td class="line">            s-&gt;storage != STORAGE_PERSISTENT)</td></tr>
<tr><td class="num" id="LN1073">1073</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1074">1074</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1075">1075</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;runtime_journal)</td></tr>
<tr><td class="num" id="LN1076">1076</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1077">1077</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1078">1078</td><td class="line">        (<span class='keyword'>void</span>) system_journal_open(s, <span class='macro'>true<span class='expansion'>1</span></span>);</td></tr>
<tr><td class="num" id="LN1079">1079</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1080">1080</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;system_journal)</td></tr>
<tr><td class="num" id="LN1081">1081</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1082">1082</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1083">1083</td><td class="line">        <span class='macro'>log_debug(<span class='string_literal'>"Flushing to /var..."</span>)<span class='expansion'>({ int _level = (7), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1083, __func__, "Flushing to /var...") : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1084">1084</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1085">1085</td><td class="line">        start = now(<span class='macro'>CLOCK_MONOTONIC<span class='expansion'>1</span></span>);</td></tr>
<tr><td class="num" id="LN1086">1086</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1087">1087</td><td class="line">        r = sd_id128_get_machine(&amp;machine);</td></tr>
<tr><td class="num" id="LN1088">1088</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1089">1089</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1090">1090</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1091">1091</td><td class="line">        r = sd_journal_open(&amp;j, SD_JOURNAL_RUNTIME_ONLY);</td></tr>
<tr><td class="num" id="LN1092">1092</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1093">1093</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to read runtime journal: %m"</span>)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1093, __func__, "Failed to read runtime journal: %m") : -abs<br>(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1094">1094</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1095">1095</td><td class="line">        sd_journal_set_data_threshold(j, 0);</td></tr>
<tr><td class="num" id="LN1096">1096</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1097">1097</td><td class="line">        <span class='macro'>SD_JOURNAL_FOREACH(j)<span class='expansion'>if (sd_journal_seek_head(j) &lt; 0) { } else while (sd_journal_next<br>(j) &gt; 0)</span></span> {</td></tr>
<tr><td class="num" id="LN1098">1098</td><td class="line">                Object *o = <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>;</td></tr>
<tr><td class="num" id="LN1099">1099</td><td class="line">                JournalFile *f;</td></tr>
<tr><td class="num" id="LN1100">1100</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1101">1101</td><td class="line">                f = j-&gt;current_file;</td></tr>
<tr><td class="num" id="LN1102">1102</td><td class="line">                <span class='macro'>assert(f &amp;&amp; f-&gt;current_offset &gt; 0)<span class='expansion'>do { if ((__builtin_expect(!!(!(f &amp;&amp; f-&gt;current_offset<br> &gt; 0)),0))) log_assert_failed("f &amp;&amp; f-&gt;current_offset &gt; 0"<br>, "src/journal/journald-server.c", 1102, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1103">1103</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1104">1104</td><td class="line">                n++;</td></tr>
<tr><td class="num" id="LN1105">1105</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1106">1106</td><td class="line">                r = journal_file_move_to_object(f, OBJECT_ENTRY, f-&gt;current_offset, &amp;o);</td></tr>
<tr><td class="num" id="LN1107">1107</td><td class="line">                <span class='keyword'>if</span> (r &lt; 0) {</td></tr>
<tr><td class="num" id="LN1108">1108</td><td class="line">                        <span class='macro'>log_error_errno(r, <span class='string_literal'>"Can't read entry: %m"</span>)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1108, __func__, "Can't read entry: %m") : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1109">1109</td><td class="line">                        <span class='keyword'>goto</span> finish;</td></tr>
<tr><td class="num" id="LN1110">1110</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN1111">1111</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1112">1112</td><td class="line">                r = journal_file_copy_entry(f, s-&gt;system_journal, o, f-&gt;current_offset, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>);</td></tr>
<tr><td class="num" id="LN1113">1113</td><td class="line">                <span class='keyword'>if</span> (r &gt;= 0)</td></tr>
<tr><td class="num" id="LN1114">1114</td><td class="line">                        <span class='keyword'>continue</span>;</td></tr>
<tr><td class="num" id="LN1115">1115</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1116">1116</td><td class="line">                <span class='keyword'>if</span> (!shall_try_append_again(s-&gt;system_journal, r)) {</td></tr>
<tr><td class="num" id="LN1117">1117</td><td class="line">                        <span class='macro'>log_error_errno(r, <span class='string_literal'>"Can't write entry: %m"</span>)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1117, __func__, "Can't write entry: %m") : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1118">1118</td><td class="line">                        <span class='keyword'>goto</span> finish;</td></tr>
<tr><td class="num" id="LN1119">1119</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN1120">1120</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1121">1121</td><td class="line">                server_rotate(s);</td></tr>
<tr><td class="num" id="LN1122">1122</td><td class="line">                server_vacuum(s, <span class='macro'>false<span class='expansion'>0</span></span>, <span class='macro'>false<span class='expansion'>0</span></span>);</td></tr>
<tr><td class="num" id="LN1123">1123</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1124">1124</td><td class="line">                <span class='keyword'>if</span> (!s-&gt;system_journal) {</td></tr>
<tr><td class="num" id="LN1125">1125</td><td class="line">                        <span class='macro'>log_notice(<span class='string_literal'>"Didn't flush runtime journal since rotation of system journal wasn't successful."</span>)<span class='expansion'>({ int _level = (5), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1125, __func__, "Didn't flush runtime journal since rotation of system journal wasn't successful."<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1126">1126</td><td class="line">                        r = -<span class='macro'>EIO<span class='expansion'>5</span></span>;</td></tr>
<tr><td class="num" id="LN1127">1127</td><td class="line">                        <span class='keyword'>goto</span> finish;</td></tr>
<tr><td class="num" id="LN1128">1128</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN1129">1129</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1130">1130</td><td class="line">                <span class='macro'>log_debug(<span class='string_literal'>"Retrying write."</span>)<span class='expansion'>({ int _level = (7), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1130, __func__, "Retrying write.") : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1131">1131</td><td class="line">                r = journal_file_copy_entry(f, s-&gt;system_journal, o, f-&gt;current_offset, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>);</td></tr>
<tr><td class="num" id="LN1132">1132</td><td class="line">                <span class='keyword'>if</span> (r &lt; 0) {</td></tr>
<tr><td class="num" id="LN1133">1133</td><td class="line">                        <span class='macro'>log_error_errno(r, <span class='string_literal'>"Can't write entry: %m"</span>)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1133, __func__, "Can't write entry: %m") : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1134">1134</td><td class="line">                        <span class='keyword'>goto</span> finish;</td></tr>
<tr><td class="num" id="LN1135">1135</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN1136">1136</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1137">1137</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1138">1138</td><td class="line">        r = 0;</td></tr>
<tr><td class="num" id="LN1139">1139</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1140">1140</td><td class="line">finish:</td></tr>
<tr><td class="num" id="LN1141">1141</td><td class="line">        journal_file_post_change(s-&gt;system_journal);</td></tr>
<tr><td class="num" id="LN1142">1142</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1143">1143</td><td class="line">        s-&gt;runtime_journal = journal_file_close(s-&gt;runtime_journal);</td></tr>
<tr><td class="num" id="LN1144">1144</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1145">1145</td><td class="line">        <span class='keyword'>if</span> (r &gt;= 0)</td></tr>
<tr><td class="num" id="LN1146">1146</td><td class="line">                (<span class='keyword'>void</span>) rm_rf(<span class='string_literal'>"/run/log/journal"</span>, REMOVE_ROOT);</td></tr>
<tr><td class="num" id="LN1147">1147</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1148">1148</td><td class="line">        sd_journal_close(j);</td></tr>
<tr><td class="num" id="LN1149">1149</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1150">1150</td><td class="line">        server_driver_message(s, <span class='macro'>SD_ID128_NULL<span class='expansion'>((const sd_id128_t) { .qwords = { 0, 0 }})</span></span>,</td></tr>
<tr><td class="num" id="LN1151">1151</td><td class="line">                              <span class='macro'>LOG_MESSAGE(<span class='string_literal'>"Time spent on flushing to /var is %s for %u entries."</span>,<span class='expansion'>"MESSAGE=" "Time spent on flushing to /var is %s for %u entries."<br>, format_timespan(ts, sizeof(ts), now(1) - start, 0), n</span></span></td></tr>
<tr><td class="num" id="LN1152">1152</td><td class="line">                                          <span class='macro'>format_timespan(ts, <span class='keyword'>sizeof</span>(ts), now(CLOCK_MONOTONIC) - start, 0),<span class='expansion'>"MESSAGE=" "Time spent on flushing to /var is %s for %u entries."<br>, format_timespan(ts, sizeof(ts), now(1) - start, 0), n</span></span></td></tr>
<tr><td class="num" id="LN1153">1153</td><td class="line">                                          <span class='macro'>n)<span class='expansion'>"MESSAGE=" "Time spent on flushing to /var is %s for %u entries."<br>, format_timespan(ts, sizeof(ts), now(1) - start, 0), n</span></span>,</td></tr>
<tr><td class="num" id="LN1154">1154</td><td class="line">                              <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>);</td></tr>
<tr><td class="num" id="LN1155">1155</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1156">1156</td><td class="line">        <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1157">1157</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1158">1158</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1159">1159</td><td class="line"><span class='keyword'>int</span> server_process_datagram(sd_event_source *es, <span class='keyword'>int</span> fd, uint32_t revents, <span class='keyword'>void</span> *userdata) {</td></tr>
<tr><td class="num" id="LN1160">1160</td><td class="line">        Server *s = userdata;</td></tr>
<tr><td class="num" id="LN1161">1161</td><td class="line">        <span class='keyword'>struct</span> ucred *ucred = <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>;</td></tr>
<tr><td class="num" id="LN1162">1162</td><td class="line">        <span class='keyword'>struct</span> timeval *tv = <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>;</td></tr>
<tr><td class="num" id="LN1163">1163</td><td class="line">        <span class='keyword'>struct</span> cmsghdr *cmsg;</td></tr>
<tr><td class="num" id="LN1164">1164</td><td class="line">        <span class='keyword'>char</span> *label = <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>;</td></tr>
<tr><td class="num" id="LN1165">1165</td><td class="line">        size_t label_len = 0, m;</td></tr>
<tr><td class="num" id="LN1166">1166</td><td class="line">        <span class='keyword'>struct</span> iovec iovec;</td></tr>
<tr><td class="num" id="LN1167">1167</td><td class="line">        ssize_t n;</td></tr>
<tr><td class="num" id="LN1168">1168</td><td class="line">        <span class='keyword'>int</span> *fds = <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, v = 0;</td></tr>
<tr><td class="num" id="LN1169">1169</td><td class="line">        <span class='keyword'>unsigned</span> n_fds = 0;</td></tr>
<tr><td class="num" id="LN1170">1170</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1171">1171</td><td class="line">        <span class='keyword'>union</span> {</td></tr>
<tr><td class="num" id="LN1172">1172</td><td class="line">                <span class='keyword'>struct</span> cmsghdr cmsghdr;</td></tr>
<tr><td class="num" id="LN1173">1173</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1174">1174</td><td class="line">                <span class='comment'>/* We use NAME_MAX space for the SELinux label</span></td></tr>
<tr><td class="num" id="LN1175">1175</td><td class="line">                 <span class='comment'>* here. The kernel currently enforces no</span></td></tr>
<tr><td class="num" id="LN1176">1176</td><td class="line">                 <span class='comment'>* limit, but according to suggestions from</span></td></tr>
<tr><td class="num" id="LN1177">1177</td><td class="line">                 <span class='comment'>* the SELinux people this will change and it</span></td></tr>
<tr><td class="num" id="LN1178">1178</td><td class="line">                 <span class='comment'>* will probably be identical to NAME_MAX. For</span></td></tr>
<tr><td class="num" id="LN1179">1179</td><td class="line">                 <span class='comment'>* now we use that, but this should be updated</span></td></tr>
<tr><td class="num" id="LN1180">1180</td><td class="line">                 <span class='comment'>* one day when the final limit is known. */</span></td></tr>
<tr><td class="num" id="LN1181">1181</td><td class="line">                uint8_t buf[<span class='macro'>CMSG_SPACE(<span class='keyword'>sizeof</span>(<span class='keyword'>struct</span> ucred))<span class='expansion'>((((sizeof(struct ucred)) + sizeof (size_t) - 1) &amp; (size_t<br>) ~(sizeof (size_t) - 1)) + (((sizeof (struct cmsghdr)) + sizeof<br> (size_t) - 1) &amp; (size_t) ~(sizeof (size_t) - 1)))</span></span> +</td></tr>
<tr><td class="num" id="LN1182">1182</td><td class="line">                            <span class='macro'>CMSG_SPACE(<span class='keyword'>sizeof</span>(<span class='keyword'>struct</span> timeval))<span class='expansion'>((((sizeof(struct timeval)) + sizeof (size_t) - 1) &amp; (size_t<br>) ~(sizeof (size_t) - 1)) + (((sizeof (struct cmsghdr)) + sizeof<br> (size_t) - 1) &amp; (size_t) ~(sizeof (size_t) - 1)))</span></span> +</td></tr>
<tr><td class="num" id="LN1183">1183</td><td class="line">                            <span class='macro'>CMSG_SPACE(<span class='keyword'>sizeof</span>(<span class='keyword'>int</span>))<span class='expansion'>((((sizeof(int)) + sizeof (size_t) - 1) &amp; (size_t) ~(sizeof<br> (size_t) - 1)) + (((sizeof (struct cmsghdr)) + sizeof (size_t<br>) - 1) &amp; (size_t) ~(sizeof (size_t) - 1)))</span></span> + <span class='comment'>/* fd */</span></td></tr>
<tr><td class="num" id="LN1184">1184</td><td class="line">                            <span class='macro'>CMSG_SPACE(NAME_MAX)<span class='expansion'>((((255) + sizeof (size_t) - 1) &amp; (size_t) ~(sizeof (size_t<br>) - 1)) + (((sizeof (struct cmsghdr)) + sizeof (size_t) - 1) &amp;<br> (size_t) ~(sizeof (size_t) - 1)))</span></span>]; <span class='comment'>/* selinux label */</span></td></tr>
<tr><td class="num" id="LN1185">1185</td><td class="line">        } control = {};</td></tr>
<tr><td class="num" id="LN1186">1186</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1187">1187</td><td class="line">        <span class='keyword'>union</span> sockaddr_union sa = {};</td></tr>
<tr><td class="num" id="LN1188">1188</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1189">1189</td><td class="line">        <span class='keyword'>struct</span> msghdr msghdr = {</td></tr>
<tr><td class="num" id="LN1190">1190</td><td class="line">                .msg_iov = &amp;iovec,</td></tr>
<tr><td class="num" id="LN1191">1191</td><td class="line">                .msg_iovlen = 1,</td></tr>
<tr><td class="num" id="LN1192">1192</td><td class="line">                .msg_control = &amp;control,</td></tr>
<tr><td class="num" id="LN1193">1193</td><td class="line">                .msg_controllen = <span class='keyword'>sizeof</span>(control),</td></tr>
<tr><td class="num" id="LN1194">1194</td><td class="line">                .msg_name = &amp;sa,</td></tr>
<tr><td class="num" id="LN1195">1195</td><td class="line">                .msg_namelen = <span class='keyword'>sizeof</span>(sa),</td></tr>
<tr><td class="num" id="LN1196">1196</td><td class="line">        };</td></tr>
<tr><td class="num" id="LN1197">1197</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1198">1198</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1198, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1199">1199</td><td class="line">        <span class='macro'>assert(fd == s-&gt;native_fd || fd == s-&gt;syslog_fd || fd == s-&gt;audit_fd)<span class='expansion'>do { if ((__builtin_expect(!!(!(fd == s-&gt;native_fd || fd ==<br> s-&gt;syslog_fd || fd == s-&gt;audit_fd)),0))) log_assert_failed<br>("fd == s-&gt;native_fd || fd == s-&gt;syslog_fd || fd == s-&gt;audit_fd"<br>, "src/journal/journald-server.c", 1199, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1200">1200</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1201">1201</td><td class="line">        <span class='keyword'>if</span> (revents != <span class='macro'>EPOLLIN<span class='expansion'>EPOLLIN</span></span>) {</td></tr>
<tr><td class="num" id="LN1202">1202</td><td class="line">                <span class='macro'>log_error(<span class='string_literal'>"Got invalid event from epoll for datagram fd: %"</span>PRIx32, revents)<span class='expansion'>({ int _level = (3), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1202, __func__, "Got invalid event from epoll for datagram fd: %"<br>"x", revents) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1203">1203</td><td class="line">                <span class='keyword'>return</span> -<span class='macro'>EIO<span class='expansion'>5</span></span>;</td></tr>
<tr><td class="num" id="LN1204">1204</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1205">1205</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1206">1206</td><td class="line">        <span class='comment'>/* Try to get the right size, if we can. (Not all</span></td></tr>
<tr><td class="num" id="LN1207">1207</td><td class="line">         <span class='comment'>* sockets support SIOCINQ, hence we just try, but</span></td></tr>
<tr><td class="num" id="LN1208">1208</td><td class="line">         <span class='comment'>* don't rely on it. */</span></td></tr>
<tr><td class="num" id="LN1209">1209</td><td class="line">        (<span class='keyword'>void</span>) ioctl(fd, <span class='macro'>SIOCINQ<span class='expansion'>0x541B</span></span>, &amp;v);</td></tr>
<tr><td class="num" id="LN1210">1210</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1211">1211</td><td class="line">        <span class='comment'>/* Fix it up, if it is too small. We use the same fixed value as auditd here. Awful! */</span></td></tr>
<tr><td class="num" id="LN1212">1212</td><td class="line">        m = <span class='macro'>PAGE_ALIGN(MAX3((size_t) v + 1,<span class='expansion'>ALIGN_TO((__extension__ ({ const typeof((size_t) v + 1) _c = __extension__<br> ({ const typeof(((size_t) v + 1)) __unique_prefix_A26 = (((size_t<br>) v + 1)); const typeof(((size_t) 2048)) __unique_prefix_B27 =<br> (((size_t) 2048)); __unique_prefix_A26 &gt; __unique_prefix_B27<br> ? __unique_prefix_A26 : __unique_prefix_B27; }); __extension__<br> ({ const typeof((_c)) __unique_prefix_A28 = ((_c)); const typeof<br>(((((sizeof(struct nlmsghdr)) + 7) &amp; ~7) + ((((size_t) 8970<br>) + 7) &amp; ~7))) __unique_prefix_B29 = (((((sizeof(struct nlmsghdr<br>)) + 7) &amp; ~7) + ((((size_t) 8970) + 7) &amp; ~7))); __unique_prefix_A28<br> &gt; __unique_prefix_B29 ? __unique_prefix_A28 : __unique_prefix_B29<br>; }); }) + 1), page_size())</span></span></td></tr>
<tr><td class="num" id="LN1213">1213</td><td class="line">                            <span class='macro'>(size_t) LINE_MAX,<span class='expansion'>ALIGN_TO((__extension__ ({ const typeof((size_t) v + 1) _c = __extension__<br> ({ const typeof(((size_t) v + 1)) __unique_prefix_A26 = (((size_t<br>) v + 1)); const typeof(((size_t) 2048)) __unique_prefix_B27 =<br> (((size_t) 2048)); __unique_prefix_A26 &gt; __unique_prefix_B27<br> ? __unique_prefix_A26 : __unique_prefix_B27; }); __extension__<br> ({ const typeof((_c)) __unique_prefix_A28 = ((_c)); const typeof<br>(((((sizeof(struct nlmsghdr)) + 7) &amp; ~7) + ((((size_t) 8970<br>) + 7) &amp; ~7))) __unique_prefix_B29 = (((((sizeof(struct nlmsghdr<br>)) + 7) &amp; ~7) + ((((size_t) 8970) + 7) &amp; ~7))); __unique_prefix_A28<br> &gt; __unique_prefix_B29 ? __unique_prefix_A28 : __unique_prefix_B29<br>; }); }) + 1), page_size())</span></span></td></tr>
<tr><td class="num" id="LN1214">1214</td><td class="line">                            <span class='macro'>ALIGN(<span class='keyword'>sizeof</span>(<span class='keyword'>struct</span> nlmsghdr)) + ALIGN((size_t) MAX_AUDIT_MESSAGE_LENGTH)) + 1)<span class='expansion'>ALIGN_TO((__extension__ ({ const typeof((size_t) v + 1) _c = __extension__<br> ({ const typeof(((size_t) v + 1)) __unique_prefix_A26 = (((size_t<br>) v + 1)); const typeof(((size_t) 2048)) __unique_prefix_B27 =<br> (((size_t) 2048)); __unique_prefix_A26 &gt; __unique_prefix_B27<br> ? __unique_prefix_A26 : __unique_prefix_B27; }); __extension__<br> ({ const typeof((_c)) __unique_prefix_A28 = ((_c)); const typeof<br>(((((sizeof(struct nlmsghdr)) + 7) &amp; ~7) + ((((size_t) 8970<br>) + 7) &amp; ~7))) __unique_prefix_B29 = (((((sizeof(struct nlmsghdr<br>)) + 7) &amp; ~7) + ((((size_t) 8970) + 7) &amp; ~7))); __unique_prefix_A28<br> &gt; __unique_prefix_B29 ? __unique_prefix_A28 : __unique_prefix_B29<br>; }); }) + 1), page_size())</span></span>;</td></tr>
<tr><td class="num" id="LN1215">1215</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1216">1216</td><td class="line">        <span class='keyword'>if</span> (!<span class='macro'>GREEDY_REALLOC(s-&gt;buffer, s-&gt;buffer_size, m)<span class='expansion'>greedy_realloc((void**) &amp;(s-&gt;buffer), &amp;(s-&gt;buffer_size<br>), (m), sizeof((s-&gt;buffer)[0]))</span></span>)</td></tr>
<tr><td class="num" id="LN1217">1217</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_oom()<span class='expansion'>log_oom_internal("src/journal/journald-server.c", 1217, __func__<br>)</span></span>;</td></tr>
<tr><td class="num" id="LN1218">1218</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1219">1219</td><td class="line">        iovec.iov_base = s-&gt;buffer;</td></tr>
<tr><td class="num" id="LN1220">1220</td><td class="line">        iovec.iov_len = s-&gt;buffer_size - 1; <span class='comment'>/* Leave room for trailing NUL we add later */</span></td></tr>
<tr><td class="num" id="LN1221">1221</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1222">1222</td><td class="line">        n = recvmsg(fd, &amp;msghdr, <span class='macro'>MSG_DONTWAIT<span class='expansion'>MSG_DONTWAIT</span></span>|<span class='macro'>MSG_CMSG_CLOEXEC<span class='expansion'>MSG_CMSG_CLOEXEC</span></span>);</td></tr>
<tr><td class="num" id="LN1223">1223</td><td class="line">        <span class='keyword'>if</span> (n &lt; 0) {</td></tr>
<tr><td class="num" id="LN1224">1224</td><td class="line">                <span class='keyword'>if</span> (<span class='macro'>errno<span class='expansion'>(*__errno_location ())</span></span> == <span class='macro'>EINTR<span class='expansion'>4</span></span> || <span class='macro'>errno<span class='expansion'>(*__errno_location ())</span></span> == <span class='macro'>EAGAIN<span class='expansion'>11</span></span>)</td></tr>
<tr><td class="num" id="LN1225">1225</td><td class="line">                        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1226">1226</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1227">1227</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_error_errno(errno, <span class='string_literal'>"recvmsg() failed: %m"</span>)<span class='expansion'>({ int _level = (3), _e = ((*__errno_location ())); (log_get_max_level<br>() &gt;= ((_level) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1227, __func__, "recvmsg() failed: %m") : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1228">1228</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1229">1229</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1230">1230</td><td class="line">        <span class='macro'>CMSG_FOREACH(cmsg, &amp;msghdr)<span class='expansion'>for ((cmsg) = ((size_t) (&amp;msghdr)-&gt;msg_controllen &gt;=<br> sizeof (struct cmsghdr) ? (struct cmsghdr *) (&amp;msghdr)-&gt;<br>msg_control : (struct cmsghdr *) 0); (cmsg); (cmsg) = __cmsg_nxthdr<br> ((&amp;msghdr), (cmsg)))</span></span> {</td></tr>
<tr><td class="num" id="LN1231">1231</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1232">1232</td><td class="line">                <span class='keyword'>if</span> (cmsg-&gt;cmsg_level == <span class='macro'>SOL_SOCKET<span class='expansion'>1</span></span> &amp;&amp;</td></tr>
<tr><td class="num" id="LN1233">1233</td><td class="line">                    cmsg-&gt;cmsg_type == <span class='macro'>SCM_CREDENTIALS<span class='expansion'>SCM_CREDENTIALS</span></span> &amp;&amp;</td></tr>
<tr><td class="num" id="LN1234">1234</td><td class="line">                    cmsg-&gt;cmsg_len == <span class='macro'>CMSG_LEN(<span class='keyword'>sizeof</span>(<span class='keyword'>struct</span> ucred))<span class='expansion'>((((sizeof (struct cmsghdr)) + sizeof (size_t) - 1) &amp; (size_t<br>) ~(sizeof (size_t) - 1)) + (sizeof(struct ucred)))</span></span>)</td></tr>
<tr><td class="num" id="LN1235">1235</td><td class="line">                        ucred = (<span class='keyword'>struct</span> ucred*) <span class='macro'>CMSG_DATA(cmsg)<span class='expansion'>((cmsg)-&gt;__cmsg_data)</span></span>;</td></tr>
<tr><td class="num" id="LN1236">1236</td><td class="line">                <span class='keyword'>else</span> <span class='keyword'>if</span> (cmsg-&gt;cmsg_level == <span class='macro'>SOL_SOCKET<span class='expansion'>1</span></span> &amp;&amp;</td></tr>
<tr><td class="num" id="LN1237">1237</td><td class="line">                         cmsg-&gt;cmsg_type == <span class='macro'>SCM_SECURITY<span class='expansion'>0x03</span></span>) {</td></tr>
<tr><td class="num" id="LN1238">1238</td><td class="line">                        label = (<span class='keyword'>char</span>*) <span class='macro'>CMSG_DATA(cmsg)<span class='expansion'>((cmsg)-&gt;__cmsg_data)</span></span>;</td></tr>
<tr><td class="num" id="LN1239">1239</td><td class="line">                        label_len = cmsg-&gt;cmsg_len - <span class='macro'>CMSG_LEN(0)<span class='expansion'>((((sizeof (struct cmsghdr)) + sizeof (size_t) - 1) &amp; (size_t<br>) ~(sizeof (size_t) - 1)) + (0))</span></span>;</td></tr>
<tr><td class="num" id="LN1240">1240</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (cmsg-&gt;cmsg_level == <span class='macro'>SOL_SOCKET<span class='expansion'>1</span></span> &amp;&amp;</td></tr>
<tr><td class="num" id="LN1241">1241</td><td class="line">                           cmsg-&gt;cmsg_type == <span class='macro'>SO_TIMESTAMP<span class='expansion'>29</span></span> &amp;&amp;</td></tr>
<tr><td class="num" id="LN1242">1242</td><td class="line">                           cmsg-&gt;cmsg_len == <span class='macro'>CMSG_LEN(<span class='keyword'>sizeof</span>(<span class='keyword'>struct</span> timeval))<span class='expansion'>((((sizeof (struct cmsghdr)) + sizeof (size_t) - 1) &amp; (size_t<br>) ~(sizeof (size_t) - 1)) + (sizeof(struct timeval)))</span></span>)</td></tr>
<tr><td class="num" id="LN1243">1243</td><td class="line">                        tv = (<span class='keyword'>struct</span> timeval*) <span class='macro'>CMSG_DATA(cmsg)<span class='expansion'>((cmsg)-&gt;__cmsg_data)</span></span>;</td></tr>
<tr><td class="num" id="LN1244">1244</td><td class="line">                <span class='keyword'>else</span> <span class='keyword'>if</span> (cmsg-&gt;cmsg_level == <span class='macro'>SOL_SOCKET<span class='expansion'>1</span></span> &amp;&amp;</td></tr>
<tr><td class="num" id="LN1245">1245</td><td class="line">                         cmsg-&gt;cmsg_type == <span class='macro'>SCM_RIGHTS<span class='expansion'>SCM_RIGHTS</span></span>) {</td></tr>
<tr><td class="num" id="LN1246">1246</td><td class="line">                        fds = (<span class='keyword'>int</span>*) <span class='macro'>CMSG_DATA(cmsg)<span class='expansion'>((cmsg)-&gt;__cmsg_data)</span></span>;</td></tr>
<tr><td class="num" id="LN1247">1247</td><td class="line">                        n_fds = (cmsg-&gt;cmsg_len - <span class='macro'>CMSG_LEN(0)<span class='expansion'>((((sizeof (struct cmsghdr)) + sizeof (size_t) - 1) &amp; (size_t<br>) ~(sizeof (size_t) - 1)) + (0))</span></span>) / <span class='keyword'>sizeof</span>(<span class='keyword'>int</span>);</td></tr>
<tr><td class="num" id="LN1248">1248</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN1249">1249</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1250">1250</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1251">1251</td><td class="line">        <span class='comment'>/* And a trailing NUL, just in case */</span></td></tr>
<tr><td class="num" id="LN1252">1252</td><td class="line">        s-&gt;buffer[n] = 0;</td></tr>
<tr><td class="num" id="LN1253">1253</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1254">1254</td><td class="line">        <span class='keyword'>if</span> (fd == s-&gt;syslog_fd) {</td></tr>
<tr><td class="num" id="LN1255">1255</td><td class="line">                <span class='keyword'>if</span> (n &gt; 0 &amp;&amp; n_fds == 0)</td></tr>
<tr><td class="num" id="LN1256">1256</td><td class="line">                        server_process_syslog_message(s, strstrip(s-&gt;buffer), ucred, tv, label, label_len);</td></tr>
<tr><td class="num" id="LN1257">1257</td><td class="line">                <span class='keyword'>else</span> <span class='keyword'>if</span> (n_fds &gt; 0)</td></tr>
<tr><td class="num" id="LN1258">1258</td><td class="line">                        <span class='macro'>log_warning(<span class='string_literal'>"Got file descriptors via syslog socket. Ignoring."</span>)<span class='expansion'>({ int _level = (4), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1258, __func__, "Got file descriptors via syslog socket. Ignoring."<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1259">1259</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1260">1260</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (fd == s-&gt;native_fd) {</td></tr>
<tr><td class="num" id="LN1261">1261</td><td class="line">                <span class='keyword'>if</span> (n &gt; 0 &amp;&amp; n_fds == 0)</td></tr>
<tr><td class="num" id="LN1262">1262</td><td class="line">                        server_process_native_message(s, s-&gt;buffer, n, ucred, tv, label, label_len);</td></tr>
<tr><td class="num" id="LN1263">1263</td><td class="line">                <span class='keyword'>else</span> <span class='keyword'>if</span> (n == 0 &amp;&amp; n_fds == 1)</td></tr>
<tr><td class="num" id="LN1264">1264</td><td class="line">                        server_process_native_file(s, fds[0], ucred, tv, label, label_len);</td></tr>
<tr><td class="num" id="LN1265">1265</td><td class="line">                <span class='keyword'>else</span> <span class='keyword'>if</span> (n_fds &gt; 0)</td></tr>
<tr><td class="num" id="LN1266">1266</td><td class="line">                        <span class='macro'>log_warning(<span class='string_literal'>"Got too many file descriptors via native socket. Ignoring."</span>)<span class='expansion'>({ int _level = (4), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1266, __func__, "Got too many file descriptors via native socket. Ignoring."<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1267">1267</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1268">1268</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr><td class="num" id="LN1269">1269</td><td class="line">                <span class='macro'>assert(fd == s-&gt;audit_fd)<span class='expansion'>do { if ((__builtin_expect(!!(!(fd == s-&gt;audit_fd)),0))) log_assert_failed<br>("fd == s-&gt;audit_fd", "src/journal/journald-server.c", 1269<br>, __PRETTY_FUNCTION__); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1270">1270</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1271">1271</td><td class="line">                <span class='keyword'>if</span> (n &gt; 0 &amp;&amp; n_fds == 0)</td></tr>
<tr><td class="num" id="LN1272">1272</td><td class="line">                        server_process_audit_message(s, s-&gt;buffer, n, ucred, &amp;sa, msghdr.msg_namelen);</td></tr>
<tr><td class="num" id="LN1273">1273</td><td class="line">                <span class='keyword'>else</span> <span class='keyword'>if</span> (n_fds &gt; 0)</td></tr>
<tr><td class="num" id="LN1274">1274</td><td class="line">                        <span class='macro'>log_warning(<span class='string_literal'>"Got file descriptors via audit socket. Ignoring."</span>)<span class='expansion'>({ int _level = (4), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1274, __func__, "Got file descriptors via audit socket. Ignoring."<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1275">1275</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1276">1276</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1277">1277</td><td class="line">        close_many(fds, n_fds);</td></tr>
<tr><td class="num" id="LN1278">1278</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1279">1279</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1280">1280</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1281">1281</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> dispatch_sigusr1(sd_event_source *es, <span class='keyword'>const</span> <span class='keyword'>struct</span> signalfd_siginfo *si, <span class='keyword'>void</span> *userdata) {</td></tr>
<tr><td class="num" id="LN1282">1282</td><td class="line">        Server *s = userdata;</td></tr>
<tr><td class="num" id="LN1283">1283</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN1284">1284</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1285">1285</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1285, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1286">1286</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1287">1287</td><td class="line">        <span class='macro'>log_info(<span class='string_literal'>"Received request to flush runtime journal from PID "</span> PID_FMT, si-&gt;ssi_pid)<span class='expansion'>({ int _level = (6), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1287, __func__, "Received request to flush runtime journal from PID "<br> "%" "i", si-&gt;ssi_pid) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1288">1288</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1289">1289</td><td class="line">        server_flush_to_var(s);</td></tr>
<tr><td class="num" id="LN1290">1290</td><td class="line">        server_sync(s);</td></tr>
<tr><td class="num" id="LN1291">1291</td><td class="line">        server_vacuum(s, <span class='macro'>false<span class='expansion'>0</span></span>, <span class='macro'>false<span class='expansion'>0</span></span>);</td></tr>
<tr><td class="num" id="LN1292">1292</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1293">1293</td><td class="line">        r = touch(<span class='string_literal'>"/run/systemd/journal/flushed"</span>);</td></tr>
<tr><td class="num" id="LN1294">1294</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1295">1295</td><td class="line">                <span class='macro'>log_warning_errno(r, <span class='string_literal'>"Failed to touch /run/systemd/journal/flushed, ignoring: %m"</span>)<span class='expansion'>({ int _level = (4), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1295, __func__, "Failed to touch /run/systemd/journal/flushed, ignoring: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1296">1296</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1297">1297</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1298">1298</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1299">1299</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1300">1300</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> dispatch_sigusr2(sd_event_source *es, <span class='keyword'>const</span> <span class='keyword'>struct</span> signalfd_siginfo *si, <span class='keyword'>void</span> *userdata) {</td></tr>
<tr><td class="num" id="LN1301">1301</td><td class="line">        Server *s = userdata;</td></tr>
<tr><td class="num" id="LN1302">1302</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN1303">1303</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1304">1304</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1304, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1305">1305</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1306">1306</td><td class="line">        <span class='macro'>log_info(<span class='string_literal'>"Received request to rotate journal from PID "</span> PID_FMT, si-&gt;ssi_pid)<span class='expansion'>({ int _level = (6), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1306, __func__, "Received request to rotate journal from PID "<br> "%" "i", si-&gt;ssi_pid) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1307">1307</td><td class="line">        server_rotate(s);</td></tr>
<tr><td class="num" id="LN1308">1308</td><td class="line">        server_vacuum(s, <span class='macro'>true<span class='expansion'>1</span></span>, <span class='macro'>true<span class='expansion'>1</span></span>);</td></tr>
<tr><td class="num" id="LN1309">1309</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1310">1310</td><td class="line">        <span class='comment'>/* Let clients know when the most recent rotation happened. */</span></td></tr>
<tr><td class="num" id="LN1311">1311</td><td class="line">        r = write_timestamp_file_atomic(<span class='string_literal'>"/run/systemd/journal/rotated"</span>, now(<span class='macro'>CLOCK_MONOTONIC<span class='expansion'>1</span></span>));</td></tr>
<tr><td class="num" id="LN1312">1312</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1313">1313</td><td class="line">                <span class='macro'>log_warning_errno(r, <span class='string_literal'>"Failed to write /run/systemd/journal/rotated, ignoring: %m"</span>)<span class='expansion'>({ int _level = (4), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1313, __func__, "Failed to write /run/systemd/journal/rotated, ignoring: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1314">1314</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1315">1315</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1316">1316</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1317">1317</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1318">1318</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> dispatch_sigterm(sd_event_source *es, <span class='keyword'>const</span> <span class='keyword'>struct</span> signalfd_siginfo *si, <span class='keyword'>void</span> *userdata) {</td></tr>
<tr><td class="num" id="LN1319">1319</td><td class="line">        Server *s = userdata;</td></tr>
<tr><td class="num" id="LN1320">1320</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1321">1321</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1321, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1322">1322</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1323">1323</td><td class="line">        log_received_signal(<span class='macro'>LOG_INFO<span class='expansion'>6</span></span>, si);</td></tr>
<tr><td class="num" id="LN1324">1324</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1325">1325</td><td class="line">        sd_event_exit(s-&gt;event, 0);</td></tr>
<tr><td class="num" id="LN1326">1326</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1327">1327</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1328">1328</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1329">1329</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> dispatch_sigrtmin1(sd_event_source *es, <span class='keyword'>const</span> <span class='keyword'>struct</span> signalfd_siginfo *si, <span class='keyword'>void</span> *userdata) {</td></tr>
<tr><td class="num" id="LN1330">1330</td><td class="line">        Server *s = userdata;</td></tr>
<tr><td class="num" id="LN1331">1331</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN1332">1332</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1333">1333</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1333, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1334">1334</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1335">1335</td><td class="line">        <span class='macro'>log_debug(<span class='string_literal'>"Received request to sync from PID "</span> PID_FMT, si-&gt;ssi_pid)<span class='expansion'>({ int _level = (7), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1335, __func__, "Received request to sync from PID " "%" "i"<br>, si-&gt;ssi_pid) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1336">1336</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1337">1337</td><td class="line">        server_sync(s);</td></tr>
<tr><td class="num" id="LN1338">1338</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1339">1339</td><td class="line">        <span class='comment'>/* Let clients know when the most recent sync happened. */</span></td></tr>
<tr><td class="num" id="LN1340">1340</td><td class="line">        r = write_timestamp_file_atomic(<span class='string_literal'>"/run/systemd/journal/synced"</span>, now(<span class='macro'>CLOCK_MONOTONIC<span class='expansion'>1</span></span>));</td></tr>
<tr><td class="num" id="LN1341">1341</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1342">1342</td><td class="line">                <span class='macro'>log_warning_errno(r, <span class='string_literal'>"Failed to write /run/systemd/journal/synced, ignoring: %m"</span>)<span class='expansion'>({ int _level = (4), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1342, __func__, "Failed to write /run/systemd/journal/synced, ignoring: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1343">1343</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1344">1344</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1345">1345</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1346">1346</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1347">1347</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> setup_signals(Server *s) {</td></tr>
<tr><td class="num" id="LN1348">1348</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN1349">1349</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1350">1350</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1350, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1351">1351</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1352">1352</td><td class="line">        <span class='macro'>assert(sigprocmask_many(SIG_SETMASK, NULL, SIGINT, SIGTERM, SIGUSR1, SIGUSR2, SIGRTMIN+1, -1) &gt;= 0)<span class='expansion'>do { if ((__builtin_expect(!!(!(sigprocmask_many(2, ((void*)0<br>), 2, 15, 10, 12, (__libc_current_sigrtmin ())+1, -1) &gt;= 0<br>)),0))) log_assert_failed("sigprocmask_many(SIG_SETMASK, NULL, SIGINT, SIGTERM, SIGUSR1, SIGUSR2, SIGRTMIN+1, -1) &gt;= 0"<br>, "src/journal/journald-server.c", 1352, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1353">1353</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1354">1354</td><td class="line">        r = sd_event_add_signal(s-&gt;event, &amp;s-&gt;sigusr1_event_source, <span class='macro'>SIGUSR1<span class='expansion'>10</span></span>, dispatch_sigusr1, s);</td></tr>
<tr><td class="num" id="LN1355">1355</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1356">1356</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1357">1357</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1358">1358</td><td class="line">        r = sd_event_add_signal(s-&gt;event, &amp;s-&gt;sigusr2_event_source, <span class='macro'>SIGUSR2<span class='expansion'>12</span></span>, dispatch_sigusr2, s);</td></tr>
<tr><td class="num" id="LN1359">1359</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1360">1360</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1361">1361</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1362">1362</td><td class="line">        r = sd_event_add_signal(s-&gt;event, &amp;s-&gt;sigterm_event_source, <span class='macro'>SIGTERM<span class='expansion'>15</span></span>, dispatch_sigterm, s);</td></tr>
<tr><td class="num" id="LN1363">1363</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1364">1364</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1365">1365</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1366">1366</td><td class="line">        <span class='comment'>/* Let's process SIGTERM late, so that we flush all queued</span></td></tr>
<tr><td class="num" id="LN1367">1367</td><td class="line">         <span class='comment'>* messages to disk before we exit */</span></td></tr>
<tr><td class="num" id="LN1368">1368</td><td class="line">        r = sd_event_source_set_priority(s-&gt;sigterm_event_source, SD_EVENT_PRIORITY_NORMAL+20);</td></tr>
<tr><td class="num" id="LN1369">1369</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1370">1370</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1371">1371</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1372">1372</td><td class="line">        <span class='comment'>/* When journald is invoked on the terminal (when debugging),</span></td></tr>
<tr><td class="num" id="LN1373">1373</td><td class="line">         <span class='comment'>* it's useful if C-c is handled equivalent to SIGTERM. */</span></td></tr>
<tr><td class="num" id="LN1374">1374</td><td class="line">        r = sd_event_add_signal(s-&gt;event, &amp;s-&gt;sigint_event_source, <span class='macro'>SIGINT<span class='expansion'>2</span></span>, dispatch_sigterm, s);</td></tr>
<tr><td class="num" id="LN1375">1375</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1376">1376</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1377">1377</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1378">1378</td><td class="line">        r = sd_event_source_set_priority(s-&gt;sigint_event_source, SD_EVENT_PRIORITY_NORMAL+20);</td></tr>
<tr><td class="num" id="LN1379">1379</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1380">1380</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1381">1381</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1382">1382</td><td class="line">        <span class='comment'>/* SIGRTMIN+1 causes an immediate sync. We process this very</span></td></tr>
<tr><td class="num" id="LN1383">1383</td><td class="line">         <span class='comment'>* late, so that everything else queued at this point is</span></td></tr>
<tr><td class="num" id="LN1384">1384</td><td class="line">         <span class='comment'>* really written to disk. Clients can watch</span></td></tr>
<tr><td class="num" id="LN1385">1385</td><td class="line">         <span class='comment'>* /run/systemd/journal/synced with inotify until its mtime</span></td></tr>
<tr><td class="num" id="LN1386">1386</td><td class="line">         <span class='comment'>* changes to see when a sync happened. */</span></td></tr>
<tr><td class="num" id="LN1387">1387</td><td class="line">        r = sd_event_add_signal(s-&gt;event, &amp;s-&gt;sigrtmin1_event_source, <span class='macro'>SIGRTMIN<span class='expansion'>(__libc_current_sigrtmin ())</span></span>+1, dispatch_sigrtmin1, s);</td></tr>
<tr><td class="num" id="LN1388">1388</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1389">1389</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1390">1390</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1391">1391</td><td class="line">        r = sd_event_source_set_priority(s-&gt;sigrtmin1_event_source, SD_EVENT_PRIORITY_NORMAL+15);</td></tr>
<tr><td class="num" id="LN1392">1392</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1393">1393</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1394">1394</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1395">1395</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1396">1396</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1397">1397</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1398">1398</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> server_parse_proc_cmdline(Server *s) {</td></tr>
<tr><td class="num" id="LN1399">1399</td><td class="line">        <span class='macro'>_cleanup_free_<span class='expansion'>__attribute__((cleanup(freep)))</span></span> <span class='keyword'>char</span> *line = <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>;</td></tr>
<tr><td class="num" id="LN1400">1400</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span> *p;</td></tr>
<tr><td class="num" id="LN1401">1401</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN1402">1402</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1403">1403</td><td class="line">        r = proc_cmdline(&amp;line);</td></tr>
<tr><td class="num" id="LN1404">1404</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0) {</td></tr>
<tr><td class="num" id="LN1405">1405</td><td class="line">                <span class='macro'>log_warning_errno(r, <span class='string_literal'>"Failed to read /proc/cmdline, ignoring: %m"</span>)<span class='expansion'>({ int _level = (4), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1405, __func__, "Failed to read /proc/cmdline, ignoring: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1406">1406</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1407">1407</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1408">1408</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1409">1409</td><td class="line">        p = line;</td></tr>
<tr><td class="num" id="LN1410">1410</td><td class="line">        <span class='keyword'>for</span>(;;) {</td></tr>
<tr><td class="num" id="LN1411">1411</td><td class="line">                <span class='macro'>_cleanup_free_<span class='expansion'>__attribute__((cleanup(freep)))</span></span> <span class='keyword'>char</span> *word = <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>;</td></tr>
<tr><td class="num" id="LN1412">1412</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1413">1413</td><td class="line">                r = extract_first_word(&amp;p, &amp;word, <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>, 0);</td></tr>
<tr><td class="num" id="LN1414">1414</td><td class="line">                <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1415">1415</td><td class="line">                        <span class='keyword'>return</span> <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to parse journald syntax \"%s\": %m"</span>, line)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1415, __func__, "Failed to parse journald syntax \"%s\": %m"<br>, line) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1416">1416</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1417">1417</td><td class="line">                <span class='keyword'>if</span> (r == 0)</td></tr>
<tr><td class="num" id="LN1418">1418</td><td class="line">                        <span class='keyword'>break</span>;</td></tr>
<tr><td class="num" id="LN1419">1419</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1420">1420</td><td class="line">                <span class='keyword'>if</span> (startswith(word, <span class='string_literal'>"systemd.journald.forward_to_syslog="</span>)) {</td></tr>
<tr><td class="num" id="LN1421">1421</td><td class="line">                        r = parse_boolean(word + 35);</td></tr>
<tr><td class="num" id="LN1422">1422</td><td class="line">                        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1423">1423</td><td class="line">                                <span class='macro'>log_warning(<span class='string_literal'>"Failed to parse forward to syslog switch %s. Ignoring."</span>, word + 35)<span class='expansion'>({ int _level = (4), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1423, __func__, "Failed to parse forward to syslog switch %s. Ignoring."<br>, word + 35) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1424">1424</td><td class="line">                        <span class='keyword'>else</span></td></tr>
<tr><td class="num" id="LN1425">1425</td><td class="line">                                s-&gt;forward_to_syslog = r;</td></tr>
<tr><td class="num" id="LN1426">1426</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (startswith(word, <span class='string_literal'>"systemd.journald.forward_to_kmsg="</span>)) {</td></tr>
<tr><td class="num" id="LN1427">1427</td><td class="line">                        r = parse_boolean(word + 33);</td></tr>
<tr><td class="num" id="LN1428">1428</td><td class="line">                        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1429">1429</td><td class="line">                                <span class='macro'>log_warning(<span class='string_literal'>"Failed to parse forward to kmsg switch %s. Ignoring."</span>, word + 33)<span class='expansion'>({ int _level = (4), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1429, __func__, "Failed to parse forward to kmsg switch %s. Ignoring."<br>, word + 33) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1430">1430</td><td class="line">                        <span class='keyword'>else</span></td></tr>
<tr><td class="num" id="LN1431">1431</td><td class="line">                                s-&gt;forward_to_kmsg = r;</td></tr>
<tr><td class="num" id="LN1432">1432</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (startswith(word, <span class='string_literal'>"systemd.journald.forward_to_console="</span>)) {</td></tr>
<tr><td class="num" id="LN1433">1433</td><td class="line">                        r = parse_boolean(word + 36);</td></tr>
<tr><td class="num" id="LN1434">1434</td><td class="line">                        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1435">1435</td><td class="line">                                <span class='macro'>log_warning(<span class='string_literal'>"Failed to parse forward to console switch %s. Ignoring."</span>, word + 36)<span class='expansion'>({ int _level = (4), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1435, __func__, "Failed to parse forward to console switch %s. Ignoring."<br>, word + 36) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1436">1436</td><td class="line">                        <span class='keyword'>else</span></td></tr>
<tr><td class="num" id="LN1437">1437</td><td class="line">                                s-&gt;forward_to_console = r;</td></tr>
<tr><td class="num" id="LN1438">1438</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (startswith(word, <span class='string_literal'>"systemd.journald.forward_to_wall="</span>)) {</td></tr>
<tr><td class="num" id="LN1439">1439</td><td class="line">                        r = parse_boolean(word + 33);</td></tr>
<tr><td class="num" id="LN1440">1440</td><td class="line">                        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1441">1441</td><td class="line">                                <span class='macro'>log_warning(<span class='string_literal'>"Failed to parse forward to wall switch %s. Ignoring."</span>, word + 33)<span class='expansion'>({ int _level = (4), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1441, __func__, "Failed to parse forward to wall switch %s. Ignoring."<br>, word + 33) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1442">1442</td><td class="line">                        <span class='keyword'>else</span></td></tr>
<tr><td class="num" id="LN1443">1443</td><td class="line">                                s-&gt;forward_to_wall = r;</td></tr>
<tr><td class="num" id="LN1444">1444</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (startswith(word, <span class='string_literal'>"systemd.journald"</span>))</td></tr>
<tr><td class="num" id="LN1445">1445</td><td class="line">                        <span class='macro'>log_warning(<span class='string_literal'>"Invalid systemd.journald parameter. Ignoring."</span>)<span class='expansion'>({ int _level = (4), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1445, __func__, "Invalid systemd.journald parameter. Ignoring."<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1446">1446</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1447">1447</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1448">1448</td><td class="line">        <span class='comment'>/* do not warn about state here, since probably systemd already did */</span></td></tr>
<tr><td class="num" id="LN1449">1449</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1450">1450</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1451">1451</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1452">1452</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> server_parse_config_file(Server *s) {</td></tr>
<tr><td class="num" id="LN1453">1453</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1453, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1454">1454</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1455">1455</td><td class="line">        <span class='keyword'>return</span> config_parse_many(<span class='macro'>PKGSYSCONFDIR<span class='expansion'>"/usr/etc/systemd"</span></span> <span class='string_literal'>"/journald.conf"</span>,</td></tr>
<tr><td class="num" id="LN1456">1456</td><td class="line">                                 <span class='macro'>CONF_PATHS_NULSTR(<span class='string_literal'>"systemd/journald.conf.d"</span>)<span class='expansion'>"/etc/" "systemd/journald.conf.d" "\0" "/run/" "systemd/journald.conf.d"<br> "\0" "/usr/local/lib/" "systemd/journald.conf.d" "\0" "/usr/lib/"<br> "systemd/journald.conf.d" "\0"</span></span>,</td></tr>
<tr><td class="num" id="LN1457">1457</td><td class="line">                                 <span class='string_literal'>"Journal\0"</span>,</td></tr>
<tr><td class="num" id="LN1458">1458</td><td class="line">                                 config_item_perf_lookup, journald_gperf_lookup,</td></tr>
<tr><td class="num" id="LN1459">1459</td><td class="line">                                 <span class='macro'>false<span class='expansion'>0</span></span>, s);</td></tr>
<tr><td class="num" id="LN1460">1460</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1461">1461</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1462">1462</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> server_dispatch_sync(sd_event_source *es, usec_t t, <span class='keyword'>void</span> *userdata) {</td></tr>
<tr><td class="num" id="LN1463">1463</td><td class="line">        Server *s = userdata;</td></tr>
<tr><td class="num" id="LN1464">1464</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1465">1465</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1465, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1466">1466</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1467">1467</td><td class="line">        server_sync(s);</td></tr>
<tr><td class="num" id="LN1468">1468</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1469">1469</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1470">1470</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1471">1471</td><td class="line"><span class='keyword'>int</span> server_schedule_sync(Server *s, <span class='keyword'>int</span> priority) {</td></tr>
<tr><td class="num" id="LN1472">1472</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN1473">1473</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1474">1474</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1474, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1475">1475</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1476">1476</td><td class="line">        <span class='keyword'>if</span> (priority &lt;= <span class='macro'>LOG_CRIT<span class='expansion'>2</span></span>) {</td></tr>
<tr><td class="num" id="LN1477">1477</td><td class="line">                <span class='comment'>/* Immediately sync to disk when this is of priority CRIT, ALERT, EMERG */</span></td></tr>
<tr><td class="num" id="LN1478">1478</td><td class="line">                server_sync(s);</td></tr>
<tr><td class="num" id="LN1479">1479</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1480">1480</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1481">1481</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1482">1482</td><td class="line">        <span class='keyword'>if</span> (s-&gt;sync_scheduled)</td></tr>
<tr><td class="num" id="LN1483">1483</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1484">1484</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1485">1485</td><td class="line">        <span class='keyword'>if</span> (s-&gt;sync_interval_usec &gt; 0) {</td></tr>
<tr><td class="num" id="LN1486">1486</td><td class="line">                usec_t when;</td></tr>
<tr><td class="num" id="LN1487">1487</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1488">1488</td><td class="line">                r = sd_event_now(s-&gt;event, <span class='macro'>CLOCK_MONOTONIC<span class='expansion'>1</span></span>, &amp;when);</td></tr>
<tr><td class="num" id="LN1489">1489</td><td class="line">                <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1490">1490</td><td class="line">                        <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1491">1491</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1492">1492</td><td class="line">                when += s-&gt;sync_interval_usec;</td></tr>
<tr><td class="num" id="LN1493">1493</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1494">1494</td><td class="line">                <span class='keyword'>if</span> (!s-&gt;sync_event_source) {</td></tr>
<tr><td class="num" id="LN1495">1495</td><td class="line">                        r = sd_event_add_time(</td></tr>
<tr><td class="num" id="LN1496">1496</td><td class="line">                                        s-&gt;event,</td></tr>
<tr><td class="num" id="LN1497">1497</td><td class="line">                                        &amp;s-&gt;sync_event_source,</td></tr>
<tr><td class="num" id="LN1498">1498</td><td class="line">                                        <span class='macro'>CLOCK_MONOTONIC<span class='expansion'>1</span></span>,</td></tr>
<tr><td class="num" id="LN1499">1499</td><td class="line">                                        when, 0,</td></tr>
<tr><td class="num" id="LN1500">1500</td><td class="line">                                        server_dispatch_sync, s);</td></tr>
<tr><td class="num" id="LN1501">1501</td><td class="line">                        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1502">1502</td><td class="line">                                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1503">1503</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1504">1504</td><td class="line">                        r = sd_event_source_set_priority(s-&gt;sync_event_source, SD_EVENT_PRIORITY_IMPORTANT);</td></tr>
<tr><td class="num" id="LN1505">1505</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr><td class="num" id="LN1506">1506</td><td class="line">                        r = sd_event_source_set_time(s-&gt;sync_event_source, when);</td></tr>
<tr><td class="num" id="LN1507">1507</td><td class="line">                        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1508">1508</td><td class="line">                                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1509">1509</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1510">1510</td><td class="line">                        r = sd_event_source_set_enabled(s-&gt;sync_event_source, SD_EVENT_ONESHOT);</td></tr>
<tr><td class="num" id="LN1511">1511</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN1512">1512</td><td class="line">                <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1513">1513</td><td class="line">                        <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1514">1514</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1515">1515</td><td class="line">                s-&gt;sync_scheduled = <span class='macro'>true<span class='expansion'>1</span></span>;</td></tr>
<tr><td class="num" id="LN1516">1516</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1517">1517</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1518">1518</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1519">1519</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1520">1520</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1521">1521</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> dispatch_hostname_change(sd_event_source *es, <span class='keyword'>int</span> fd, uint32_t revents, <span class='keyword'>void</span> *userdata) {</td></tr>
<tr><td class="num" id="LN1522">1522</td><td class="line">        Server *s = userdata;</td></tr>
<tr><td class="num" id="LN1523">1523</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1524">1524</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1524, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1525">1525</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1526">1526</td><td class="line">        server_cache_hostname(s);</td></tr>
<tr><td class="num" id="LN1527">1527</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1528">1528</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1529">1529</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1530">1530</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> server_open_hostname(Server *s) {</td></tr>
<tr><td class="num" id="LN1531">1531</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN1532">1532</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1533">1533</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1533, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1534">1534</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1535">1535</td><td class="line">        s-&gt;hostname_fd = open(<span class='string_literal'>"/proc/sys/kernel/hostname"</span>, <span class='macro'>O_RDONLY<span class='expansion'>00</span></span>|<span class='macro'>O_CLOEXEC<span class='expansion'>02000000</span></span>|<span class='macro'>O_NDELAY<span class='expansion'>04000</span></span>|<span class='macro'>O_NOCTTY<span class='expansion'>0400</span></span>);</td></tr>
<tr><td class="num" id="LN1536">1536</td><td class="line">        <span class='keyword'>if</span> (s-&gt;hostname_fd &lt; 0)</td></tr>
<tr><td class="num" id="LN1537">1537</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_error_errno(errno, <span class='string_literal'>"Failed to open /proc/sys/kernel/hostname: %m"</span>)<span class='expansion'>({ int _level = (3), _e = ((*__errno_location ())); (log_get_max_level<br>() &gt;= ((_level) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1537, __func__, "Failed to open /proc/sys/kernel/hostname: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1538">1538</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1539">1539</td><td class="line">        r = sd_event_add_io(s-&gt;event, &amp;s-&gt;hostname_event_source, s-&gt;hostname_fd, 0, dispatch_hostname_change, s);</td></tr>
<tr><td class="num" id="LN1540">1540</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0) {</td></tr>
<tr><td class="num" id="LN1541">1541</td><td class="line">                <span class='comment'>/* kernels prior to 3.2 don't support polling this file. Ignore</span></td></tr>
<tr><td class="num" id="LN1542">1542</td><td class="line">                 <span class='comment'>* the failure. */</span></td></tr>
<tr><td class="num" id="LN1543">1543</td><td class="line">                <span class='keyword'>if</span> (r == -<span class='macro'>EPERM<span class='expansion'>1</span></span>) {</td></tr>
<tr><td class="num" id="LN1544">1544</td><td class="line">                        <span class='macro'>log_warning_errno(r, <span class='string_literal'>"Failed to register hostname fd in event loop, ignoring: %m"</span>)<span class='expansion'>({ int _level = (4), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1544, __func__, "Failed to register hostname fd in event loop, ignoring: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1545">1545</td><td class="line">                        s-&gt;hostname_fd = safe_close(s-&gt;hostname_fd);</td></tr>
<tr><td class="num" id="LN1546">1546</td><td class="line">                        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1547">1547</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN1548">1548</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1549">1549</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to register hostname fd in event loop: %m"</span>)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1549, __func__, "Failed to register hostname fd in event loop: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1550">1550</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1551">1551</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1552">1552</td><td class="line">        r = sd_event_source_set_priority(s-&gt;hostname_event_source, SD_EVENT_PRIORITY_IMPORTANT-10);</td></tr>
<tr><td class="num" id="LN1553">1553</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1554">1554</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to adjust priority of host name event source: %m"</span>)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1554, __func__, "Failed to adjust priority of host name event source: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1555">1555</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1556">1556</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1557">1557</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1558">1558</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1559">1559</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> dispatch_notify_event(sd_event_source *es, <span class='keyword'>int</span> fd, uint32_t revents, <span class='keyword'>void</span> *userdata) {</td></tr>
<tr><td class="num" id="LN1560">1560</td><td class="line">        Server *s = userdata;</td></tr>
<tr><td class="num" id="LN1561">1561</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN1562">1562</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1563">1563</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1563, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1564">1564</td><td class="line">        <span class='macro'>assert(s-&gt;notify_event_source == es)<span class='expansion'>do { if ((__builtin_expect(!!(!(s-&gt;notify_event_source == es<br>)),0))) log_assert_failed("s-&gt;notify_event_source == es", "src/journal/journald-server.c"<br>, 1564, __PRETTY_FUNCTION__); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1565">1565</td><td class="line">        <span class='macro'>assert(s-&gt;notify_fd == fd)<span class='expansion'>do { if ((__builtin_expect(!!(!(s-&gt;notify_fd == fd)),0))) log_assert_failed<br>("s-&gt;notify_fd == fd", "src/journal/journald-server.c", 1565<br>, __PRETTY_FUNCTION__); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1566">1566</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1567">1567</td><td class="line">        <span class='comment'>/* The $NOTIFY_SOCKET is writable again, now send exactly one</span></td></tr>
<tr><td class="num" id="LN1568">1568</td><td class="line">         <span class='comment'>* message on it. Either it's the wtachdog event, the initial</span></td></tr>
<tr><td class="num" id="LN1569">1569</td><td class="line">         <span class='comment'>* READY=1 event or an stdout stream event. If there's nothing</span></td></tr>
<tr><td class="num" id="LN1570">1570</td><td class="line">         <span class='comment'>* to write anymore, turn our event source off. The next time</span></td></tr>
<tr><td class="num" id="LN1571">1571</td><td class="line">         <span class='comment'>* there's something to send it will be turned on again. */</span></td></tr>
<tr><td class="num" id="LN1572">1572</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1573">1573</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;sent_notify_ready) {</td></tr>
<tr><td class="num" id="LN1574">1574</td><td class="line">                <span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> p[] =</td></tr>
<tr><td class="num" id="LN1575">1575</td><td class="line">                        <span class='string_literal'>"READY=1\n"</span></td></tr>
<tr><td class="num" id="LN1576">1576</td><td class="line">                        <span class='string_literal'>"STATUS=Processing requests..."</span>;</td></tr>
<tr><td class="num" id="LN1577">1577</td><td class="line">                ssize_t l;</td></tr>
<tr><td class="num" id="LN1578">1578</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1579">1579</td><td class="line">                l = send(s-&gt;notify_fd, p, strlen(p), <span class='macro'>MSG_DONTWAIT<span class='expansion'>MSG_DONTWAIT</span></span>);</td></tr>
<tr><td class="num" id="LN1580">1580</td><td class="line">                <span class='keyword'>if</span> (l &lt; 0) {</td></tr>
<tr><td class="num" id="LN1581">1581</td><td class="line">                        <span class='keyword'>if</span> (<span class='macro'>errno<span class='expansion'>(*__errno_location ())</span></span> == <span class='macro'>EAGAIN<span class='expansion'>11</span></span>)</td></tr>
<tr><td class="num" id="LN1582">1582</td><td class="line">                                <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1583">1583</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1584">1584</td><td class="line">                        <span class='keyword'>return</span> <span class='macro'>log_error_errno(errno, <span class='string_literal'>"Failed to send READY=1 notification message: %m"</span>)<span class='expansion'>({ int _level = (3), _e = ((*__errno_location ())); (log_get_max_level<br>() &gt;= ((_level) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1584, __func__, "Failed to send READY=1 notification message: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1585">1585</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN1586">1586</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1587">1587</td><td class="line">                s-&gt;sent_notify_ready = <span class='macro'>true<span class='expansion'>1</span></span>;</td></tr>
<tr><td class="num" id="LN1588">1588</td><td class="line">                <span class='macro'>log_debug(<span class='string_literal'>"Sent READY=1 notification."</span>)<span class='expansion'>({ int _level = (7), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1588, __func__, "Sent READY=1 notification.") : -abs(_e); }<br>)</span></span>;</td></tr>
<tr><td class="num" id="LN1589">1589</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1590">1590</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (s-&gt;send_watchdog) {</td></tr>
<tr><td class="num" id="LN1591">1591</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1592">1592</td><td class="line">                <span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> p[] =</td></tr>
<tr><td class="num" id="LN1593">1593</td><td class="line">                        <span class='string_literal'>"WATCHDOG=1"</span>;</td></tr>
<tr><td class="num" id="LN1594">1594</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1595">1595</td><td class="line">                ssize_t l;</td></tr>
<tr><td class="num" id="LN1596">1596</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1597">1597</td><td class="line">                l = send(s-&gt;notify_fd, p, strlen(p), <span class='macro'>MSG_DONTWAIT<span class='expansion'>MSG_DONTWAIT</span></span>);</td></tr>
<tr><td class="num" id="LN1598">1598</td><td class="line">                <span class='keyword'>if</span> (l &lt; 0) {</td></tr>
<tr><td class="num" id="LN1599">1599</td><td class="line">                        <span class='keyword'>if</span> (<span class='macro'>errno<span class='expansion'>(*__errno_location ())</span></span> == <span class='macro'>EAGAIN<span class='expansion'>11</span></span>)</td></tr>
<tr><td class="num" id="LN1600">1600</td><td class="line">                                <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1601">1601</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1602">1602</td><td class="line">                        <span class='keyword'>return</span> <span class='macro'>log_error_errno(errno, <span class='string_literal'>"Failed to send WATCHDOG=1 notification message: %m"</span>)<span class='expansion'>({ int _level = (3), _e = ((*__errno_location ())); (log_get_max_level<br>() &gt;= ((_level) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1602, __func__, "Failed to send WATCHDOG=1 notification message: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1603">1603</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN1604">1604</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1605">1605</td><td class="line">                s-&gt;send_watchdog = <span class='macro'>false<span class='expansion'>0</span></span>;</td></tr>
<tr><td class="num" id="LN1606">1606</td><td class="line">                <span class='macro'>log_debug(<span class='string_literal'>"Sent WATCHDOG=1 notification."</span>)<span class='expansion'>({ int _level = (7), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1606, __func__, "Sent WATCHDOG=1 notification.") : -abs(_e)<br>; })</span></span>;</td></tr>
<tr><td class="num" id="LN1607">1607</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1608">1608</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (s-&gt;stdout_streams_notify_queue)</td></tr>
<tr><td class="num" id="LN1609">1609</td><td class="line">                <span class='comment'>/* Dispatch one stream notification event */</span></td></tr>
<tr><td class="num" id="LN1610">1610</td><td class="line">                stdout_stream_send_notify(s-&gt;stdout_streams_notify_queue);</td></tr>
<tr><td class="num" id="LN1611">1611</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1612">1612</td><td class="line">        <span class='comment'>/* Leave us enabled if there's still more to to do. */</span></td></tr>
<tr><td class="num" id="LN1613">1613</td><td class="line">        <span class='keyword'>if</span> (s-&gt;send_watchdog || s-&gt;stdout_streams_notify_queue)</td></tr>
<tr><td class="num" id="LN1614">1614</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1615">1615</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1616">1616</td><td class="line">        <span class='comment'>/* There was nothing to do anymore, let's turn ourselves off. */</span></td></tr>
<tr><td class="num" id="LN1617">1617</td><td class="line">        r = sd_event_source_set_enabled(es, SD_EVENT_OFF);</td></tr>
<tr><td class="num" id="LN1618">1618</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1619">1619</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to turn off notify event source: %m"</span>)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1619, __func__, "Failed to turn off notify event source: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1620">1620</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1621">1621</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1622">1622</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1623">1623</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1624">1624</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> dispatch_watchdog(sd_event_source *es, uint64_t usec, <span class='keyword'>void</span> *userdata) {</td></tr>
<tr><td class="num" id="LN1625">1625</td><td class="line">        Server *s = userdata;</td></tr>
<tr><td class="num" id="LN1626">1626</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN1627">1627</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1628">1628</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1628, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1629">1629</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1630">1630</td><td class="line">        s-&gt;send_watchdog = <span class='macro'>true<span class='expansion'>1</span></span>;</td></tr>
<tr><td class="num" id="LN1631">1631</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1632">1632</td><td class="line">        r = sd_event_source_set_enabled(s-&gt;notify_event_source, SD_EVENT_ON);</td></tr>
<tr><td class="num" id="LN1633">1633</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1634">1634</td><td class="line">                <span class='macro'>log_warning_errno(r, <span class='string_literal'>"Failed to turn on notify event source: %m"</span>)<span class='expansion'>({ int _level = (4), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1634, __func__, "Failed to turn on notify event source: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1635">1635</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1636">1636</td><td class="line">        r = sd_event_source_set_time(s-&gt;watchdog_event_source, usec + s-&gt;watchdog_usec / 2);</td></tr>
<tr><td class="num" id="LN1637">1637</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1638">1638</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to restart watchdog event source: %m"</span>)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1638, __func__, "Failed to restart watchdog event source: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1639">1639</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1640">1640</td><td class="line">        r = sd_event_source_set_enabled(s-&gt;watchdog_event_source, SD_EVENT_ON);</td></tr>
<tr><td class="num" id="LN1641">1641</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1642">1642</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to enable watchdog event source: %m"</span>)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1642, __func__, "Failed to enable watchdog event source: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1643">1643</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1644">1644</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1645">1645</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1646">1646</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1647">1647</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> server_connect_notify(Server *s) {</td></tr>
<tr><td class="num" id="LN1648">1648</td><td class="line">        <span class='keyword'>union</span> sockaddr_union sa = {</td></tr>
<tr><td class="num" id="LN1649">1649</td><td class="line">                .un.sun_family = <span class='macro'>AF_UNIX<span class='expansion'>1</span></span>,</td></tr>
<tr><td class="num" id="LN1650">1650</td><td class="line">        };</td></tr>
<tr><td class="num" id="LN1651">1651</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span> *e;</td></tr>
<tr><td class="num" id="LN1652">1652</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr><td class="num" id="LN1653">1653</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1654">1654</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1654, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1655">1655</td><td class="line">        <span class='macro'>assert(s-&gt;notify_fd &lt; 0)<span class='expansion'>do { if ((__builtin_expect(!!(!(s-&gt;notify_fd &lt; 0)),0)))<br> log_assert_failed("s-&gt;notify_fd &lt; 0", "src/journal/journald-server.c"<br>, 1655, __PRETTY_FUNCTION__); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1656">1656</td><td class="line">        <span class='macro'>assert(!s-&gt;notify_event_source)<span class='expansion'>do { if ((__builtin_expect(!!(!(!s-&gt;notify_event_source)),<br>0))) log_assert_failed("!s-&gt;notify_event_source", "src/journal/journald-server.c"<br>, 1656, __PRETTY_FUNCTION__); } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1657">1657</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1658">1658</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr><td class="num" id="LN1659">1659</td><td class="line">          <span class='comment'>So here's the problem: we'd like to send notification</span></td></tr>
<tr><td class="num" id="LN1660">1660</td><td class="line">          <span class='comment'>messages to PID 1, but we cannot do that via sd_notify(),</span></td></tr>
<tr><td class="num" id="LN1661">1661</td><td class="line">          <span class='comment'>since that's synchronous, and we might end up blocking on</span></td></tr>
<tr><td class="num" id="LN1662">1662</td><td class="line">          <span class='comment'>it. Specifically: given that PID 1 might block on</span></td></tr>
<tr><td class="num" id="LN1663">1663</td><td class="line">          <span class='comment'>dbus-daemon during IPC, and dbus-daemon is logging to us,</span></td></tr>
<tr><td class="num" id="LN1664">1664</td><td class="line">          <span class='comment'>and might hence block on us, we might end up in a deadlock</span></td></tr>
<tr><td class="num" id="LN1665">1665</td><td class="line">          <span class='comment'>if we block on sending PID 1 notification messages -- by</span></td></tr>
<tr><td class="num" id="LN1666">1666</td><td class="line">          <span class='comment'>generating a full blocking circle. To avoid this, let's</span></td></tr>
<tr><td class="num" id="LN1667">1667</td><td class="line">          <span class='comment'>create a non-blocking socket, and connect it to the</span></td></tr>
<tr><td class="num" id="LN1668">1668</td><td class="line">          <span class='comment'>notification socket, and then wait for POLLOUT before we</span></td></tr>
<tr><td class="num" id="LN1669">1669</td><td class="line">          <span class='comment'>send anything. This should efficiently avoid any deadlocks,</span></td></tr>
<tr><td class="num" id="LN1670">1670</td><td class="line">          <span class='comment'>as we'll never block on PID 1, hence PID 1 can safely block</span></td></tr>
<tr><td class="num" id="LN1671">1671</td><td class="line">          <span class='comment'>on dbus-daemon which can safely block on us again.</span></td></tr>
<tr><td class="num" id="LN1672">1672</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1673">1673</td><td class="line">          <span class='comment'>Don't think that this issue is real? It is, see:</span></td></tr>
<tr><td class="num" id="LN1674">1674</td><td class="line">          <span class='comment'>https://github.com/systemd/systemd/issues/1505</span></td></tr>
<tr><td class="num" id="LN1675">1675</td><td class="line">        <span class='comment'>*/</span></td></tr>
<tr><td class="num" id="LN1676">1676</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1677">1677</td><td class="line">        e = getenv(<span class='string_literal'>"NOTIFY_SOCKET"</span>);</td></tr>
<tr><td class="num" id="LN1678">1678</td><td class="line">        <span class='keyword'>if</span> (!e)</td></tr>
<tr><td class="num" id="LN1679">1679</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1680">1680</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1681">1681</td><td class="line">        <span class='keyword'>if</span> ((e[0] != '@' &amp;&amp; e[0] != '/') || e[1] == 0) {</td></tr>
<tr><td class="num" id="LN1682">1682</td><td class="line">                <span class='macro'>log_error(<span class='string_literal'>"NOTIFY_SOCKET set to an invalid value: %s"</span>, e)<span class='expansion'>({ int _level = (3), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1682, __func__, "NOTIFY_SOCKET set to an invalid value: %s"<br>, e) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1683">1683</td><td class="line">                <span class='keyword'>return</span> -<span class='macro'>EINVAL<span class='expansion'>22</span></span>;</td></tr>
<tr><td class="num" id="LN1684">1684</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1685">1685</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1686">1686</td><td class="line">        <span class='keyword'>if</span> (strlen(e) &gt; <span class='keyword'>sizeof</span>(sa.un.sun_path)) {</td></tr>
<tr><td class="num" id="LN1687">1687</td><td class="line">                <span class='macro'>log_error(<span class='string_literal'>"NOTIFY_SOCKET path too long: %s"</span>, e)<span class='expansion'>({ int _level = (3), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1687, __func__, "NOTIFY_SOCKET path too long: %s", e) : -abs<br>(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1688">1688</td><td class="line">                <span class='keyword'>return</span> -<span class='macro'>EINVAL<span class='expansion'>22</span></span>;</td></tr>
<tr><td class="num" id="LN1689">1689</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1690">1690</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1691">1691</td><td class="line">        s-&gt;notify_fd = socket(<span class='macro'>AF_UNIX<span class='expansion'>1</span></span>, <span class='macro'>SOCK_DGRAM<span class='expansion'>SOCK_DGRAM</span></span>|<span class='macro'>SOCK_CLOEXEC<span class='expansion'>SOCK_CLOEXEC</span></span>|<span class='macro'>SOCK_NONBLOCK<span class='expansion'>SOCK_NONBLOCK</span></span>, 0);</td></tr>
<tr><td class="num" id="LN1692">1692</td><td class="line">        <span class='keyword'>if</span> (s-&gt;notify_fd &lt; 0)</td></tr>
<tr><td class="num" id="LN1693">1693</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_error_errno(errno, <span class='string_literal'>"Failed to create notify socket: %m"</span>)<span class='expansion'>({ int _level = (3), _e = ((*__errno_location ())); (log_get_max_level<br>() &gt;= ((_level) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1693, __func__, "Failed to create notify socket: %m") : -abs<br>(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1694">1694</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1695">1695</td><td class="line">        (<span class='keyword'>void</span>) fd_inc_sndbuf(s-&gt;notify_fd, <span class='macro'>NOTIFY_SNDBUF_SIZE<span class='expansion'>(8*1024*1024)</span></span>);</td></tr>
<tr><td class="num" id="LN1696">1696</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1697">1697</td><td class="line">        strncpy(sa.un.sun_path, e, <span class='keyword'>sizeof</span>(sa.un.sun_path));</td></tr>
<tr><td class="num" id="LN1698">1698</td><td class="line">        <span class='keyword'>if</span> (sa.un.sun_path[0] == '@')</td></tr>
<tr><td class="num" id="LN1699">1699</td><td class="line">                sa.un.sun_path[0] = 0;</td></tr>
<tr><td class="num" id="LN1700">1700</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1701">1701</td><td class="line">        r = connect(s-&gt;notify_fd, &amp;sa.sa, <span class='macro'>offsetof(<span class='keyword'>struct</span> sockaddr_un, sun_path)<span class='expansion'>__builtin_offsetof(struct sockaddr_un, sun_path)</span></span> + strlen(e));</td></tr>
<tr><td class="num" id="LN1702">1702</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1703">1703</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_error_errno(errno, <span class='string_literal'>"Failed to connect to notify socket: %m"</span>)<span class='expansion'>({ int _level = (3), _e = ((*__errno_location ())); (log_get_max_level<br>() &gt;= ((_level) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1703, __func__, "Failed to connect to notify socket: %m") :<br> -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1704">1704</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1705">1705</td><td class="line">        r = sd_event_add_io(s-&gt;event, &amp;s-&gt;notify_event_source, s-&gt;notify_fd, <span class='macro'>EPOLLOUT<span class='expansion'>EPOLLOUT</span></span>, dispatch_notify_event, s);</td></tr>
<tr><td class="num" id="LN1706">1706</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1707">1707</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to watch notification socket: %m"</span>)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1707, __func__, "Failed to watch notification socket: %m") :<br> -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1708">1708</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1709">1709</td><td class="line">        <span class='keyword'>if</span> (sd_watchdog_enabled(<span class='macro'>false<span class='expansion'>0</span></span>, &amp;s-&gt;watchdog_usec) &gt; 0) {</td></tr>
<tr><td class="num" id="LN1710">1710</td><td class="line">                s-&gt;send_watchdog = <span class='macro'>true<span class='expansion'>1</span></span>;</td></tr>
<tr><td class="num" id="LN1711">1711</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1712">1712</td><td class="line">                r = sd_event_add_time(s-&gt;event, &amp;s-&gt;watchdog_event_source, <span class='macro'>CLOCK_MONOTONIC<span class='expansion'>1</span></span>, now(<span class='macro'>CLOCK_MONOTONIC<span class='expansion'>1</span></span>) + s-&gt;watchdog_usec/2, s-&gt;watchdog_usec/4, dispatch_watchdog, s);</td></tr>
<tr><td class="num" id="LN1713">1713</td><td class="line">                <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1714">1714</td><td class="line">                        <span class='keyword'>return</span> <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to add watchdog time event: %m"</span>)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1714, __func__, "Failed to add watchdog time event: %m") : -<br>abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1715">1715</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1716">1716</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1717">1717</td><td class="line">        <span class='comment'>/* This should fire pretty soon, which we'll use to send the</span></td></tr>
<tr><td class="num" id="LN1718">1718</td><td class="line">         <span class='comment'>* READY=1 event. */</span></td></tr>
<tr><td class="num" id="LN1719">1719</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1720">1720</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr><td class="num" id="LN1721">1721</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1722">1722</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1723">1723</td><td class="line"><span class='keyword'>int</span> server_init(Server *s) {</td></tr>
<tr><td class="num" id="LN1724">1724</td><td class="line">        <span class='macro'>_cleanup_fdset_free_<span class='expansion'>__attribute__((cleanup(fdset_freep)))</span></span> FDSet *fds = <span class='macro'>NULL<span class='expansion'>((void*)0)</span></span>;</td></tr>
<tr><td class="num" id="LN1725">1725</td><td class="line">        <span class='keyword'>int</span> n, r, fd;</td></tr>
<tr><td class="num" id="LN1726">1726</td><td class="line">        <span class='macro'>bool<span class='expansion'>_Bool</span></span> no_sockets;</td></tr>
<tr><td class="num" id="LN1727">1727</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1728">1728</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1728, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1729">1729</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1730">1730</td><td class="line">        <span class='macro'>zero(*s)<span class='expansion'>((memset((&amp;(*s)), 0, (sizeof(*s)))))</span></span>;</td></tr>
<tr><td class="num" id="LN1731">1731</td><td class="line">        s-&gt;syslog_fd = s-&gt;native_fd = s-&gt;stdout_fd = s-&gt;dev_kmsg_fd = s-&gt;audit_fd = s-&gt;hostname_fd = s-&gt;notify_fd = -1;</td></tr>
<tr><td class="num" id="LN1732">1732</td><td class="line">        s-&gt;compress = <span class='macro'>true<span class='expansion'>1</span></span>;</td></tr>
<tr><td class="num" id="LN1733">1733</td><td class="line">        s-&gt;seal = <span class='macro'>true<span class='expansion'>1</span></span>;</td></tr>
<tr><td class="num" id="LN1734">1734</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1735">1735</td><td class="line">        s-&gt;watchdog_usec = <span class='macro'>USEC_INFINITY<span class='expansion'>((usec_t) -1)</span></span>;</td></tr>
<tr><td class="num" id="LN1736">1736</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1737">1737</td><td class="line">        s-&gt;sync_interval_usec = <span class='macro'>DEFAULT_SYNC_INTERVAL_USEC<span class='expansion'>(5*((usec_t) (60ULL*((usec_t) 1000000ULL))))</span></span>;</td></tr>
<tr><td class="num" id="LN1738">1738</td><td class="line">        s-&gt;sync_scheduled = <span class='macro'>false<span class='expansion'>0</span></span>;</td></tr>
<tr><td class="num" id="LN1739">1739</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1740">1740</td><td class="line">        s-&gt;rate_limit_interval = <span class='macro'>DEFAULT_RATE_LIMIT_INTERVAL<span class='expansion'>(30*((usec_t) 1000000ULL))</span></span>;</td></tr>
<tr><td class="num" id="LN1741">1741</td><td class="line">        s-&gt;rate_limit_burst = <span class='macro'>DEFAULT_RATE_LIMIT_BURST<span class='expansion'>1000</span></span>;</td></tr>
<tr><td class="num" id="LN1742">1742</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1743">1743</td><td class="line">        s-&gt;forward_to_wall = <span class='macro'>true<span class='expansion'>1</span></span>;</td></tr>
<tr><td class="num" id="LN1744">1744</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1745">1745</td><td class="line">        s-&gt;max_file_usec = <span class='macro'>DEFAULT_MAX_FILE_USEC<span class='expansion'>((usec_t) (2629800ULL*((usec_t) 1000000ULL)))</span></span>;</td></tr>
<tr><td class="num" id="LN1746">1746</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1747">1747</td><td class="line">        s-&gt;max_level_store = <span class='macro'>LOG_DEBUG<span class='expansion'>7</span></span>;</td></tr>
<tr><td class="num" id="LN1748">1748</td><td class="line">        s-&gt;max_level_syslog = <span class='macro'>LOG_DEBUG<span class='expansion'>7</span></span>;</td></tr>
<tr><td class="num" id="LN1749">1749</td><td class="line">        s-&gt;max_level_kmsg = <span class='macro'>LOG_NOTICE<span class='expansion'>5</span></span>;</td></tr>
<tr><td class="num" id="LN1750">1750</td><td class="line">        s-&gt;max_level_console = <span class='macro'>LOG_INFO<span class='expansion'>6</span></span>;</td></tr>
<tr><td class="num" id="LN1751">1751</td><td class="line">        s-&gt;max_level_wall = <span class='macro'>LOG_EMERG<span class='expansion'>0</span></span>;</td></tr>
<tr><td class="num" id="LN1752">1752</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1753">1753</td><td class="line">        journal_reset_metrics(&amp;s-&gt;system_metrics);</td></tr>
<tr><td class="num" id="LN1754">1754</td><td class="line">        journal_reset_metrics(&amp;s-&gt;runtime_metrics);</td></tr>
<tr><td class="num" id="LN1755">1755</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1756">1756</td><td class="line">        server_parse_config_file(s);</td></tr>
<tr><td class="num" id="LN1757">1757</td><td class="line">        server_parse_proc_cmdline(s);</td></tr>
<tr><td class="num" id="LN1758">1758</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1759">1759</td><td class="line">        <span class='keyword'>if</span> (!!s-&gt;rate_limit_interval ^ !!s-&gt;rate_limit_burst) {</td></tr>
<tr><td class="num" id="LN1760">1760</td><td class="line">                <span class='macro'>log_debug(<span class='string_literal'>"Setting both rate limit interval and burst from "</span>USEC_FMT<span class='string_literal'>",%u to 0,0"</span>,<span class='expansion'>({ int _level = (7), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1761, __func__, "Setting both rate limit interval and burst from "<br>"%" "l" "u"",%u to 0,0", s-&gt;rate_limit_interval, s-&gt;rate_limit_burst<br>) : -abs(_e); })</span></span></td></tr>
<tr><td class="num" id="LN1761">1761</td><td class="line">                          <span class='macro'>s-&gt;rate_limit_interval, s-&gt;rate_limit_burst)<span class='expansion'>({ int _level = (7), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1761, __func__, "Setting both rate limit interval and burst from "<br>"%" "l" "u"",%u to 0,0", s-&gt;rate_limit_interval, s-&gt;rate_limit_burst<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1762">1762</td><td class="line">                s-&gt;rate_limit_interval = s-&gt;rate_limit_burst = 0;</td></tr>
<tr><td class="num" id="LN1763">1763</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1764">1764</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1765">1765</td><td class="line">        (<span class='keyword'>void</span>) mkdir_p(<span class='string_literal'>"/run/systemd/journal"</span>, 0755);</td></tr>
<tr><td class="num" id="LN1766">1766</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1767">1767</td><td class="line">        s-&gt;user_journals = <span class='macro'>ordered_hashmap_new(NULL)<span class='expansion'>internal_ordered_hashmap_new(((void*)0) )</span></span>;</td></tr>
<tr><td class="num" id="LN1768">1768</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;user_journals)</td></tr>
<tr><td class="num" id="LN1769">1769</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_oom()<span class='expansion'>log_oom_internal("src/journal/journald-server.c", 1769, __func__<br>)</span></span>;</td></tr>
<tr><td class="num" id="LN1770">1770</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1771">1771</td><td class="line">        s-&gt;mmap = mmap_cache_new();</td></tr>
<tr><td class="num" id="LN1772">1772</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;mmap)</td></tr>
<tr><td class="num" id="LN1773">1773</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_oom()<span class='expansion'>log_oom_internal("src/journal/journald-server.c", 1773, __func__<br>)</span></span>;</td></tr>
<tr><td class="num" id="LN1774">1774</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1775">1775</td><td class="line">        s-&gt;deferred_closes = <span class='macro'>set_new(NULL)<span class='expansion'>internal_set_new(((void*)0) )</span></span>;</td></tr>
<tr><td class="num" id="LN1776">1776</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;deferred_closes)</td></tr>
<tr><td class="num" id="LN1777">1777</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_oom()<span class='expansion'>log_oom_internal("src/journal/journald-server.c", 1777, __func__<br>)</span></span>;</td></tr>
<tr><td class="num" id="LN1778">1778</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1779">1779</td><td class="line">        r = sd_event_default(&amp;s-&gt;event);</td></tr>
<tr><td class="num" id="LN1780">1780</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1781">1781</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_error_errno(r, <span class='string_literal'>"Failed to create event loop: %m"</span>)<span class='expansion'>({ int _level = (3), _e = (r); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1781, __func__, "Failed to create event loop: %m") : -abs(_e<br>); })</span></span>;</td></tr>
<tr><td class="num" id="LN1782">1782</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1783">1783</td><td class="line">        n = sd_listen_fds(<span class='macro'>true<span class='expansion'>1</span></span>);</td></tr>
<tr><td class="num" id="LN1784">1784</td><td class="line">        <span class='keyword'>if</span> (n &lt; 0)</td></tr>
<tr><td class="num" id="LN1785">1785</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>log_error_errno(n, <span class='string_literal'>"Failed to read listening file descriptors from environment: %m"</span>)<span class='expansion'>({ int _level = (3), _e = (n); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1785, __func__, "Failed to read listening file descriptors from environment: %m"<br>) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1786">1786</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1787">1787</td><td class="line">        <span class='keyword'>for</span> (fd = <span class='macro'>SD_LISTEN_FDS_START<span class='expansion'>3</span></span>; fd &lt; <span class='macro'>SD_LISTEN_FDS_START<span class='expansion'>3</span></span> + n; fd++) {</td></tr>
<tr><td class="num" id="LN1788">1788</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1789">1789</td><td class="line">                <span class='keyword'>if</span> (sd_is_socket_unix(fd, <span class='macro'>SOCK_DGRAM<span class='expansion'>SOCK_DGRAM</span></span>, -1, <span class='string_literal'>"/run/systemd/journal/socket"</span>, 0) &gt; 0) {</td></tr>
<tr><td class="num" id="LN1790">1790</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1791">1791</td><td class="line">                        <span class='keyword'>if</span> (s-&gt;native_fd &gt;= 0) {</td></tr>
<tr><td class="num" id="LN1792">1792</td><td class="line">                                <span class='macro'>log_error(<span class='string_literal'>"Too many native sockets passed."</span>)<span class='expansion'>({ int _level = (3), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1792, __func__, "Too many native sockets passed.") : -abs(_e<br>); })</span></span>;</td></tr>
<tr><td class="num" id="LN1793">1793</td><td class="line">                                <span class='keyword'>return</span> -<span class='macro'>EINVAL<span class='expansion'>22</span></span>;</td></tr>
<tr><td class="num" id="LN1794">1794</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN1795">1795</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1796">1796</td><td class="line">                        s-&gt;native_fd = fd;</td></tr>
<tr><td class="num" id="LN1797">1797</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1798">1798</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (sd_is_socket_unix(fd, <span class='macro'>SOCK_STREAM<span class='expansion'>SOCK_STREAM</span></span>, 1, <span class='string_literal'>"/run/systemd/journal/stdout"</span>, 0) &gt; 0) {</td></tr>
<tr><td class="num" id="LN1799">1799</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1800">1800</td><td class="line">                        <span class='keyword'>if</span> (s-&gt;stdout_fd &gt;= 0) {</td></tr>
<tr><td class="num" id="LN1801">1801</td><td class="line">                                <span class='macro'>log_error(<span class='string_literal'>"Too many stdout sockets passed."</span>)<span class='expansion'>({ int _level = (3), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1801, __func__, "Too many stdout sockets passed.") : -abs(_e<br>); })</span></span>;</td></tr>
<tr><td class="num" id="LN1802">1802</td><td class="line">                                <span class='keyword'>return</span> -<span class='macro'>EINVAL<span class='expansion'>22</span></span>;</td></tr>
<tr><td class="num" id="LN1803">1803</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN1804">1804</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1805">1805</td><td class="line">                        s-&gt;stdout_fd = fd;</td></tr>
<tr><td class="num" id="LN1806">1806</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1807">1807</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (sd_is_socket_unix(fd, <span class='macro'>SOCK_DGRAM<span class='expansion'>SOCK_DGRAM</span></span>, -1, <span class='string_literal'>"/dev/log"</span>, 0) &gt; 0 ||</td></tr>
<tr><td class="num" id="LN1808">1808</td><td class="line">                           sd_is_socket_unix(fd, <span class='macro'>SOCK_DGRAM<span class='expansion'>SOCK_DGRAM</span></span>, -1, <span class='string_literal'>"/run/systemd/journal/dev-log"</span>, 0) &gt; 0) {</td></tr>
<tr><td class="num" id="LN1809">1809</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1810">1810</td><td class="line">                        <span class='keyword'>if</span> (s-&gt;syslog_fd &gt;= 0) {</td></tr>
<tr><td class="num" id="LN1811">1811</td><td class="line">                                <span class='macro'>log_error(<span class='string_literal'>"Too many /dev/log sockets passed."</span>)<span class='expansion'>({ int _level = (3), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1811, __func__, "Too many /dev/log sockets passed.") : -abs<br>(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1812">1812</td><td class="line">                                <span class='keyword'>return</span> -<span class='macro'>EINVAL<span class='expansion'>22</span></span>;</td></tr>
<tr><td class="num" id="LN1813">1813</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN1814">1814</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1815">1815</td><td class="line">                        s-&gt;syslog_fd = fd;</td></tr>
<tr><td class="num" id="LN1816">1816</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1817">1817</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (sd_is_socket(fd, <span class='macro'>AF_NETLINK<span class='expansion'>16</span></span>, <span class='macro'>SOCK_RAW<span class='expansion'>SOCK_RAW</span></span>, -1) &gt; 0) {</td></tr>
<tr><td class="num" id="LN1818">1818</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1819">1819</td><td class="line">                        <span class='keyword'>if</span> (s-&gt;audit_fd &gt;= 0) {</td></tr>
<tr><td class="num" id="LN1820">1820</td><td class="line">                                <span class='macro'>log_error(<span class='string_literal'>"Too many audit sockets passed."</span>)<span class='expansion'>({ int _level = (3), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1820, __func__, "Too many audit sockets passed.") : -abs(_e<br>); })</span></span>;</td></tr>
<tr><td class="num" id="LN1821">1821</td><td class="line">                                <span class='keyword'>return</span> -<span class='macro'>EINVAL<span class='expansion'>22</span></span>;</td></tr>
<tr><td class="num" id="LN1822">1822</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN1823">1823</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1824">1824</td><td class="line">                        s-&gt;audit_fd = fd;</td></tr>
<tr><td class="num" id="LN1825">1825</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1826">1826</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr><td class="num" id="LN1827">1827</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1828">1828</td><td class="line">                        <span class='keyword'>if</span> (!fds) {</td></tr>
<tr><td class="num" id="LN1829">1829</td><td class="line">                                fds = fdset_new();</td></tr>
<tr><td class="num" id="LN1830">1830</td><td class="line">                                <span class='keyword'>if</span> (!fds)</td></tr>
<tr><td class="num" id="LN1831">1831</td><td class="line">                                        <span class='keyword'>return</span> <span class='macro'>log_oom()<span class='expansion'>log_oom_internal("src/journal/journald-server.c", 1831, __func__<br>)</span></span>;</td></tr>
<tr><td class="num" id="LN1832">1832</td><td class="line">                        }</td></tr>
<tr><td class="num" id="LN1833">1833</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1834">1834</td><td class="line">                        r = fdset_put(fds, fd);</td></tr>
<tr><td class="num" id="LN1835">1835</td><td class="line">                        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1836">1836</td><td class="line">                                <span class='keyword'>return</span> <span class='macro'>log_oom()<span class='expansion'>log_oom_internal("src/journal/journald-server.c", 1836, __func__<br>)</span></span>;</td></tr>
<tr><td class="num" id="LN1837">1837</td><td class="line">                }</td></tr>
<tr><td class="num" id="LN1838">1838</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1839">1839</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1840">1840</td><td class="line">        <span class='comment'>/* Try to restore streams, but don't bother if this fails */</span></td></tr>
<tr><td class="num" id="LN1841">1841</td><td class="line">        (<span class='keyword'>void</span>) server_restore_streams(s, fds);</td></tr>
<tr><td class="num" id="LN1842">1842</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1843">1843</td><td class="line">        <span class='keyword'>if</span> (fdset_size(fds) &gt; 0) {</td></tr>
<tr><td class="num" id="LN1844">1844</td><td class="line">                <span class='macro'>log_warning(<span class='string_literal'>"%u unknown file descriptors passed, closing."</span>, fdset_size(fds))<span class='expansion'>({ int _level = (4), _e = (0); (log_get_max_level() &gt;= ((_level<br>) &amp; 0x07)) ? log_internal(_level, _e, "src/journal/journald-server.c"<br>, 1844, __func__, "%u unknown file descriptors passed, closing."<br>, fdset_size(fds)) : -abs(_e); })</span></span>;</td></tr>
<tr><td class="num" id="LN1845">1845</td><td class="line">                fds = <span class="mrange">fdset_free(fds)</span>;</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:17ex">Value stored to 'fds' is never read</div></td></tr>
<tr><td class="num" id="LN1846">1846</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1847">1847</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1848">1848</td><td class="line">        no_sockets = s-&gt;native_fd &lt; 0 &amp;&amp; s-&gt;stdout_fd &lt; 0 &amp;&amp; s-&gt;syslog_fd &lt; 0 &amp;&amp; s-&gt;audit_fd &lt; 0;</td></tr>
<tr><td class="num" id="LN1849">1849</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1850">1850</td><td class="line">        <span class='comment'>/* always open stdout, syslog, native, and kmsg sockets */</span></td></tr>
<tr><td class="num" id="LN1851">1851</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1852">1852</td><td class="line">        <span class='comment'>/* systemd-journald.socket: /run/systemd/journal/stdout */</span></td></tr>
<tr><td class="num" id="LN1853">1853</td><td class="line">        r = server_open_stdout_socket(s);</td></tr>
<tr><td class="num" id="LN1854">1854</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1855">1855</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1856">1856</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1857">1857</td><td class="line">        <span class='comment'>/* systemd-journald-dev-log.socket: /run/systemd/journal/dev-log */</span></td></tr>
<tr><td class="num" id="LN1858">1858</td><td class="line">        r = server_open_syslog_socket(s);</td></tr>
<tr><td class="num" id="LN1859">1859</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1860">1860</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1861">1861</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1862">1862</td><td class="line">        <span class='comment'>/* systemd-journald.socket: /run/systemd/journal/socket */</span></td></tr>
<tr><td class="num" id="LN1863">1863</td><td class="line">        r = server_open_native_socket(s);</td></tr>
<tr><td class="num" id="LN1864">1864</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1865">1865</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1866">1866</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1867">1867</td><td class="line">        <span class='comment'>/* /dev/ksmg */</span></td></tr>
<tr><td class="num" id="LN1868">1868</td><td class="line">        r = server_open_dev_kmsg(s);</td></tr>
<tr><td class="num" id="LN1869">1869</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1870">1870</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1871">1871</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1872">1872</td><td class="line">        <span class='comment'>/* Unless we got *some* sockets and not audit, open audit socket */</span></td></tr>
<tr><td class="num" id="LN1873">1873</td><td class="line">        <span class='keyword'>if</span> (s-&gt;audit_fd &gt;= 0 || no_sockets) {</td></tr>
<tr><td class="num" id="LN1874">1874</td><td class="line">                r = server_open_audit(s);</td></tr>
<tr><td class="num" id="LN1875">1875</td><td class="line">                <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1876">1876</td><td class="line">                        <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1877">1877</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1878">1878</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1879">1879</td><td class="line">        r = server_open_kernel_seqnum(s);</td></tr>
<tr><td class="num" id="LN1880">1880</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1881">1881</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1882">1882</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1883">1883</td><td class="line">        r = server_open_hostname(s);</td></tr>
<tr><td class="num" id="LN1884">1884</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1885">1885</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1886">1886</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1887">1887</td><td class="line">        r = setup_signals(s);</td></tr>
<tr><td class="num" id="LN1888">1888</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1889">1889</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1890">1890</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1891">1891</td><td class="line">        s-&gt;udev = udev_new();</td></tr>
<tr><td class="num" id="LN1892">1892</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;udev)</td></tr>
<tr><td class="num" id="LN1893">1893</td><td class="line">                <span class='keyword'>return</span> -<span class='macro'>ENOMEM<span class='expansion'>12</span></span>;</td></tr>
<tr><td class="num" id="LN1894">1894</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1895">1895</td><td class="line">        s-&gt;rate_limit = journal_rate_limit_new(s-&gt;rate_limit_interval, s-&gt;rate_limit_burst);</td></tr>
<tr><td class="num" id="LN1896">1896</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;rate_limit)</td></tr>
<tr><td class="num" id="LN1897">1897</td><td class="line">                <span class='keyword'>return</span> -<span class='macro'>ENOMEM<span class='expansion'>12</span></span>;</td></tr>
<tr><td class="num" id="LN1898">1898</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1899">1899</td><td class="line">        r = cg_get_root_path(&amp;s-&gt;cgroup_root);</td></tr>
<tr><td class="num" id="LN1900">1900</td><td class="line">        <span class='keyword'>if</span> (r &lt; 0)</td></tr>
<tr><td class="num" id="LN1901">1901</td><td class="line">                <span class='keyword'>return</span> r;</td></tr>
<tr><td class="num" id="LN1902">1902</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1903">1903</td><td class="line">        server_cache_hostname(s);</td></tr>
<tr><td class="num" id="LN1904">1904</td><td class="line">        server_cache_boot_id(s);</td></tr>
<tr><td class="num" id="LN1905">1905</td><td class="line">        server_cache_machine_id(s);</td></tr>
<tr><td class="num" id="LN1906">1906</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1907">1907</td><td class="line">        (<span class='keyword'>void</span>) server_connect_notify(s);</td></tr>
<tr><td class="num" id="LN1908">1908</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1909">1909</td><td class="line">        <span class='keyword'>return</span> system_journal_open(s, <span class='macro'>false<span class='expansion'>0</span></span>);</td></tr>
<tr><td class="num" id="LN1910">1910</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1911">1911</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1912">1912</td><td class="line"><span class='keyword'>void</span> server_maybe_append_tags(Server *s) {</td></tr>
<tr><td class="num" id="LN1913">1913</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_GCRYPT<span class='expansion'>1</span></span></span></td></tr>
<tr><td class="num" id="LN1914">1914</td><td class="line">        JournalFile *f;</td></tr>
<tr><td class="num" id="LN1915">1915</td><td class="line">        Iterator i;</td></tr>
<tr><td class="num" id="LN1916">1916</td><td class="line">        usec_t n;</td></tr>
<tr><td class="num" id="LN1917">1917</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1918">1918</td><td class="line">        n = now(<span class='macro'>CLOCK_REALTIME<span class='expansion'>0</span></span>);</td></tr>
<tr><td class="num" id="LN1919">1919</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1920">1920</td><td class="line">        <span class='keyword'>if</span> (s-&gt;system_journal)</td></tr>
<tr><td class="num" id="LN1921">1921</td><td class="line">                journal_file_maybe_append_tag(s-&gt;system_journal, n);</td></tr>
<tr><td class="num" id="LN1922">1922</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1923">1923</td><td class="line">        <span class='macro'>ORDERED_HASHMAP_FOREACH(f, s-&gt;user_journals, i)<span class='expansion'>for ((i) = ((Iterator) { .idx = ((2147483647 *2U +1U) - 1), .<br>next_key = ((void*)0) }); ordered_hashmap_iterate((s-&gt;user_journals<br>), &amp;(i), (void**)&amp;(f), ((void*)0)); )</span></span></td></tr>
<tr><td class="num" id="LN1924">1924</td><td class="line">                journal_file_maybe_append_tag(f, n);</td></tr>
<tr><td class="num" id="LN1925">1925</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr><td class="num" id="LN1926">1926</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1927">1927</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1928">1928</td><td class="line"><span class='keyword'>void</span> server_done(Server *s) {</td></tr>
<tr><td class="num" id="LN1929">1929</td><td class="line">        JournalFile *f;</td></tr>
<tr><td class="num" id="LN1930">1930</td><td class="line">        <span class='macro'>assert(s)<span class='expansion'>do { if ((__builtin_expect(!!(!(s)),0))) log_assert_failed("s"<br>, "src/journal/journald-server.c", 1930, __PRETTY_FUNCTION__)<br>; } while (0)</span></span>;</td></tr>
<tr><td class="num" id="LN1931">1931</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1932">1932</td><td class="line">        <span class='keyword'>if</span> (s-&gt;deferred_closes) {</td></tr>
<tr><td class="num" id="LN1933">1933</td><td class="line">                journal_file_close_set(s-&gt;deferred_closes);</td></tr>
<tr><td class="num" id="LN1934">1934</td><td class="line">                set_free(s-&gt;deferred_closes);</td></tr>
<tr><td class="num" id="LN1935">1935</td><td class="line">        }</td></tr>
<tr><td class="num" id="LN1936">1936</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1937">1937</td><td class="line">        <span class='keyword'>while</span> (s-&gt;stdout_streams)</td></tr>
<tr><td class="num" id="LN1938">1938</td><td class="line">                stdout_stream_free(s-&gt;stdout_streams);</td></tr>
<tr><td class="num" id="LN1939">1939</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1940">1940</td><td class="line">        <span class='keyword'>if</span> (s-&gt;system_journal)</td></tr>
<tr><td class="num" id="LN1941">1941</td><td class="line">                (<span class='keyword'>void</span>) journal_file_close(s-&gt;system_journal);</td></tr>
<tr><td class="num" id="LN1942">1942</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1943">1943</td><td class="line">        <span class='keyword'>if</span> (s-&gt;runtime_journal)</td></tr>
<tr><td class="num" id="LN1944">1944</td><td class="line">                (<span class='keyword'>void</span>) journal_file_close(s-&gt;runtime_journal);</td></tr>
<tr><td class="num" id="LN1945">1945</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1946">1946</td><td class="line">        <span class='keyword'>while</span> ((f = ordered_hashmap_steal_first(s-&gt;user_journals)))</td></tr>
<tr><td class="num" id="LN1947">1947</td><td class="line">                (<span class='keyword'>void</span>) journal_file_close(f);</td></tr>
<tr><td class="num" id="LN1948">1948</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1949">1949</td><td class="line">        ordered_hashmap_free(s-&gt;user_journals);</td></tr>
<tr><td class="num" id="LN1950">1950</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1951">1951</td><td class="line">        sd_event_source_unref(s-&gt;syslog_event_source);</td></tr>
<tr><td class="num" id="LN1952">1952</td><td class="line">        sd_event_source_unref(s-&gt;native_event_source);</td></tr>
<tr><td class="num" id="LN1953">1953</td><td class="line">        sd_event_source_unref(s-&gt;stdout_event_source);</td></tr>
<tr><td class="num" id="LN1954">1954</td><td class="line">        sd_event_source_unref(s-&gt;dev_kmsg_event_source);</td></tr>
<tr><td class="num" id="LN1955">1955</td><td class="line">        sd_event_source_unref(s-&gt;audit_event_source);</td></tr>
<tr><td class="num" id="LN1956">1956</td><td class="line">        sd_event_source_unref(s-&gt;sync_event_source);</td></tr>
<tr><td class="num" id="LN1957">1957</td><td class="line">        sd_event_source_unref(s-&gt;sigusr1_event_source);</td></tr>
<tr><td class="num" id="LN1958">1958</td><td class="line">        sd_event_source_unref(s-&gt;sigusr2_event_source);</td></tr>
<tr><td class="num" id="LN1959">1959</td><td class="line">        sd_event_source_unref(s-&gt;sigterm_event_source);</td></tr>
<tr><td class="num" id="LN1960">1960</td><td class="line">        sd_event_source_unref(s-&gt;sigint_event_source);</td></tr>
<tr><td class="num" id="LN1961">1961</td><td class="line">        sd_event_source_unref(s-&gt;sigrtmin1_event_source);</td></tr>
<tr><td class="num" id="LN1962">1962</td><td class="line">        sd_event_source_unref(s-&gt;hostname_event_source);</td></tr>
<tr><td class="num" id="LN1963">1963</td><td class="line">        sd_event_source_unref(s-&gt;notify_event_source);</td></tr>
<tr><td class="num" id="LN1964">1964</td><td class="line">        sd_event_source_unref(s-&gt;watchdog_event_source);</td></tr>
<tr><td class="num" id="LN1965">1965</td><td class="line">        sd_event_unref(s-&gt;event);</td></tr>
<tr><td class="num" id="LN1966">1966</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1967">1967</td><td class="line">        safe_close(s-&gt;syslog_fd);</td></tr>
<tr><td class="num" id="LN1968">1968</td><td class="line">        safe_close(s-&gt;native_fd);</td></tr>
<tr><td class="num" id="LN1969">1969</td><td class="line">        safe_close(s-&gt;stdout_fd);</td></tr>
<tr><td class="num" id="LN1970">1970</td><td class="line">        safe_close(s-&gt;dev_kmsg_fd);</td></tr>
<tr><td class="num" id="LN1971">1971</td><td class="line">        safe_close(s-&gt;audit_fd);</td></tr>
<tr><td class="num" id="LN1972">1972</td><td class="line">        safe_close(s-&gt;hostname_fd);</td></tr>
<tr><td class="num" id="LN1973">1973</td><td class="line">        safe_close(s-&gt;notify_fd);</td></tr>
<tr><td class="num" id="LN1974">1974</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1975">1975</td><td class="line">        <span class='keyword'>if</span> (s-&gt;rate_limit)</td></tr>
<tr><td class="num" id="LN1976">1976</td><td class="line">                journal_rate_limit_free(s-&gt;rate_limit);</td></tr>
<tr><td class="num" id="LN1977">1977</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1978">1978</td><td class="line">        <span class='keyword'>if</span> (s-&gt;kernel_seqnum)</td></tr>
<tr><td class="num" id="LN1979">1979</td><td class="line">                munmap(s-&gt;kernel_seqnum, <span class='keyword'>sizeof</span>(uint64_t));</td></tr>
<tr><td class="num" id="LN1980">1980</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1981">1981</td><td class="line">        free(s-&gt;buffer);</td></tr>
<tr><td class="num" id="LN1982">1982</td><td class="line">        free(s-&gt;tty_path);</td></tr>
<tr><td class="num" id="LN1983">1983</td><td class="line">        free(s-&gt;cgroup_root);</td></tr>
<tr><td class="num" id="LN1984">1984</td><td class="line">        free(s-&gt;hostname_field);</td></tr>
<tr><td class="num" id="LN1985">1985</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1986">1986</td><td class="line">        <span class='keyword'>if</span> (s-&gt;mmap)</td></tr>
<tr><td class="num" id="LN1987">1987</td><td class="line">                mmap_cache_unref(s-&gt;mmap);</td></tr>
<tr><td class="num" id="LN1988">1988</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1989">1989</td><td class="line">        udev_unref(s-&gt;udev);</td></tr>
<tr><td class="num" id="LN1990">1990</td><td class="line">}</td></tr>
<tr><td class="num" id="LN1991">1991</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1992">1992</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> storage_table[_STORAGE_MAX] = {</td></tr>
<tr><td class="num" id="LN1993">1993</td><td class="line">        [STORAGE_AUTO] = <span class='string_literal'>"auto"</span>,</td></tr>
<tr><td class="num" id="LN1994">1994</td><td class="line">        [STORAGE_VOLATILE] = <span class='string_literal'>"volatile"</span>,</td></tr>
<tr><td class="num" id="LN1995">1995</td><td class="line">        [STORAGE_PERSISTENT] = <span class='string_literal'>"persistent"</span>,</td></tr>
<tr><td class="num" id="LN1996">1996</td><td class="line">        [STORAGE_NONE] = <span class='string_literal'>"none"</span></td></tr>
<tr><td class="num" id="LN1997">1997</td><td class="line">};</td></tr>
<tr><td class="num" id="LN1998">1998</td><td class="line"> </td></tr>
<tr><td class="num" id="LN1999">1999</td><td class="line"><span class='macro'>DEFINE_STRING_TABLE_LOOKUP(storage, Storage)<span class='expansion'>const char *storage_to_string(Storage i) { if (i &lt; 0 || i &gt;=<br> (Storage) __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(storage_table), typeof(&amp;*(storage_table))), sizeof<br>(storage_table)/sizeof((storage_table)[0]), (void)0))) return<br> ((void*)0); return storage_table[i]; } Storage storage_from_string<br>(const char *s) { return (Storage) string_table_lookup(storage_table<br>, __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(storage_table), typeof(&amp;*(storage_table))), sizeof<br>(storage_table)/sizeof((storage_table)[0]), (void)0)), s); } struct<br> __useless_struct_to_allow_trailing_semicolon__</span></span>;</td></tr>
<tr><td class="num" id="LN2000">2000</td><td class="line"><span class='macro'>DEFINE_CONFIG_PARSE_ENUM(config_parse_storage, storage, Storage, <span class='string_literal'>"Failed to parse storage setting"</span>)<span class='expansion'>int config_parse_storage(const char *unit, const char *filename<br>, unsigned line, const char *section, unsigned section_line, const<br> char *lvalue, int ltype, const char *rvalue, void *data, void<br> *userdata) { Storage *i = data, x; do { if ((__builtin_expect<br>(!!(!(filename)),0))) log_assert_failed("filename", "src/journal/journald-server.c"<br>, 2000, __PRETTY_FUNCTION__); } while (0); do { if ((__builtin_expect<br>(!!(!(lvalue)),0))) log_assert_failed("lvalue", "src/journal/journald-server.c"<br>, 2000, __PRETTY_FUNCTION__); } while (0); do { if ((__builtin_expect<br>(!!(!(rvalue)),0))) log_assert_failed("rvalue", "src/journal/journald-server.c"<br>, 2000, __PRETTY_FUNCTION__); } while (0); do { if ((__builtin_expect<br>(!!(!(data)),0))) log_assert_failed("data", "src/journal/journald-server.c"<br>, 2000, __PRETTY_FUNCTION__); } while (0); if ((x = storage_from_string<br>(rvalue)) &lt; 0) { ({ int _level = (3), _e = (-x); (log_get_max_level<br>() &gt;= ((_level) &amp; 0x07)) ? log_syntax_internal(unit, _level<br>, filename, line, _e, "src/journal/journald-server.c", 2000, __func__<br>, "Failed to parse storage setting" ", ignoring: %s", rvalue)<br> : -abs(_e); }); return 0; } *i = x; return 0; }</span></span>;</td></tr>
<tr><td class="num" id="LN2001">2001</td><td class="line"> </td></tr>
<tr><td class="num" id="LN2002">2002</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> split_mode_table[_SPLIT_MAX] = {</td></tr>
<tr><td class="num" id="LN2003">2003</td><td class="line">        [SPLIT_LOGIN] = <span class='string_literal'>"login"</span>,</td></tr>
<tr><td class="num" id="LN2004">2004</td><td class="line">        [SPLIT_UID] = <span class='string_literal'>"uid"</span>,</td></tr>
<tr><td class="num" id="LN2005">2005</td><td class="line">        [SPLIT_NONE] = <span class='string_literal'>"none"</span>,</td></tr>
<tr><td class="num" id="LN2006">2006</td><td class="line">};</td></tr>
<tr><td class="num" id="LN2007">2007</td><td class="line"> </td></tr>
<tr><td class="num" id="LN2008">2008</td><td class="line"><span class='macro'>DEFINE_STRING_TABLE_LOOKUP(split_mode, SplitMode)<span class='expansion'>const char *split_mode_to_string(SplitMode i) { if (i &lt; 0 ||<br> i &gt;= (SplitMode) __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(split_mode_table), typeof(&amp;*(split_mode_table))),<br> sizeof(split_mode_table)/sizeof((split_mode_table)[0]), (void<br>)0))) return ((void*)0); return split_mode_table[i]; } SplitMode<br> split_mode_from_string(const char *s) { return (SplitMode) string_table_lookup<br>(split_mode_table, __extension__ (__builtin_choose_expr( !__builtin_types_compatible_p<br>(typeof(split_mode_table), typeof(&amp;*(split_mode_table))),<br> sizeof(split_mode_table)/sizeof((split_mode_table)[0]), (void<br>)0)), s); } struct __useless_struct_to_allow_trailing_semicolon__</span></span>;</td></tr>
<tr><td class="num" id="LN2009">2009</td><td class="line"><span class='macro'>DEFINE_CONFIG_PARSE_ENUM(config_parse_split_mode, split_mode, SplitMode, <span class='string_literal'>"Failed to parse split mode setting"</span>)<span class='expansion'>int config_parse_split_mode(const char *unit, const char *filename<br>, unsigned line, const char *section, unsigned section_line, const<br> char *lvalue, int ltype, const char *rvalue, void *data, void<br> *userdata) { SplitMode *i = data, x; do { if ((__builtin_expect<br>(!!(!(filename)),0))) log_assert_failed("filename", "src/journal/journald-server.c"<br>, 2009, __PRETTY_FUNCTION__); } while (0); do { if ((__builtin_expect<br>(!!(!(lvalue)),0))) log_assert_failed("lvalue", "src/journal/journald-server.c"<br>, 2009, __PRETTY_FUNCTION__); } while (0); do { if ((__builtin_expect<br>(!!(!(rvalue)),0))) log_assert_failed("rvalue", "src/journal/journald-server.c"<br>, 2009, __PRETTY_FUNCTION__); } while (0); do { if ((__builtin_expect<br>(!!(!(data)),0))) log_assert_failed("data", "src/journal/journald-server.c"<br>, 2009, __PRETTY_FUNCTION__); } while (0); if ((x = split_mode_from_string<br>(rvalue)) &lt; 0) { ({ int _level = (3), _e = (-x); (log_get_max_level<br>() &gt;= ((_level) &amp; 0x07)) ? log_syntax_internal(unit, _level<br>, filename, line, _e, "src/journal/journald-server.c", 2009, __func__<br>, "Failed to parse split mode setting" ", ignoring: %s", rvalue<br>) : -abs(_e); }); return 0; } *i = x; return 0; }</span></span>;</td></tr>
</table></body></html>
